qid,mysql_can_execute?,mysql_correct?,mysql_query
0,Y,Y,"SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING ) A LEFT JOIN (SELECT SPEND_DATE, USER_ID, IF (MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM (SELECT SPEND_DATE, USER_ID, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) TEMP ) B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
1,N,N,"SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING) A LEFT JOIN (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(*) = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY A.SPEND_DATE, A.PLATFORM"
2,Y,N,"SELECT D.SPEND_DATE, D.PLATFORM, (CASE WHEN SUM(ST.TOTAL_AMOUNT) IS NULL THEN 0 ELSE SUM(ST.TOTAL_AMOUNT) END) AS TOTAL_AMOUNT, (CASE WHEN COUNT(ST.USER_ID) IS NULL THEN 0 ELSE COUNT(ST.USER_ID) END) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE , 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE , 'both' AS PLATFORM FROM SPENDING ) D LEFT JOIN ( SELECT USER_ID, SPEND_DATE, (CASE WHEN COUNT(DISTINCT PLATFORM) = 1 THEN MIN(PLATFORM) ELSE BOTH END) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) ST ON D.SPEND_DATE = ST.SPEND_DATE AND D.PLATFORM = ST.PLATFORM GROUP BY D.SPEND_DATE, D.PLATFORM"
3,N,N,"SELECT D.SPEND_DATE, D.PLATFORM, IFNULL(SUM(M.AMOUNT), 0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT M.USER_ID),0) AS TOTAL_USERS FROM( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) D LEFT JOIN( SELECT SPEND_DATE, IFNULL(SUM(AMOUNT),0) AS AMOUNT, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM)=1 THEN PLATFORM ELSE BOTH END AS PLATFORM FROM SPENDING GROUP BY SPEND_DATE, USER_ID )M ON D.SPEND_DATE=M.SPEND_DATE AND D.PLATFORM=M.PLATFORM GROUP BY D.SPEND_DATE, D.PLATFORM"
4,Y,N,"SELECT M1.SPEND_DATE ,M1.PLATFORM ,SUM(CASE WHEN M2.USER_ID IS NOT NULL THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN M2.USER_ID IS NOT NULL THEN 1 ELSE 0 END) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) M1 LEFT JOIN ( SELECT SPEND_DATE ,USER_ID ,CASE WHEN DESKTOP_AMOUNT > 0 AND MOBILE_AMOUNT = 0 THEN DESKTOP WHEN DESKTOP_AMOUNT = 0 AND MOBILE_AMOUNT > 0 THEN MOBILE WHEN DESKTOP_AMOUNT > 0 AND MOBILE_AMOUNT > 0 THEN BOTH ELSE NULL END AS PLATFORM ,DESKTOP_AMOUNT + MOBILE_AMOUNT AS AMOUNT FROM ( SELECT SPEND_DATE ,USER_ID ,SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT ,SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) T ) M2 ON M1.SPEND_DATE = M2.SPEND_DATE AND M1.PLATFORM = M2.PLATFORM GROUP BY M1.SPEND_DATE, M1.PLATFORM"
5,Y,Y,"SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(AMOUNT), 0) TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM (SELECT DISTINCT(SPEND_DATE) SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING) P LEFT JOIN (SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT>0, IF(DESKTOP_AMOUNT>0, 'both', 'mobile'), 'desktop') AS PLATFORM, (DESKTOP_AMOUNT + MOBILE_AMOUNT) AMOUNT FROM (SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT FROM SPENDING GROUP BY 1, 2) O )T ON T.SPEND_DATE = P.SPEND_DATE AND T.PLATFORM = P.PLATFORM GROUP BY 1, 2"
6,N,N,"SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(Y.TOTAL_AMOUNT,0) TOTAL_AMOUNT, IFNULL(Y.TOTAL_USERS,0) AS TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) P LEFT JOIN ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( SELECT SPEND_DATE, USER_ID, PLATFORM, AMOUNT FROM SPENDING GROUP BY 1,2 HAVING COUNT(*) = 1)T GROUP BY 1,2 UNION SELECT A.SPEND_DATE, 'both' AS PLATFORM, SUM(A.AMOUNT + B.AMOUNT) AS TOTAL_USERS, COUNT(A.USER_ID) AS TOTAL_USERS FROM SPENDING A JOIN SPENDING B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM < B.PLATFORM GROUP BY 1 )Y ON P.PLATFORM=Y.PLATFORM AND P.SPEND_DATE=Y.SPEND_DATE"
7,N,N,"SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(Y.TOTAL_AMOUNT,0) TOTAL_AMOUNT, IFNULL(Y.TOTAL_USERS,0) AS TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) P LEFT JOIN ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( SELECT SPEND_DATE, USER_ID, PLATFORM, AMOUNT FROM SPENDING GROUP BY 1,2 HAVING COUNT(*) = 1)T GROUP BY 1,2 UNION SELECT A.SPEND_DATE, 'both' AS PLATFORM, IFNULL(SUM(A.AMOUNT + B.AMOUNT),0) AS TOTAL_USERS, IFNULL(COUNT(B.USER_ID),0) AS TOTAL_USERS FROM SPENDING A LEFT JOIN SPENDING B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM < B.PLATFORM GROUP BY 1 )Y ON P.PLATFORM=Y.PLATFORM AND P.SPEND_DATE=Y.SPEND_DATE"
8,Y,Y,"SELECT T1.SPEND_DATE, T1.PLATFORM, IFNULL(SUM(AMOUNT), 0) TOTAL_AMOUNT , COUNT(USER_ID) TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) AS T1 LEFT JOIN ( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM ( SELECT SPEND_DATE, USER_ID , SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT , SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) AS T2 ) AS T3 ON T1.PLATFORM=T3.PLATFORM AND T1.SPEND_DATE=T3.SPEND_DATE GROUP BY SPEND_DATE, PLATFORM"
9,Y,Y,"SELECT TMP2.SPEND_DATE, TMP2.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) TMP2 LEFT JOIN (SELECT SPEND_DATE, USER_ID, (CASE WHEN MA > 0 AND DA > 0 THEN BOTH WHEN MA > 0 AND DA = 0 THEN MOBILE ELSE DESKTOP END) AS PLATFORM, (DA + MA) AS TOTAL_AMOUNT FROM (SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MA, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DA FROM SPENDING GROUP BY SPEND_DATE, USER_ID) TMP1) TMP3 ON TMP2.PLATFORM = TMP3.PLATFORM AND TMP2.SPEND_DATE = TMP3.SPEND_DATE GROUP BY SPEND_DATE, PLATFORM"
10,Y,N,"WITH BOTHPLATFORMS AS ( SELECT SPEND_DATE, 'BOTH AS PLATFORM', COUNT(PLATFORM) AS PLT_CNT , SUM(AMOUNT) AS AMOUNT , USER_ID FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING PLT_CNT = 2 ) SELECT SPEND_DATE, PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT , IFNULL(COUNT(DISTINCT USER_ID), 0) AS TOTAL_USERS FROM ( SELECT SPEND_DATE, PLATFORM, AMOUNT, USER_ID FROM BOTHPLATFORMS UNION SELECT SPEND_DATE, PLATFORM, AMOUNT, USER_ID FROM SPENDING WHERE (USER_ID, SPEND_DATE) NOT IN (SELECT USER_ID, SPEND_DATE FROM BOTHPLATFORMS) UNION ALL SELECT SPEND_DATE, 'MOBILE AS PLATFORM', 0 AS AMOUNT, NULL AS USER_ID FROM SPENDING UNION ALL SELECT SPEND_DATE, 'DESKTOP AS PLATFORM', 0 AS AMOUNT, NULL AS USER_ID FROM SPENDING UNION ALL SELECT SPEND_DATE, 'BOTH AS PLATFORM', 0 AS AMOUNT, NULL AS USER_ID FROM SPENDING ) AS TBL GROUP BY SPEND_DATE, PLATFORM ORDER BY SPEND_DATE"
11,N,N,"WITH CET AS (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS AMOUNT, COUNT(*) AS USERS FROM SPENDING GROUP BY USER_ID, SPEND_DATE) SELECT T2.SPEND_DATE, T2.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(USERS),0) AS TOTAL_USERS FROM (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) T2 LEFT JOIN CET ON T2.PLATFORM = CET.PLATFORM AND T2.SPEND_DATE = CET.SPEND_DATE GROUP BY SPEND_DATE, T2.PLATFORM"
12,N,N,"WITH CET AS (SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AS AMOUNT, COUNT(*) AS USERS FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) = 1 UNION ALL (SELECT USER_ID, SPEND_DATE , 'both' AS PLATFORM, SUM(AMOUNT), COUNT(*) AS USERS FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) = 2)) SELECT T2.SPEND_DATE, T2.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(USERS),0) AS TOTAL_USERS FROM (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) T2 LEFT JOIN CET ON T2.PLATFORM = CET.PLATFORM AND T2.SPEND_DATE = CET.SPEND_DATE GROUP BY SPEND_DATE, T2.PLATFORM"
13,N,N,"WITH CTE AS ( SELECT DISTINCT SPEND_DATE, T1.PLATFORM FROM SPENDING S JOIN (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM) AS T1 ) SELECT CTE.SPEND_DATE, CTE.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(USER_ID),0) AS TOTAL_USERS FROM ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING S GROUP BY USER_ID, SPEND_DATE) AS TEMP RIGHT JOIN CTE ON TEMP.SPEND_DATE = CTE.SPEND_DATE AND TEMP.PLATFORM = CTE.PLATFORM GROUP BY CTE.SPEND_DATE, CTE.PLATFORM"
14,Y,N,"WITH CTE AS (SELECT USER_ID, SPEND_DATE, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MA, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DA FROM SPENDING GROUP BY USER_ID, SPEND_DATE) SELECT SPEND_DATE, 'desktop' PLATFORM, SUM(CASE WHEN DA > 0 AND MA = 0 THEN DA ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN DA > 0 AND MA = 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' PLATFORM, SUM(CASE WHEN MA > 0 AND DA = 0 THEN MA ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN MA > 0 AND DA = 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' PLATFORM, SUM(CASE WHEN DA > 0 AND MA > 0 THEN MA + DA ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN DA > 0 AND MA > 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM CTE GROUP BY SPEND_DATE"
15,Y,Y,"WITH CTE AS( SELECT SPEND_DATE, USER_ID, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ), CTE1 AS( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT >0, IF(DESKTOP_AMOUNT>0, 'both', 'mobile'), 'desktop') AS PLATFORM , (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM CTE ORDER BY SPEND_DATE ), CTE2 AS( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ORDER BY SPEND_DATE ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(B.AMOUNT), 0) AS TOTAL_AMOUNT , COUNT(USER_ID) AS TOTAL_USERS FROM CTE2 A LEFT JOIN CTE1 B ON A.PLATFORM = B.PLATFORM AND A.SPEND_DATE = B.SPEND_DATE GROUP BY SPEND_DATE, PLATFORM"
16,N,N,"WITH CTE1 AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ), CTE2 AS ( SELECT SPEND_DATE, PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS D1 CROSS JOIN CTE1 AS D2 ORDER BY 1,2 ), CTE3 AS ( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(*) = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT DISTINCT D1.SPEND_DATE, D1.PLATFORM, SUM(IFNULL(D2.TOTAL_AMOUNT,0)) AS TOTAL_AMOUNT, COUNT(DISTINCT D2.USER_ID) AS TOTAL_USERS FROM CTE2 AS D1 LEFT JOIN CTE3 AS D2 ON D1.SPEND_DATE = D2.SPEND_DATE AND D1.PLATFORM = D2.PLATFORM GROUP BY 1,2"
17,Y,N,"WITH RECURSIVE PLATFORMS AS ( SELECT DESKTOP AS P UNION ALL SELECT MOBILE UNION ALL SELECT BOTH ), REPORT_TEMPLATE AS ( SELECT DISTINCT S.SPEND_DATE, PL.P AS PLATFORM FROM SPENDING S, PLATFORMS PL ), ADHOC_SPENDING AS ( SELECT SPEND_DATE, USER_ID, AMOUNT, CASE WHEN DENSE_RANK() OVER(PARTITION BY SPEND_DATE, USER_ID ORDER BY PLATFORM) + DENSE_RANK() OVER(PARTITION BY SPEND_DATE, USER_ID ORDER BY PLATFORM DESC) - 1 = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING ) SELECT RT.SPEND_DATE, RT.PLATFORM, IFNULL(SUM(S.AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS FROM REPORT_TEMPLATE RT LEFT JOIN ADHOC_SPENDING S ON RT.SPEND_DATE = S.SPEND_DATE AND RT.PLATFORM = S.PLATFORM GROUP BY RT.SPEND_DATE, RT.PLATFORM"
18,Y,N,"WITH SPENDBEHAVIOR AS ( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE MAX(PLATFORM) END AS USER_GROUP FROM SPENDING GROUP BY SPEND_DATE, USER_ID ), SPENDGROUP AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ), SPENDDATES AS ( SELECT DISTINCT SPEND_DATE FROM SPENDING ), RESULTSFRAMEWORK AS ( SELECT SPENDDATES.SPEND_DATE, SPENDGROUP.PLATFORM FROM SPENDDATES CROSS JOIN SPENDGROUP ) SELECT RESULTSFRAMEWORK.SPEND_DATE, RESULTSFRAMEWORK.PLATFORM, SUM(COALESCE(SPENDING.AMOUNT, 0)) AS TOTAL_AMOUNT, COUNT(DISTINCT SPENDING.USER_ID) AS TOTAL_USERS FROM RESULTSFRAMEWORK LEFT JOIN SPENDBEHAVIOR ON SPENDBEHAVIOR.USER_GROUP = RESULTSFRAMEWORK.PLATFORM AND SPENDBEHAVIOR.SPEND_DATE = RESULTSFRAMEWORK.SPEND_DATE LEFT JOIN SPENDING ON SPENDING.SPEND_DATE = SPENDBEHAVIOR.SPEND_DATE AND SPENDING.USER_ID = SPENDBEHAVIOR.USER_ID GROUP BY RESULTSFRAMEWORK.SPEND_DATE, RESULTSFRAMEWORK.PLATFORM"
19,Y,N,"WITH T1 AS ( SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT, COUNT(PLATFORM) OVER (PARTITION BY SPEND_DATE, USER_ID) AS NUM FROM SPENDING ), T2 AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN NUM = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM, AMOUNT FROM T1 ) SELECT A.SPEND_DATE, A.PLATFORM, SUM(IFNULL(T2.AMOUNT,0)) AS TOTAL_AMOUNT, COUNT(DISTINCT T2.USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) A LEFT JOIN T2 ON A.SPEND_DATE = T2.SPEND_DATE AND A.PLATFORM = T2.PLATFORM GROUP BY 1,2"
20,Y,N,"WITH T3 AS ( SELECT SPEND_DATE, PLATFORM, SUM(TOTAL_AMOUNT) TOTAL_AMOUNT, COUNT(1) TOTAL_USERS FROM ( SELECT SPEND_DATE, USER_ID, CASE WHEN MOBILE_USES>0 AND DESKTOP_USES>0 THEN BOTH WHEN MOBILE_USES>0 THEN MOBILE WHEN DESKTOP_USES>0 THEN DESKTOP ELSE UNK END PLATFORM, TOTAL_AMOUNT FROM ( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM='mobile' THEN 1 ELSE 0 END) MOBILE_USES, SUM(CASE WHEN PLATFORM='desktop' THEN 1 ELSE 0 END) DESKTOP_USES, SUM(AMOUNT) TOTAL_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) T4 ) T5 GROUP BY SPEND_DATE, PLATFORM ), T1 AS ( SELECT SPEND_DATE FROM T3 GROUP BY SPEND_DATE ), T2 AS ( SELECT SPEND_DATE, 'desktop' PLATFORM FROM T1 UNION SELECT SPEND_DATE, 'mobile' PLATFORM FROM T1 UNION SELECT SPEND_DATE, 'both' PLATFORM FROM T1 ) SELECT T2.SPEND_DATE, T2.PLATFORM, COALESCE(T3.TOTAL_AMOUNT, 0) TOTAL_AMOUNT, COALESCE(T3.TOTAL_USERS, 0) TOTAL_USERS FROM T2 LEFT OUTER JOIN T3 ON T2.SPEND_DATE=T3.SPEND_DATE AND T2.PLATFORM=T3.PLATFORM"
21,Y,N,"WITH AGG AS ( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE MAX(PLATFORM) END AS PLATFORM, SUM(AMOUNT) AS AMT FROM SPENDING GROUP BY 1, 2 ), AGG2 AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM AGG GROUP BY 1, 2 ORDER BY 1, 4 ), REC AS ( SELECT DISTINCT SPEND_DATE, P.PLATFORM FROM SPENDING AS S JOIN (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) AS P ) SELECT R.SPEND_DATE, R.PLATFORM, COALESCE(A.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(A.TOTAL_USERS, 0) AS TOTAL_USERS FROM REC AS R LEFT JOIN AGG2 AS A ON R.SPEND_DATE = A.SPEND_DATE AND R.PLATFORM = A.PLATFORM"
22,Y,N,"WITH BOTH_PLAT AS (SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2 HAVING COUNT(*)=2), SINGLE_PLAT AS (SELECT S1.USER_ID, S1.SPEND_DATE, S1.PLATFORM, S1.AMOUNT FROM SPENDING S1 WHERE S1.SPEND_DATE NOT IN (SELECT S2.SPEND_DATE FROM BOTH_PLAT S2 WHERE S2.USER_ID=S1.USER_ID)), TEMPLATE AS (SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT T.SPEND_DATE, T.PLATFORM, IFNULL(SS.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(SS.TOTAL_USERS,0) AS TOTAL_USERS FROM TEMPLATE T LEFT JOIN (SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT * FROM BOTH_PLAT UNION ALL SELECT * FROM SINGLE_PLAT) SUB GROUP BY 1,2) SS ON T.SPEND_DATE = SS.SPEND_DATE AND T.PLATFORM=SS.PLATFORM"
23,N,N,"WITH C1 AS (SELECT USER_ID ,SPEND_DATE ,PLATFORM ,SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MA ,SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DA FROM SPENDING GROUP BY 1,2) SELECT SPEND_DATE ,'desktop' AS PLATFORM ,SUM(CASE WHEN DA>0 AND MA=0 THEN DA ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN DA>0 AND MA=0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM C1 GROUP BY 1,2 UNION ALL SELECT SPEND_DATE ,'mobile' AS PLATFORM ,SUM(CASE WHEN MA>0 AND DA=0 THEN MA ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN MA>0 AND DA=0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM C1 GROUP BY 1,2 UNION ALL SELECT SPEND_DATE ,'both' AS PLATFORM ,SUM(CASE WHEN MA>0 AND DA>0 THEN MA+DA ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN MA>0 AND DA>0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM C1 GROUP BY 1,2"
24,N,N,"WITH COUNTING AS ( SELECT USER_ID, SPEND_DATE, COUNT(*) CT, PLATFORM, SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY 1, 2 ), STRUCTURE AS ( SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING ), SORTING AS ( SELECT USER_ID, SPEND_DATE, IF(CT = 2, 'both', PLATFORM) PLATFORM, AMOUNT FROM COUNTING ) SELECT S.SPEND_DATE, S.PLATFORM, COALESCE(SUM(AMOUNT), 0) TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM STRUCTURE S LEFT JOIN SORTING ST ON ST.SPEND_DATE = S.SPEND_DATE AND ST.PLATFORM = S.PLATFORM GROUP BY 1, 2"
25,N,N,"WITH CT AS ( SELECT USER_ID, SPEND_DATE, COUNT(*) CT, PLATFORM, SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY 1, 2 ), STRUCTURE AS ( SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING ), SORTING AS ( SELECT USER_ID, SPEND_DATE, IF(CT = 2, 'both', PLATFORM) PLATFORM, AMOUNT FROM CT ) SELECT S.SPEND_DATE, S.PLATFORM, COALESCE(SUM(AMOUNT), 0) TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM STRUCTURE S LEFT JOIN SORTING ST ON ST.SPEND_DATE = S.SPEND_DATE AND ST.PLATFORM = S.PLATFORM GROUP BY 1, 2"
26,Y,N,"WITH CTE AS ( SELECT SPEND_DATE , USER_ID , ( CASE WHEN COUNT(PLATFORM) = 2 THEN BOTH WHEN MAX(PLATFORM) = 'MOBILE THEN MOBILE ELSE DESKTOP' END ) AS PLATFORM , SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ORDER BY SPEND_DATE ) SELECT T2.SPEND_DATE , T2.PLATFORM , SUM( IFNULL (TOTAL_AMOUNT, 0)) AS TOTAL_AMOUNT , COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE , T.PLATFORM FROM CTE CROSS JOIN ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) T ) T2 LEFT JOIN CTE ON T2.SPEND_DATE = CTE.SPEND_DATE AND T2.PLATFORM = CTE.PLATFORM GROUP BY T2.SPEND_DATE, T2.PLATFORM"
27,Y,N,"WITH CTE AS ( SELECT SPEND_DATE ,USER_ID ,SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT ,SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT SPEND_DATE ,'desktop' AS PLATFORM ,SUM(CASE WHEN DESKTOP_AMOUNT > 0 AND MOBILE_AMOUNT = 0 THEN DESKTOP_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN DESKTOP_AMOUNT > 0 AND MOBILE_AMOUNT = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE ,'mobile' AS PLATFORM ,SUM(CASE WHEN DESKTOP_AMOUNT = 0 AND MOBILE_AMOUNT > 0 THEN MOBILE_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN DESKTOP_AMOUNT = 0 AND MOBILE_AMOUNT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE ,'both' AS PLATFORM ,SUM(CASE WHEN DESKTOP_AMOUNT > 0 AND MOBILE_AMOUNT > 0 THEN DESKTOP_AMOUNT + MOBILE_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN DESKTOP_AMOUNT > 0 AND MOBILE_AMOUNT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE"
28,Y,N,"WITH CTE AS (SELECT USER_ID ,SPEND_DATE ,SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MA ,SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DA FROM SPENDING GROUP BY 1,2) SELECT SPEND_DATE ,'desktop' AS PLATFORM ,SUM(CASE WHEN DA>0 AND MA=0 THEN DA ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN DA>0 AND MA=0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY 1,2 UNION ALL SELECT SPEND_DATE ,'mobile' AS PLATFORM ,SUM(CASE WHEN DA=0 AND MA>0 THEN MA ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN DA=0 AND MA>0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY 1,2 UNION ALL SELECT SPEND_DATE ,'both' AS PLATFORM ,SUM(CASE WHEN DA>0 AND MA>0 THEN MA+DA ELSE 0 END) AS TOTAL_AMOUNT ,SUM(CASE WHEN DA>0 AND MA>0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY 1,2 ORDER BY 1"
29,Y,N,"WITH CTE AS (SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT, CASE WHEN SUM(PLATFORM = 'desktop') = 0 THEN 1 ELSE 0 END AS MOBILE, CASE WHEN SUM(PLATFORM = 'mobile') = 0 THEN 1 ELSE 0 END AS DESKTOP, CASE WHEN SUM(PLATFORM = 'desktop') = 0 OR SUM(PLATFORM = 'mobile') = 0 THEN 0 ELSE 1 END AS BOTH FROM SPENDING GROUP BY 1, 2 ) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(AMOUNT * MOBILE) AS TOTAL_AMOUNT, SUM(MOBILE) AS TOTAL_USERS FROM CTE GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(AMOUNT * DESKTOP) AS TOTAL_AMOUNT, SUM(DESKTOP) AS TOTAL_USERS FROM CTE GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT * BOTH ) AS TOTAL_AMOUNT, SUM( BOTH ) AS TOTAL_USERS FROM CTE GROUP BY 1"
30,Y,N,"WITH CTE AS ( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_SPENT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_SPENT FROM SPENDING GROUP BY 1, 2), CTE_2 AS ( SELECT SPEND_DATE, USER_ID, IF(MOBILE_SPENT > 0 AND DESKTOP_SPENT > 0, MOBILE_SPENT + DESKTOP_SPENT, 0) AS BOTH_SPENT, IF(MOBILE_SPENT > 0 AND DESKTOP_SPENT = 0, MOBILE_SPENT, 0) AS MOBILE_SPENT, IF(MOBILE_SPENT = 0 AND DESKTOP_SPENT > 0, DESKTOP_SPENT, 0) AS DESKTOP_SPENT FROM CTE ) SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(BOTH_SPENT) AS TOTAL_AMOUNT, SUM(CASE WHEN BOTH_SPENT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE_2 GROUP BY 1,2 UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(MOBILE_SPENT) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_SPENT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE_2 GROUP BY 1,2 UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(DESKTOP_SPENT) AS TOTAL_AMOUNT, SUM(CASE WHEN DESKTOP_SPENT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE_2 GROUP BY 1,2"
31,N,N,"WITH CTE1 AS ( SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING ), CTE2 AS ( SELECT SPEND_DATE,USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM)=1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY SPEND_DATE,USER_ID ), CTE3 AS ( SELECT SPEND_DATE, PLATFORM, SUM(TOTAL_AMOUNT) TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) USER_CNT FROM CTE2 GROUP BY SPEND_DATE, PLATFORM ) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(TOTAL_AMOUNT,0) TOTAL_AMOUNT, COALESCE(USER_CNT,0) TOTAL_USERS FROM CTE1 A LEFT JOIN CTE3 B ON A.SPEND_DATE=B.SPEND_DATE AND A.PLATFORM=B.PLATFORM"
32,Y,N,"WITH CTE1 AS ( SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, TOTAL_PRICE FROM ( SELECT USER_ID, SPEND_DATE, COUNT(PLATFORM) AS CNT, SUM(AMOUNT) AS TOTAL_PRICE FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) A WHERE CNT > 1 ) , CTE2 AS ( SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT AS TOTAL_PRICE FROM SPENDING WHERE CONCAT(CAST(USER_ID AS CHAR(20)),'-',CAST(SPEND_DATE AS CHAR(20))) NOT IN (SELECT CONCAT(CAST(USER_ID AS CHAR(20)),'-',CAST(SPEND_DATE AS CHAR(20))) FROM CTE1) ) , CTE3 AS (SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT C.SPEND_DATE, C.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT , IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM CTE3 C LEFT JOIN ( SELECT SPEND_DATE, PLATFORM, SUM(TOTAL_PRICE) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( (SELECT * FROM CTE1 A) UNION (SELECT * FROM CTE2 B) ) T GROUP BY SPEND_DATE, PLATFORM ) V ON C.SPEND_DATE = V.SPEND_DATE AND C.PLATFORM = V.PLATFORM"
33,Y,N,"WITH CTE1 AS ( SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, TOTAL_PRICE FROM ( SELECT USER_ID, SPEND_DATE, COUNT(PLATFORM) AS CNT, SUM(AMOUNT) AS TOTAL_PRICE FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) A WHERE CNT > 1 ) , CTE2 AS ( SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT AS TOTAL_PRICE FROM SPENDING WHERE CONCAT(CAST(USER_ID AS CHAR(20)),CAST(SPEND_DATE AS CHAR(20))) NOT IN (SELECT CONCAT(CAST(USER_ID AS CHAR(20)),CAST(SPEND_DATE AS CHAR(20))) FROM CTE1) ) , CTE3 AS (SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT C.SPEND_DATE, C.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT , IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM CTE3 C LEFT JOIN ( SELECT SPEND_DATE, PLATFORM, SUM(TOTAL_PRICE) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( (SELECT * FROM CTE1 A) UNION (SELECT * FROM CTE2 B) ) T GROUP BY SPEND_DATE, PLATFORM ORDER BY SPEND_DATE ASC ) V ON C.SPEND_DATE = V.SPEND_DATE AND C.PLATFORM = V.PLATFORM"
34,Y,N,"WITH INFO_LOOKUP AS ( SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING GROUP BY 1, 2 UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING GROUP BY 1, 2 UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING GROUP BY 1, 2 ) , SALES_SUMMARY AS ( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE MAX(PLATFORM) END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1, 2 ) SELECT I.SPEND_DATE, I.PLATFORM, COALESCE(SUM(S.AMOUNT), 0) AS TOTAL_AMOUNT, COALESCE(COUNT(S.USER_ID), 0) AS TOTAL_USERS FROM INFO_LOOKUP I LEFT JOIN SALES_SUMMARY S ON I.PLATFORM = S.PLATFORM AND I.SPEND_DATE = S.SPEND_DATE GROUP BY 1, 2"
35,Y,N,"WITH IS_MULTIPLE_PLATFORMS AS ( SELECT SPEND_DATE, USER_ID, COUNT(DISTINCT PLATFORM) AS PLATFORM_CNT, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1, 2 ) , SUMMARY AS ( SELECT S.SPEND_DATE, S.PLATFORM, SUM(S.AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS FROM SPENDING S JOIN (SELECT * FROM IS_MULTIPLE_PLATFORMS WHERE PLATFORM_CNT = 1) M ON S.USER_ID = M.USER_ID AND S.SPEND_DATE = M.SPEND_DATE GROUP BY 1, 2 UNION ALL SELECT S.SPEND_DATE, 'both' AS PLATFORM, SUM(S.AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS FROM SPENDING S JOIN (SELECT * FROM IS_MULTIPLE_PLATFORMS WHERE PLATFORM_CNT > 1) M ON S.USER_ID = M.USER_ID AND S.SPEND_DATE = M.SPEND_DATE GROUP BY 1, 2 ) , PLATFORM_LOOKUP AS ( SELECT PLATFORM FROM SPENDING GROUP BY 1 UNION ALL SELECT BOTH AS PLATFORM FROM SPENDING ) , DATE_LOOKUP AS ( SELECT SPEND_DATE FROM SPENDING GROUP BY 1 ) , LOOKUP AS ( SELECT * FROM DATE_LOOKUP, PLATFORM_LOOKUP GROUP BY 1, 2 ) SELECT L.SPEND_DATE, L.PLATFORM, COALESCE(S.TOTAL_AMOUNT, 0 ) AS TOTAL_AMOUNT, COALESCE(S.TOTAL_USERS, 0) AS TOTAL_USERS FROM LOOKUP L LEFT JOIN SUMMARY S ON L.SPEND_DATE = S.SPEND_DATE AND L.PLATFORM = S.PLATFORM ORDER BY 1, 2"
36,Y,N,"WITH MOBILE AS ( SELECT * FROM SPENDING WHERE PLATFORM = 'mobile' ), DESKTOP AS ( SELECT * FROM SPENDING WHERE PLATFORM = 'desktop' ), P AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) , TOTALS AS ( SELECT CASE WHEN T.M_SPEND_DATE IS NULL THEN T.D_SPEND_DATE ELSE T.M_SPEND_DATE END AS SPEND_DATE, CASE WHEN T.D_PLATFORM IS NOT NULL AND T.M_PLATFORM IS NULL THEN T.D_PLATFORM WHEN T.D_PLATFORM IS NULL AND T.M_PLATFORM IS NOT NULL THEN T.M_PLATFORM ELSE BOTH END AS PLATFORM, SUM(COALESCE(D_AMOUNT,0)+COALESCE(M_AMOUNT,0)) AS TOTAL_AMOUNT, SUM( CASE WHEN T.M_USER_ID IS NOT NULL AND T.D_USER_ID IS NOT NULL THEN 1 WHEN T.M_USER_ID IS NOT NULL AND T.D_USER_ID IS NULL THEN 1 WHEN T.M_USER_ID IS NULL AND T.D_USER_ID IS NOT NULL THEN 1 END) AS TOTAL_USERS FROM ( SELECT M.USER_ID AS M_USER_ID, M.SPEND_DATE AS M_SPEND_DATE, M.PLATFORM AS M_PLATFORM, M.AMOUNT AS M_AMOUNT, D.USER_ID AS D_USER_ID, D.SPEND_DATE AS D_SPEND_DATE, D.PLATFORM AS D_PLATFORM, D.AMOUNT AS D_AMOUNT FROM MOBILE AS M LEFT JOIN DESKTOP AS D ON M.USER_ID = D.USER_ID AND M.SPEND_DATE = D.SPEND_DATE UNION SELECT M.USER_ID AS M_USER_ID, M.SPEND_DATE AS M_SPEND_DATE, M.PLATFORM AS M_PLATFORM, M.AMOUNT AS M_AMOUNT, D.USER_ID AS D_USER_ID, D.SPEND_DATE AS D_SPEND_DATE, D.PLATFORM AS D_PLATFORM, D.AMOUNT AS D_AMOUNT FROM MOBILE AS M RIGHT JOIN DESKTOP AS D ON M.USER_ID = D.USER_ID AND M.SPEND_DATE = D.SPEND_DATE ) T GROUP BY 1,2 ORDER BY 1 ) SELECT P.*, COALESCE(TOTALS.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(TOTALS.TOTAL_USERS,0) AS TOTAL_USERS FROM P LEFT JOIN TOTALS ON P.SPEND_DATE = TOTALS.SPEND_DATE AND P.PLATFORM = TOTALS.PLATFORM"
37,Y,N,"WITH MOBILE_ONLY AS ( SELECT SPEND_DATE, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING SUM(CASE WHEN PLATFORM = 'mobile' THEN 1 ELSE 0 END) > 0 AND SUM(CASE WHEN PLATFORM = 'desktop' THEN 1 ELSE 0 END) = 0) X1 GROUP BY SPEND_DATE ), DESKTOP_ONLY AS ( SELECT SPEND_DATE, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING SUM(CASE WHEN PLATFORM = 'mobile' THEN 1 ELSE 0 END) = 0 AND SUM(CASE WHEN PLATFORM = 'desktop' THEN 1 ELSE 0 END) > 0) X2 GROUP BY SPEND_DATE ), BOTH_DES_MO AS ( SELECT SPEND_DATE, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING SUM(CASE WHEN PLATFORM = 'mobile' THEN 1 ELSE 0 END) > 0 AND SUM(CASE WHEN PLATFORM = 'desktop' THEN 1 ELSE 0 END) > 0) X3 GROUP BY SPEND_DATE ) (SELECT F1.SPEND_DATE, F1.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM MOBILE_ONLY D RIGHT JOIN (SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING) F1 ON D.SPEND_DATE = F1.SPEND_DATE) UNION (SELECT F2.SPEND_DATE, F2.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM DESKTOP_ONLY D RIGHT JOIN (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) F2 ON D.SPEND_DATE = F2.SPEND_DATE) UNION (SELECT F3.SPEND_DATE, F3.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM BOTH_DES_MO D RIGHT JOIN (SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) F3 ON D.SPEND_DATE = F3.SPEND_DATE)"
38,N,N,"WITH PLATFORM AS (SELECT DISTINCT(SPEND_DATE) SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE) SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE) SPEND_DATE, 'both' PLATFORM FROM SPENDING) SELECT P1.SPEND_DATE, P1.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT),0) TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM PLATFORM P1 LEFT JOIN (SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) TOTAL_AMOUNT, (CASE WHEN SUM(PLATFORM = 'mobile')+SUM(PLATFORM = 'desktop') = 2 THEN BOTH WHEN SUM(PLATFORM = 'mobile')+SUM(PLATFORM = 'desktop') = 1 THEN PLATFORM END) PLATFORM FROM SPENDING GROUP BY USER_ID, SPEND_DATE) T1 ON P1.SPEND_DATE = T1.SPEND_DATE AND P1.PLATFORM = T1.PLATFORM GROUP BY P1.SPEND_DATE, P1.PLATFORM"
39,N,N,"WITH PLATFORM AS( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING ) SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(S.AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT S.USER_ID),0) AS TOTAL_USERS FROM PLATFORM AS P LEFT JOIN( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT, CASE WHEN COUNT(DISTINCT PLATFORM)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING GROUP BY USER_ID, SPEND_DATE )S ON P.SPEND_DATE=S.SPEND_DATE AND P.PLATFORM=S.PLATFORM GROUP BY P.SPEND_DATE, P.PLATFORM"
40,Y,N,"WITH PLATFORM_ID AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN (COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE)) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, AMOUNT FROM SPENDING ), PLATFORM_SPEND AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM PLATFORM_ID GROUP BY SPEND_DATE, PLATFORM ), ALL_PLATFORM(PLATFORM) AS ( VALUES ROW('mobile'), ROW('desktop'), ROW('both') ), DATA_PLATFORM_COMBO AS ( SELECT DISTINCT A.SPEND_DATE, B.PLATFORM FROM PLATFORM_ID A, ALL_PLATFORM B ) SELECT D.SPEND_DATE, D.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM DATA_PLATFORM_COMBO D LEFT JOIN PLATFORM_SPEND P USING (SPEND_DATE, PLATFORM) ORDER BY SPEND_DATE"
41,Y,N,"WITH PLATFORM_TABLE AS ( SELECT A.USER_ID, A.SPEND_DATE, CASE WHEN B.PLATFORM IS NOT NULL THEN BOTH ELSE A.PLATFORM END AS PLATFORM, A.AMOUNT FROM SPENDING A LEFT JOIN SPENDING B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM != B.PLATFORM ), DATE_PLATFORM AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(SUM(B.AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT B.USER_ID) AS TOTAL_USERS FROM DATE_PLATFORM A LEFT JOIN PLATFORM_TABLE B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY 1, 2"
42,N,N,"WITH RECURSIVE CET AS (SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING ), CET2 AS ((SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM)=1) UNION ALL (SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM)=2)) SELECT CET.SPEND_DATE, CET.PLATFORM, SUM(IFNULL(TOTAL_AMOUNT,0)) AS TOTAL_AMOUNT, SUM(IFNULL(TOTAL_USERS,0)) AS TOTAL_USERS FROM (SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CET2 GROUP BY SPEND_DATE, PLATFORM)P1 RIGHT JOIN CET ON CET.SPEND_DATE=P1.SPEND_DATE AND CET.PLATFORM=P1.PLATFORM GROUP BY CET.SPEND_DATE, CET.PLATFORM ORDER BY SPEND_DATE, PLATFORM"
43,N,N,"WITH SUMMARY AS ( SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), DATE_PLATFORM AS ( SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), SHAPED AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN TOTAL_USERS = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, TOTAL_AMOUNT FROM SUMMARY ) SELECT D.SPEND_DATE, D.PLATFORM, IFNULL(SUM(S.TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(S.USER_ID) AS TOTAL_USERS FROM DATE_PLATFORM AS D LEFT JOIN SHAPED AS S ON D.SPEND_DATE = S.SPEND_DATE AND D.PLATFORM = S.PLATFORM GROUP BY D.SPEND_DATE, D.PLATFORM"
44,Y,N,"WITH T AS( SELECT *, COUNT(PLATFORM)OVER(PARTITION BY SPEND_DATE, USER_ID) AS TYPE FROM SPENDING) SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN TYPE =2 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT (CASE WHEN TYPE =2 THEN USER_ID ELSE NULL END)) AS TOTAL_USERS FROM T GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN TYPE =1 AND PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT (CASE WHEN TYPE =1 AND PLATFORM = 'mobile' THEN USER_ID ELSE NULL END)) AS TOTAL_USERS FROM T GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN TYPE =1 AND PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT (CASE WHEN TYPE =1 AND PLATFORM = 'desktop' THEN USER_ID ELSE NULL END)) AS TOTAL_USERS FROM T GROUP BY SPEND_DATE"
45,Y,N,"WITH T1 AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM SPENDING WHERE (USER_ID, SPEND_DATE) IN (SELECT USER_ID, SPEND_DATE FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(PLATFORM) = 1) GROUP BY SPEND_DATE, PLATFORM ), T2 AS ( SELECT T.SPEND_DATE, T.PLATFORM, COALESCE(T1.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(T1.TOTAL_USERS, 0) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING ) T LEFT JOIN T1 ON T.SPEND_DATE = T1.SPEND_DATE AND T.PLATFORM = T1.PLATFORM ), T3 AS ( SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM SPENDING WHERE (USER_ID, SPEND_DATE) IN (SELECT USER_ID, SPEND_DATE FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(PLATFORM) = 2) GROUP BY SPEND_DATE ), T4 AS ( SELECT T.SPEND_DATE, COALESCE(T3.PLATFORM, 'both') AS PLATFORM, COALESCE(T3.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(T3.TOTAL_USERS, 0) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE FROM SPENDING ) T LEFT JOIN T3 ON T.SPEND_DATE = T3.SPEND_DATE ) SELECT * FROM T2 UNION ALL SELECT * FROM T4"
46,N,N,"WITH T1 AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP , SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE FROM SPENDING GROUP BY USER_ID, SPEND_DATE), T2 AS ( SELECT SPEND_DATE, USER_ID, IF(MOBILE>0, IF(DESKTOP>0, 'both','mobile'),'desktop') AS PLATFORM, SUM(MOBILE+DESKTOP) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T1 GROUP BY SPEND_DATE, PLATFORM), T3 AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT T3.SPEND_DATE, T3.PLATFORM, IFNULL(T2.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM T3 LEFT JOIN T2 ON T3.SPEND_DATE = T2.SPEND_DATE AND T3.PLATFORM = T2.PLATFORM"
47,Y,N,"WITH T1 AS ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS TOTAL_AMOUNT, CASE WHEN SUM(PLATFORM = 'desktop') = 0 THEN 1 ELSE 0 END AS MOBILE , CASE WHEN SUM(PLATFORM = 'mobile') = 0 THEN 1 ELSE 0 END AS DESKTOP , CASE WHEN SUM(PLATFORM = 'desktop') = 0 OR SUM(PLATFORM = 'mobile') = 0 THEN 0 ELSE 1 END AS BOTH FROM SPENDING GROUP BY 1, 2) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(TOTAL_AMOUNT* MOBILE ) AS TOTAL_AMOUNT, SUM(MOBILE) AS TOTAL_USERS FROM T1 GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(TOTAL_AMOUNT* DESKTOP ) AS TOTAL_AMOUNT, SUM(DESKTOP) AS TOTAL_USERS FROM T1 GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(TOTAL_AMOUNT* BOTH ) AS TOTAL_AMOUNT, SUM( BOTH ) AS TOTAL_USERS FROM T1 GROUP BY 1"
48,N,N,"WITH T1 AS( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1, 2 ), T2 AS( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT T2.*, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T2 LEFT JOIN T1 ON T2.SPEND_DATE = T1.SPEND_DATE AND T2.PLATFORM = T1.PLATFORM GROUP BY 1, 2"
49,N,N,"WITH T1 AS( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ), T2 AS( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT T2.*, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T2 LEFT JOIN T1 ON T2.SPEND_DATE = T1.SPEND_DATE AND T2.PLATFORM = T1.PLATFORM GROUP BY 1, 2"
50,N,N,"WITH T1 AS( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1, 2 ), T2 AS( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT T2.*, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T2 LEFT JOIN T1 ON T2.SPEND_DATE = T1.SPEND_DATE AND T2.PLATFORM = T1.PLATFORM GROUP BY 1, 2"
51,Y,N,"WITH TABLE1 AS( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM='mobile' THEN 1 ELSE 0 END) AS M_USER, SUM(CASE WHEN PLATFORM='desktop' THEN 1 ELSE 0 END) AS D_USER, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS M_AMOUNT, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS D_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), TABLE2 AS( SELECT USER_ID, SPEND_DATE, CASE WHEN M_USER>0 AND D_USER>0 THEN BOTH WHEN M_USER>0 AND D_USER=0 THEN MOBILE WHEN M_USER=0 AND D_USER>0 THEN DESKTOP ELSE NULL END AS PLATFORM, COALESCE(M_AMOUNT,0) + COALESCE(D_AMOUNT,0) AS AMOUNT FROM TABLE1 GROUP BY USER_ID, SPEND_DATE ), TABLE3 AS( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM TABLE2 GROUP BY SPEND_DATE, PLATFORM ORDER BY SPEND_DATE ASC ), ALL_PLATFORM(PLATFORM) AS ( VALUES ROW('mobile'), ROW('desktop'), ROW('both') ), TABLE4 AS( SELECT DISTINCT A.SPEND_DATE, B.PLATFORM FROM TABLE2 A, ALL_PLATFORM B ORDER BY SPEND_DATE ASC ) SELECT DISTINCT T4.SPEND_DATE, T4.PLATFORM, COALESCE(T3.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(T3.TOTAL_USERS,0) AS TOTAL_USERS FROM TABLE4 T4 LEFT JOIN TABLE3 T3 USING(SPEND_DATE, PLATFORM)"
52,Y,N,"WITH TEMP AS ( SELECT SPEND_DATE, USER_ID, SUM(AMOUNT) AS AMOUNT, CASE WHEN SUM(IF(PLATFORM = 'mobile', 1, 0)) = 0 THEN 1 ELSE 0 END AS DESKTOP , CASE WHEN SUM(IF(PLATFORM = 'desktop', 1, 0)) = 0 THEN 1 ELSE 0 END AS MOBILE , CASE WHEN SUM(IF(PLATFORM = 'desktop', 1, 0)) + SUM(IF(PLATFORM = 'mobile', 1, 0)) = 2 THEN 1 ELSE 0 END AS B FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(DESKTOP * AMOUNT) AS TOTAL_AMOUNT, SUM(DESKTOP) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(MOBILE * AMOUNT) AS TOTAL_AMOUNT, SUM(MOBILE) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(B * AMOUNT) AS TOTAL_AMOUNT, SUM(B) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE"
53,Y,N,"WITH TEMP AS ( SELECT SPEND_DATE, USER_ID, SUM(AMOUNT) AS AMOUNT, CASE WHEN SUM(IF(PLATFORM = 'mobile', 1, 0)) = 0 THEN 1 ELSE 0 END AS DESKTOP , CASE WHEN SUM(IF(PLATFORM = 'desktop', 1, 0)) = 0 THEN 1 ELSE 0 END AS MOBILE , CASE WHEN SUM(PLATFORM = 'desktop') + SUM(PLATFORM = 'mobile') = 2 THEN 1 ELSE 0 END AS B FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(DESKTOP * AMOUNT) AS TOTAL_AMOUNT, SUM(DESKTOP) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(MOBILE * AMOUNT) AS TOTAL_AMOUNT, SUM(MOBILE) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(B * AMOUNT) AS TOTAL_AMOUNT, SUM(B) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE"
54,Y,N,"WITH PLATFORM_COUNT AS ( SELECT SPEND_DATE ,USER_ID ,COUNT(DISTINCT PLATFORM) AS PLAT_CNT ,SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2), PLATFORM_SUMM AS ( SELECT DISTINCT A.USER_ID,A.TOTAL_AMOUNT,A.SPEND_DATE , CASE WHEN A.PLAT_CNT = 2 THEN BOTH ELSE B.PLATFORM END AS PLATFORM_SUMM FROM PLATFORM_COUNT A LEFT JOIN SPENDING B ON A.SPEND_DATE =B.SPEND_DATE AND A.USER_ID = B.USER_ID), PLATFORM_SUMM_2 AS ( SELECT SPEND_DATE ,PLATFORM_SUMM AS PLATFORM ,SUM(TOTAL_AMOUNT) AS TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM PLATFORM_SUMM GROUP BY 1,2) SELECT A.SPEND_DATE ,A.PLATFORM ,COALESCE(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT ,COALESCE(TOTAL_USERS,0) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) A LEFT JOIN PLATFORM_SUMM_2 B ON A.SPEND_DATE =B.SPEND_DATE AND A.PLATFORM = B.PLATFORM"
55,Y,N,"WITH TEMP_TABLE AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MA, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DA FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN DA > 0 AND MA = 0 THEN DA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN DA > 0 AND MA = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEMP_TABLE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MA > 0 AND DA = 0 THEN MA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MA > 0 AND DA = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEMP_TABLE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN DA > 0 AND MA > 0 THEN MA + DA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN DA > 0 AND MA > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEMP_TABLE GROUP BY SPEND_DATE"
56,N,N,"WITH USER_BEHAVIOR AS (SELECT USER_ID, SPEND_DATE, (CASE WHEN COUNT(*) > 1 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE), SPEND_DATE AS (SELECT DISTINCT SPEND_DATE FROM SPENDING), PLATFORM AS ((SELECT BOTH AS PLATFORM) UNION (SELECT MOBILE AS PLATFORM) UNION (SELECT DESKTOP AS PLATFORM)) SELECT A.SPEND_DATE, B.PLATFORM, IFNULL(SUM(C.AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT C.USER_ID) AS TOTAL_USERS FROM SPEND_DATE AS A CROSS JOIN PLATFORM AS B ON 1=1 LEFT JOIN USER_BEHAVIOR AS C ON A.SPEND_DATE = C.SPEND_DATE AND B.PLATFORM = C.PLATFORM GROUP BY A.SPEND_DATE, B.PLATFORM"
57,N,N,"WITH USER_PLATFORM AS (SELECT USER_ID, SPEND_DATE, (CASE WHEN COUNT(*) = 2 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE), PLATFORM AS ((SELECT BOTH AS PLATFORM) UNION (SELECT MOBILE AS PLATFORM) UNION (SELECT DESKTOP AS PLATFORM)), SPEND_DATE AS (SELECT DISTINCT SPEND_DATE FROM SPENDING) SELECT A.SPEND_DATE, B.PLATFORM, IFNULL(SUM(C.AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT C.USER_ID) AS TOTAL_USERS FROM SPEND_DATE AS A CROSS JOIN PLATFORM AS B ON 1=1 LEFT JOIN USER_PLATFORM AS C ON A.SPEND_DATE = C.SPEND_DATE AND B.PLATFORM = C.PLATFORM GROUP BY A.SPEND_DATE, B.PLATFORM"
58,Y,N,"SELECT C.SPEND_DATE, C.PLATFORM, IFNULL(D.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(D.TOTAL_USERS, 0) AS TOTAL_USERS FROM (SELECT SPEND_DATE, PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS A CROSS JOIN ( SELECT DESKTOP AS PLATFORM UNION ALL SELECT MOBILE AS PLATFORM UNION ALL SELECT BOTH AS PLATFORM ) AS B) AS C LEFT JOIN ( SELECT SPEND_DATE , PLATFORM , SUM(AMOUNT_1) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT *, CASE WHEN PLATFORM_1 = 'mobile' AND PLATFORM_2 = 'DESKTOP THEN BOTH' WHEN PLATFORM_2 = 'mobile' AND PLATFORM_1 = 'DESKTOP THEN BOTH' WHEN PLATFORM_1 = 'mobile' AND PLATFORM_2 IS NULL THEN MOBILE ELSE DESKTOP END AS PLATFORM FROM (SELECT A.USER_ID , A.SPEND_DATE , A.PLATFORM AS PLATFORM_1, A.AMOUNT AS AMOUNT_1, B.PLATFORM AS PLATFORM_2, B.AMOUNT AS AMOUNT_2 FROM SPENDING AS A LEFT JOIN SPENDING AS B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM <> B.PLATFORM ) AS C) AS D GROUP BY SPEND_DATE , PLATFORM ) AS D ON C.SPEND_DATE = D.SPEND_DATE AND C.PLATFORM = D.PLATFORM"
59,Y,Y,"SELECT A.SPEND_DATE,A.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT),0) TOTAL_AMOUNT , COUNT(USER_ID) TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING ) A LEFT JOIN (SELECT SPEND_DATE, USER_ID, (MOBILE_AMOUNT+DESKTOP_AMOUNT) TOTAL_AMOUNT , IF(MOBILE_AMOUNT>0,IF(DESKTOP_AMOUNT>0,'both','mobile'),'desktop') PLATFORM FROM (SELECT USER_ID, SPEND_DATE, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT , SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) B) C ON A.SPEND_DATE=C.SPEND_DATE AND A.PLATFORM=C.PLATFORM GROUP BY A.SPEND_DATE,A.PLATFORM"
60,N,N,"SELECT C.SPEND_DATE , C.PLATFORM , SUM(COALESCE(AMOUNT,0)) TOTAL_AMOUNT , SUM(CASE WHEN AMOUNT IS NULL THEN 0 ELSE 1 END) TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING) C LEFT JOIN (SELECT USER_ID , SPEND_DATE , CASE WHEN COUNT(*)=1 THEN PLATFORM ELSE BOTH END PLATFORM , SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) V ON C.SPEND_DATE=V.SPEND_DATE AND C.PLATFORM=V.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
61,N,N,"SELECT C.SPEND_DATE, C.PLATFORM, SUM(IFNULL(AMOUNT,0)) TOTAL_AMOUNT, SUM(CASE WHEN AMOUNT IS NULL THEN 0 ELSE 1 END) TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING) C LEFT JOIN (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(*)=1 THEN PLATFORM ELSE BOTH END PLATFORM, SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) V ON C.SPEND_DATE=V.SPEND_DATE AND C.PLATFORM=V.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
62,N,N,"SELECT DISTINCT T1.SPEND_DATE, T1.PLATFORM, IFNULL(TOTAL_AMOUNT,0) TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) TOTAL_USERS FROM (SELECT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'both' PLATFORM FROM SPENDING) T1 LEFT JOIN (SELECT SPEND_DATE, CASE WHEN CNT = 2 THEN BOTH ELSE PLATFORM END PLATFORM, COUNT(DISTINCT USER_ID) TOTAL_USERS, SUM(AMOUNT) TOTAL_AMOUNT FROM (SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AMOUNT, COUNT(PLATFORM) CNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) T GROUP BY 1, 2) T2 ON T1.SPEND_DATE=T2.SPEND_DATE AND T1.PLATFORM=T2.PLATFORM"
63,N,N,"SELECT H.SPEND_DATE, H.PLATFORM, IFNULL(SUM(AMOUNT),0) TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) H LEFT JOIN ( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(*) = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING S GROUP BY SPEND_DATE, USER_ID ) A ON H.SPEND_DATE = A.SPEND_DATE AND H.PLATFORM = A.PLATFORM GROUP BY H.SPEND_DATE, H.PLATFORM"
64,N,N,"SELECT SPEND_DATE,PLATFORM,IFNULL(SUM(SA),0) AS TOTAL_AMOUNT ,COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING) A LEFT JOIN (SELECT SPEND_DATE,USER_ID,(CASE WHEN COUNT(PLATFORM)=1 THEN PLATFORM ELSE BOTH END)AS PLATFORM,SUM(AMOUNT) AS SA FROM SPENDING GROUP BY SPEND_DATE,USER_ID)B USING(SPEND_DATE,PLATFORM) GROUP BY SPEND_DATE,PLATFORM"
65,N,N,"SELECT SPEND_DATE,PLATFORM,IFNULL(SUM(SA),0) AS TOTAL_AMOUNT ,COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING)A LEFT JOIN (SELECT SPEND_DATE,USER_ID,(CASE WHEN COUNT(PLATFORM)!=2 THEN PLATFORM ELSE BOTH END)AS PLATFORM,SUM(AMOUNT) AS SA FROM SPENDING GROUP BY SPEND_DATE,USER_ID)B USING(SPEND_DATE,PLATFORM) GROUP BY SPEND_DATE,PLATFORM"
66,Y,N,"SELECT SUB.SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN SUB.PBOTH =0 AND SUB.PLATFORM = 'desktop' THEN SUB.AMOUNTS ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN SUB.PLATFORM = 'desktop' AND SUB.PBOTH =0 THEN 1 ELSE 0 END) TOTAL_USERS FROM (SELECT S1.USER_ID, S1.SPEND_DATE, S1.PLATFORM, S2.PLATFORM PLAT, CASE WHEN S2.PLATFORM IS NULL THEN 0 ELSE 1 END PBOTH, CASE WHEN S2.PLATFORM IS NOT NULL THEN S1.AMOUNT + S2.AMOUNT ELSE S1.AMOUNT END AMOUNTS FROM SPENDING S1 LEFT JOIN SPENDING S2 ON S1.USER_ID = S2.USER_ID AND S1.SPEND_DATE = S2.SPEND_DATE AND S1.PLATFORM != S2.PLATFORM WHERE (S2.PLATFORM IS NULL) OR (S1.PLATFORM = 'mobile' AND S2.PLATFORM = 'desktop'))SUB GROUP BY SPEND_DATE UNION ALL SELECT SUB.SPEND_DATE,'mobile' AS PLATFORM, SUM(CASE WHEN SUB.PBOTH =0 AND SUB.PLATFORM = 'mobile' THEN SUB.AMOUNTS ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN SUB.PLATFORM = 'mobile' AND SUB.PBOTH =0 THEN 1 ELSE 0 END) TOTAL_USERS FROM (SELECT S1.USER_ID, S1.SPEND_DATE, S1.PLATFORM, S2.PLATFORM PLAT, CASE WHEN S2.PLATFORM IS NULL THEN 0 ELSE 1 END PBOTH, CASE WHEN S2.PLATFORM IS NOT NULL THEN S1.AMOUNT + S2.AMOUNT ELSE S1.AMOUNT END AMOUNTS FROM SPENDING S1 LEFT JOIN SPENDING S2 ON S1.USER_ID = S2.USER_ID AND S1.SPEND_DATE = S2.SPEND_DATE AND S1.PLATFORM != S2.PLATFORM WHERE (S2.PLATFORM IS NULL) OR (S1.PLATFORM = 'mobile' AND S2.PLATFORM = 'desktop'))SUB GROUP BY SPEND_DATE UNION ALL SELECT SUB.SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN SUB.PBOTH >0 THEN SUB.AMOUNTS ELSE 0 END) TOTAL_AMOUNT, SUM(SUB.PBOTH) TOTAL_USERS FROM (SELECT S1.USER_ID, S1.SPEND_DATE, S1.PLATFORM, S2.PLATFORM PLAT, CASE WHEN S2.PLATFORM IS NULL THEN 0 ELSE 1 END PBOTH, CASE WHEN S2.PLATFORM IS NOT NULL THEN S1.AMOUNT + S2.AMOUNT ELSE S1.AMOUNT END AMOUNTS FROM SPENDING S1 LEFT JOIN SPENDING S2 ON S1.USER_ID = S2.USER_ID AND S1.SPEND_DATE = S2.SPEND_DATE AND S1.PLATFORM != S2.PLATFORM WHERE (S2.PLATFORM IS NULL) OR (S1.PLATFORM = 'mobile' AND S2.PLATFORM = 'desktop'))SUB GROUP BY SPEND_DATE"
67,Y,Y,"SELECT T.SPEND_DATE, T.PLATFORM, IFNULL(SUM(T2.AMOUNT),0) AS TOTAL_AMOUNT, COUNT(T2.USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) AS T LEFT JOIN (SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT>0, 'both', 'mobile') ,'desktop') AS PLATFORM, MOBILE_AMOUNT + DESKTOP_AMOUNT AS AMOUNT FROM (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) AS T1) AS T2 ON T.SPEND_DATE=T2.SPEND_DATE AND T.PLATFORM=T2.PLATFORM GROUP BY T.SPEND_DATE, T.PLATFORM"
68,N,N,"SELECT T1.SPEND_DATE, T1.PLATFORM, SUM(COALESCE(T2.TOTAL_AMOUNT,0)) AS TOTAL_AMOUNT, SUM(COALESCE(T2.TOTAL_USERS,0)) AS TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING ORDER BY SPEND_DATE ) T1 LEFT JOIN ( SELECT SPEND_DATE, CASE WHEN COUNT(PLATFORM)=1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) T2 ON T1.SPEND_DATE=T2.SPEND_DATE AND T1.PLATFORM=T2.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
69,Y,N,"SELECT TEMP.SPEND_DATE,TEMP.PLATFORM, CASE WHEN RESULT.TOTAL_AMOUNT IS NULL THEN 0 ELSE TOTAL_AMOUNT END AS TOTAL_AMOUNT , CASE WHEN RESULT.TOTAL_USERS IS NULL THEN 0 ELSE TOTAL_USERS END AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) AS TEMP LEFT JOIN ( SELECT SPEND_DATE, CASE WHEN NUM = 1 THEN PLATFORM WHEN NUM = 2 THEN BOTH END AS PLATFORM , SUM(AMOUNT) AS TOTAL_AMOUNT , COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM ( SELECT *, COUNT(PLATFORM) OVER(PARTITION BY USER_ID, SPEND_DATE) AS NUM FROM SPENDING) AS A GROUP BY SPEND_DATE, CASE WHEN NUM = 1 THEN PLATFORM WHEN NUM = 2 THEN BOTH END ) AS RESULT ON TEMP.SPEND_DATE = RESULT.SPEND_DATE AND TEMP.PLATFORM = RESULT.PLATFORM"
70,Y,Y,"SELECT TMP1.SPEND_DATE, TMP1.PLATFORM, IFNULL(SUM(TMP3.AMOUNT), 0) TOTAL_AMOUNT, COUNT(TMP3.USER_ID) TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING) TMP1 LEFT JOIN (SELECT USER_ID, SPEND_DATE, IF (MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AMOUNT FROM (SELECT USER_ID, SPEND_DATE, SUM(IF(PLATFORM = 'mobile', AMOUNT, 0)) MOBILE_AMOUNT, SUM(IF(PLATFORM = 'desktop', AMOUNT, 0)) DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) TMP2 ) TMP3 ON TMP1.SPEND_DATE = TMP3.SPEND_DATE AND TMP1.PLATFORM = TMP3.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
71,Y,N,"WITH SPEND_PLATFORMS AS ( SELECT USER_ID, SPEND_DATE, ( CASE WHEN COUNT(IF(PLATFORM = 'mobile', 1, NULL)) = 0 THEN 1 ELSE 0 END ) AS DESKTOP , ( CASE WHEN COUNT(IF(PLATFORM = 'desktop', 1, NULL)) = 0 THEN 1 ELSE 0 END ) AS MOBILE , ( CASE WHEN COUNT(IF(PLATFORM = 'mobile', 1, NULL)) = 0 OR COUNT(IF(PLATFORM = 'desktop', 1, NULL)) = 0 THEN 0 ELSE 1 END ) AS BOTHS , SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1, 2 ) SELECT SPEND_DATE, 'DESKTOP AS PLATFORM', SUM(IF(DESKTOP = 1, AMOUNT, 0)) AS TOTAL_AMOUNT , COUNT(IF(DESKTOP = 1, 1, NULL)) AS TOTAL_USERS FROM SPEND_PLATFORMS GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'MOBILE AS PLATFORM', SUM(IF(MOBILE = 1, AMOUNT, 0)) AS TOTAL_AMOUNT , COUNT(IF(MOBILE = 1, 1, NULL)) AS TOTAL_USERS FROM SPEND_PLATFORMS GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'BOTH AS PLATFORM', SUM(IF(BOTHS = 1, AMOUNT, 0)) AS TOTAL_AMOUNT , COUNT(IF(BOTHS = 1, 1, NULL)) AS TOTAL_USERS FROM SPEND_PLATFORMS GROUP BY 1"
72,N,N,"WITH A AS( SELECT USER_ID,SPEND_DATE, (IF(COUNT(PLATFORM)=2,'both',PLATFORM)) PLATFORM, SUM(AMOUNT) AMOUNT, 1 ISBOTH FROM SPENDING GROUP BY USER_ID,SPEND_DATE), AA AS( SELECT * FROM A UNION ALL SELECT USER_ID, SPEND_DATE, 'desktop' PLATFORM, 0 AMOUNT, 0 ISBOTH FROM A UNION ALL SELECT USER_ID, SPEND_DATE, 'mobile' PLATFORM, 0 AMOUNT, 0 ISBOTH FROM A UNION ALL SELECT USER_ID, SPEND_DATE, 'both' PLATFORM, 0 AMOUNT, 0 ISBOTH FROM A) SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, SUM(ISBOTH) AS TOTAL_USERS FROM AA GROUP BY SPEND_DATE,PLATFORM ORDER BY FIELD(PLATFORM,'desktop','mobile','both'),SPEND_DATE"
73,Y,N,"WITH ALL_DATE AS ( SELECT SPEND_DATE FROM SPENDING), ALL_PLATFORM AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ), CTE1 AS ( SELECT SPEND_DATE, PLATFORM FROM ALL_DATE D JOIN ALL_PLATFORM P), CTE2 AS ( SELECT USER_ID, SPEND_DATE, GROUP_CONCAT(PLATFORM) AS PLATFORM FROM SPENDING GROUP BY 1,2), CTE3 AS ( SELECT C.SPEND_DATE, (CASE WHEN C.PLATFORM='DESKTOP THEN DESKTOP' WHEN C.PLATFORM='MOBILE THEN MOBILE ELSE BOTH' END) AS PLATFORM, SUM(S.AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS FROM CTE2 C JOIN SPENDING S ON C.USER_ID=S.USER_ID AND C.SPEND_DATE=S.SPEND_DATE GROUP BY 1,2) SELECT C1.SPEND_DATE, C1.PLATFORM, IFNULL(C3.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(C3.TOTAL_USERS,0) AS TOTAL_USERS FROM CTE1 C1 LEFT JOIN CTE3 C3 ON C1.SPEND_DATE=C3.SPEND_DATE AND C1.PLATFORM=C3.PLATFORM GROUP BY 1,2,3,4"
74,N,N,"WITH BOTH_PLATFORMS AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END PLATFORM , SUM(AMOUNT) TOTAL_AMOUNT FROM SPENDING GROUP BY 1, 2 ), BASE_TABLE AS ( SELECT DISTINCT SPEND_DATE, 'MOBILE AS PLATFORM' FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'DESKTOP AS PLATFORM' FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'BOTH AS PLATFORM' FROM SPENDING ) SELECT BA.SPEND_DATE, BA.PLATFORM, IFNULL(SUM(BO.TOTAL_AMOUNT), 0) TOTAL_AMOUNT , IFNULL(COUNT(DISTINCT BO.USER_ID), 0) TOTAL_USERS FROM BASE_TABLE BA LEFT JOIN BOTH_PLATFORMS BO ON BA.PLATFORM = BO.PLATFORM AND BA.SPEND_DATE = BO.SPEND_DATE GROUP BY 1, 2 ORDER BY 1"
75,Y,N,"WITH C AS (SELECT DISTINCT S.SPEND_DATE,P.PLATFORM FROM SPENDING S, (SELECT DESKTOP AS PLATFORM UNION ALL SELECT MOBILE UNION ALL SELECT BOTH ) P) SELECT C.SPEND_DATE, C.PLATFORM, IFNULL(T2.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(T2.TOTAL_USERS,0) AS TOTAL_USERS FROM C LEFT JOIN (SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT S.USER_ID, S.AMOUNT, S.SPEND_DATE, CASE WHEN T.CNT=2 THEN BOTH ELSE S.PLATFORM END AS PLATFORM FROM SPENDING S JOIN (SELECT USER_ID, SPEND_DATE,COUNT(DISTINCT PLATFORM) AS CNT FROM SPENDING GROUP BY 1,2) T ON S.USER_ID=T.USER_ID AND S.SPEND_DATE=T.SPEND_DATE) T1 GROUP BY 1,2) T2 ON C.SPEND_DATE=T2.SPEND_DATE AND C.PLATFORM=T2.PLATFORM"
76,Y,N,"WITH C AS( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) ,T AS( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(*) >1 THEN BOTH ELSE MAX(PLATFORM) END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT C.SPEND_DATE, C.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM C LEFT JOIN T ON C.SPEND_DATE = T.SPEND_DATE AND C.PLATFORM = T.PLATFORM GROUP BY C.SPEND_DATE, C.PLATFORM"
77,Y,Y,"WITH CNT AS ( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING S GROUP BY SPEND_DATE, USER_ID ) , HEADER AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT H.SPEND_DATE, H.PLATFORM, IFNULL(SUM(AMOUNT),0) TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM HEADER H LEFT JOIN ( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT >0, IF(DESKTOP_AMOUNT>0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM CNT ) A ON H.SPEND_DATE = A.SPEND_DATE AND H.PLATFORM = A.PLATFORM GROUP BY H.SPEND_DATE, H.PLATFORM"
78,Y,Y,"WITH CNT AS ( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING S GROUP BY SPEND_DATE, USER_ID ) , HEADER AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT H.SPEND_DATE, H.PLATFORM, IFNULL(SUM(AMOUNT),0) TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM HEADER H LEFT JOIN ( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT >0, IF(DESKTOP_AMOUNT>0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM CNT ) A ON H.SPEND_DATE = A.SPEND_DATE AND H.PLATFORM = A.PLATFORM GROUP BY H.SPEND_DATE, H.PLATFORM"
79,N,N,"WITH CTE AS ( (SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1, 2 HAVING COUNT(DISTINCT PLATFORM) = 1) UNION ALL (SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM , SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) = 2) ), CTE1 AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION (SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING) UNION (SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) ) SELECT CTE1.SPEND_DATE, CTE1.PLATFORM, IFNULL(SUM(CTE.AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT CTE.USER_ID) AS TOTAL_USERS FROM CTE1 LEFT JOIN CTE ON CTE1.SPEND_DATE = CTE.SPEND_DATE AND CTE1.PLATFORM = CTE.PLATFORM GROUP BY CTE1.SPEND_DATE, CTE1.PLATFORM"
80,Y,N,"WITH CTE AS ( SELECT SPEND_DATE,USER_ID,MAX(PLATFORM) PLATFORM, COUNT(DISTINCT PLATFORM) CNT ,SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY SPEND_DATE,USER_ID ORDER BY 1,2 ) SELECT D.SPEND_DATE,P.PLATFORM,IFNULL(SUM(CTE2.AMOUNT),0) TOTAL_AMOUNT ,IFNULL(COUNT(DISTINCT CTE2.USER_ID),0) TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) D CROSS JOIN (SELECT DESKTOP PLATFORM UNION ALL SELECT MOBILE UNION ALL SELECT BOTH ) P ON 1=1 LEFT JOIN (SELECT SPEND_DATE,USER_ID,AMOUNT,CASE WHEN CNT > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM CTE) CTE2 ON D.SPEND_DATE = CTE2.SPEND_DATE AND CTE2.PLATFORM = P.PLATFORM GROUP BY D.SPEND_DATE,P.PLATFORM ORDER BY 1"
81,Y,N,"WITH CTE AS ( SELECT SPEND_DATE,USER_ID,MAX(PLATFORM) PLATFORM, COUNT(DISTINCT PLATFORM) CNT ,SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY SPEND_DATE,USER_ID ORDER BY 1,2 ) SELECT P.SPEND_DATE,P.PLATFORM,IFNULL(SUM(CTE2.AMOUNT),0) TOTAL_AMOUNT ,IFNULL(COUNT(DISTINCT CTE2.USER_ID),0) TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) P LEFT JOIN (SELECT SPEND_DATE,USER_ID,AMOUNT,CASE WHEN CNT > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM CTE) CTE2 ON P.SPEND_DATE = CTE2.SPEND_DATE AND CTE2.PLATFORM = P.PLATFORM GROUP BY P.SPEND_DATE,P.PLATFORM ORDER BY 1"
82,Y,N,"WITH CTE AS ( SELECT SPEND_DATE,USER_ID,MAX(PLATFORM) PLATFORM, COUNT(DISTINCT PLATFORM) CNT ,SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY SPEND_DATE,USER_ID ORDER BY 1,2 ), D AS ( SELECT * FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) A, (SELECT DESKTOP PLATFORM UNION ALL SELECT MOBILE UNION ALL SELECT BOTH ) P) SELECT D.SPEND_DATE,D.PLATFORM,IFNULL(SUM(CTE2.AMOUNT),0) TOTAL_AMOUNT ,IFNULL(COUNT(DISTINCT CTE2.USER_ID),0) TOTAL_USERS FROM D LEFT JOIN (SELECT SPEND_DATE,USER_ID,AMOUNT,CASE WHEN CNT > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM CTE) CTE2 ON D.SPEND_DATE = CTE2.SPEND_DATE AND CTE2.PLATFORM = D.PLATFORM GROUP BY D.SPEND_DATE,D.PLATFORM ORDER BY 1"
83,Y,N,"WITH CTE AS ( SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING ), CTE1 AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) = 1 THEN MIN(PLATFORM) ELSE BOTH END PLATFORM, SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY 1,2 ) SELECT DISTINCT C.SPEND_DATE, C.PLATFORM, COALESCE(SUM(AMOUNT),0) TOTAL_AMOUNT, SUM(CASE WHEN AMOUNT IS NULL THEN 0 ELSE 1 END) TOTAL_USERS FROM CTE C LEFT JOIN CTE1 C1 ON C.SPEND_DATE = C1.SPEND_DATE AND C.PLATFORM = C1.PLATFORM GROUP BY 1,2 ORDER BY 1"
84,Y,N,"WITH CTE AS ( SELECT * FROM ( SELECT DESKTOP AS PLATFORM UNION ALL SELECT MOBILE AS PLATFORM UNION ALL SELECT BOTH AS PLATFORM )T CROSS JOIN ( SELECT DISTINCT SPEND_DATE FROM SPENDING )T1 ), CTE1 AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN DESKTOP > 0 AND MOBILE = 0 THEN DESKTOP WHEN DESKTOP = 0 AND MOBILE > 0 THEN MOBILE ELSE BOTH END AS PLATFORM, DESKTOP + MOBILE AS AMOUNT FROM ( SELECT USER_ID, SPEND_DATE, SUM(DESKTOP) AS DESKTOP, SUM(MOBILE) AS MOBILE FROM ( SELECT USER_ID, SPEND_DATE, IF(PLATFORM = 'desktop', AMOUNT, 0) AS DESKTOP, IF(PLATFORM = 'mobile', AMOUNT, 0) AS MOBILE FROM SPENDING )T2 GROUP BY USER_ID, SPEND_DATE )T3 ) SELECT CTE.SPEND_DATE, CTE.PLATFORM, COALESCE(SUM(CTE1.AMOUNT), 0) AS TOTAL_AMOUNT, COALESCE(COUNT(CTE1.USER_ID), 0) AS TOTAL_USERS FROM CTE LEFT JOIN CTE1 ON CTE.SPEND_DATE = CTE1.SPEND_DATE AND CTE.PLATFORM = CTE1.PLATFORM GROUP BY CTE.SPEND_DATE, CTE.PLATFORM"
85,N,N,"WITH CTE AS ( SELECT DISTINCT SPEND_DATE AS SPEND_DATE ,F.PLATFORM AS PLATFORM FROM SPENDING CROSS JOIN (SELECT DISTINCT PLATFORM FROM SPENDING )F UNION SELECT DISTINCT SPEND_DATE, 'both' FROM SPENDING), CTE2 AS ( SELECT USER_ID, SPEND_DATE ,CASE WHEN COUNT(*) =2 THEN BOTH ELSE PLATFORM END AS MEDIUM_, SUM(AMOUNT) AS TOTAL FROM SPENDING GROUP BY USER_ID , SPEND_DATE ) SELECT C.SPEND_DATE, C.PLATFORM,COALESCE(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(TOTAL_USERS,0) AS TOTAL_USERS FROM ( SELECT SPEND_DATE,MEDIUM_ AS PLATFORM, SUM(TOTAL) AS TOTAL_AMOUNT , COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE2 GROUP BY SPEND_DATE,MEDIUM_)G RIGHT JOIN CTE C ON G.SPEND_DATE = C.SPEND_DATE AND G.PLATFORM =C.PLATFORM"
86,Y,N,"WITH CTE AS ( SELECT S1.USER_ID, S1.SPEND_DATE, S1.AMOUNT, CASE WHEN S2.PLATFORM IS NOT NULL THEN BOTH ELSE S1.PLATFORM END AS PLATFORM FROM SPENDING S1 LEFT JOIN SPENDING S2 ON S1.USER_ID = S2.USER_ID AND S1.SPEND_DATE = S2.SPEND_DATE AND S1.PLATFORM != S2.PLATFORM ) , CTE2 AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT CTE2.SPEND_DATE, CTE2.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM CTE2 LEFT JOIN CTE ON CTE2.SPEND_DATE = CTE.SPEND_DATE AND CTE2.PLATFORM = CTE.PLATFORM GROUP BY 1, 2 ORDER BY CTE2.PLATFORM"
87,Y,N,"WITH CTE AS ( SELECT SPEND_DATE , USER_ID , COUNT(DISTINCT PLATFORM) AS NUM_OF_PLATFORM FROM SPENDING GROUP BY 1,2 ), CTE2 AS ( SELECT C.SPEND_DATE , C.USER_ID , CASE WHEN NUM_OF_PLATFORM=1 THEN S.PLATFORM ELSE BOTH END AS PLATFORM , SUM(AMOUNT) AS TOTAL_AMOUNT FROM CTE C INNER JOIN SPENDING S ON C.USER_ID=S.USER_ID AND C.SPEND_DATE=S.SPEND_DATE GROUP BY 1,2,3 ), DATE_PLATFORM AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM CTE UNION ALL SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM CTE UNION ALL SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM CTE ) SELECT P.SPEND_DATE , P.PLATFORM , COALESCE(SUM(C2.TOTAL_AMOUNT),0) AS TOTAL_AMOUNT , COALESCE(COUNT(DISTINCT C2.USER_ID),0) AS TOTAL_USERS FROM DATE_PLATFORM P LEFT JOIN CTE2 C2 ON P.SPEND_DATE=C2.SPEND_DATE AND P.PLATFORM=C2.PLATFORM GROUP BY 1,2 ORDER BY 1,2"
88,Y,N,"WITH CTE AS ( SELECT SPEND_DATE, (CASE WHEN PLAT_CNT = 1 AND PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, (CASE WHEN PLAT_CNT = 1 AND PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT, (CASE WHEN PLAT_CNT >1 THEN AMOUNT ELSE 0 END) AS BOTH_AMOUNT, (CASE WHEN PLAT_CNT = 1 AND PLATFORM = 'mobile' THEN USER_ID ELSE NULL END) AS MOBILE_USER, (CASE WHEN PLAT_CNT = 1 AND PLATFORM = 'desktop' THEN USER_ID ELSE NULL END) AS DESKTOP_USER, (CASE WHEN PLAT_CNT >1 THEN USER_ID ELSE NULL END) AS BOTH_USER FROM ( SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT, COUNT(PLATFORM) OVER(PARTITION BY SPEND_DATE, USER_ID) AS PLAT_CNT FROM SPENDING) AS T) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(DESKTOP_AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT DESKTOP_USER) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(MOBILE_AMOUNT), COUNT(DISTINCT MOBILE_USER) FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(BOTH_AMOUNT), COUNT(DISTINCT BOTH_USER) FROM CTE GROUP BY SPEND_DATE"
89,Y,Y,"WITH CTE AS ( SELECT SPEND_DATE, USER_ID , IF(MOBILE_AMT > 0, IF(DESKTOP_AMT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM , MOBILE_AMT + DESKTOP_AMT AS AMOUNT FROM ( SELECT SPEND_DATE, USER_ID , SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMT , SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMT FROM SPENDING GROUP BY 1,2 ) TMP ) , CART_PROD AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT CART_PROD.SPEND_DATE, CART_PROD.PLATFORM , SUM(IFNULL(AMOUNT, 0)) AS TOTAL_AMOUNT , COUNT(USER_ID) AS TOTAL_USERS FROM CART_PROD LEFT JOIN CTE ON CTE.SPEND_DATE=CART_PROD.SPEND_DATE AND CTE.PLATFORM=CART_PROD.PLATFORM GROUP BY 1,2"
90,Y,N,"WITH CTE AS ( SELECT SPENDING.USER_ID, SPENDING.SPEND_DATE, AMOUNT, CNT, PLATFORM FROM SPENDING LEFT JOIN( SELECT USER_ID, SPEND_DATE, COUNT(DISTINCT PLATFORM) AS CNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) AS T ON SPENDING.USER_ID = T.USER_ID AND SPENDING.SPEND_DATE = T.SPEND_DATE) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN PLATFORM ='desktop' AND CNT= 1 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN PLATFORM ='desktop' AND CNT= 1 THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN PLATFORM ='mobile' AND CNT= 1 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN PLATFORM ='mobile' AND CNT= 1 THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN CNT= 2 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT,COUNT(DISTINCT CASE WHEN CNT= 2 THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE"
91,Y,N,"WITH CTE AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN PLATFORM != 'mobile' AND PLATFORM != 'DESKTOP THEN BOTH' ELSE PLATFORM END PLATFORM, AMOUNT FROM ( SELECT USER_ID, SPEND_DATE, GROUP_CONCAT(PLATFORM) PLATFORM, SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY 1, 2) F ), CTE1 AS ( SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING ), CTE2 AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AMOUNT, COUNT(DISTINCT USER_ID) TOTAL_USERS FROM CTE GROUP BY 1, 2 ) SELECT CTE1.SPEND_DATE, CTE1.PLATFORM, IFNULL(CTE2.AMOUNT, 0) TOTAL_AMOUNT, IFNULL(CTE2.TOTAL_USERS, 0) TOTAL_USERS FROM CTE1 LEFT JOIN CTE2 ON CTE1.SPEND_DATE = CTE2.SPEND_DATE AND CTE1.PLATFORM = CTE2.PLATFORM"
92,N,N,"WITH CTE AS ( SELECT USER_ID, SPEND_DATE, IF(COUNT(*)=1, PLATFORM, 'both') PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), DATE_PLAT AS ( SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING ) SELECT D.SPEND_DATE, D.PLATFORM, SUM(COALESCE(TOTAL_AMOUNT,0)) AS TOTAL_AMOUNT, SUM(CASE WHEN TOTAL_AMOUNT IS NULL THEN 0 ELSE 1 END) TOTAL_USERS FROM DATE_PLAT D LEFT JOIN CTE C ON D.SPEND_DATE = C.SPEND_DATE AND D.PLATFORM = C.PLATFORM GROUP BY 1, 2"
93,Y,N,"WITH CTE AS ( SELECT USER_ID, SPEND_DATE, SUM( DISTINCT CASE WHEN PLATFORM = 'desktop' THEN 1 ELSE 2 END ) AS TYPE, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT SUB1.SPEND_DATE, SUB1.PLATFORM, COALESCE(SUB2.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(SUB2.TOTAL_USERS, 0) AS TOTAL_USERS FROM ( SELECT DISTINCT CTE.SPEND_DATE, P.PLATFORM FROM CTE CROSS JOIN ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) AS P ) AS SUB1 LEFT JOIN ( SELECT SPEND_DATE, CASE WHEN TYPE = 1 THEN DESKTOP WHEN TYPE = 2 THEN MOBILE ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE, TYPE ) AS SUB2 ON SUB1.SPEND_DATE = SUB2.SPEND_DATE AND SUB1.PLATFORM = SUB2.PLATFORM"
94,Y,N,"WITH CTE AS ( SELECT USER_ID, SPEND_DATE, SUM( DISTINCT CASE WHEN PLATFORM = 'desktop' THEN 1 ELSE 2 END ) AS TYPE, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT SUB1.SPEND_DATE, SUB1.PLATFORM, COALESCE(SUB2.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(SUB2.TOTAL_USERS, 0) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile'AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) AS SUB1 LEFT JOIN ( SELECT SPEND_DATE, CASE WHEN TYPE = 1 THEN DESKTOP WHEN TYPE = 2 THEN MOBILE ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE, TYPE ) AS SUB2 ON SUB1.SPEND_DATE = SUB2.SPEND_DATE AND SUB1.PLATFORM = SUB2.PLATFORM"
95,Y,N,"WITH CTE AS (SELECT S.*, CASE WHEN CNT = 2 THEN BOTH ELSE S.PLATFORM END AS NEW_PLATFORM FROM ( SELECT S.*, COUNT( PLATFORM) OVER(PARTITION BY USER_ID, SPEND_DATE ) AS CNT FROM SPENDING S) S), CTE2 AS (SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT CTE2.SPEND_DATE, CTE2.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE2 LEFT JOIN CTE ON CTE2.SPEND_DATE = CTE.SPEND_DATE AND CTE2.PLATFORM = NEW_PLATFORM GROUP BY CTE2.SPEND_DATE, CTE2.PLATFORM"
96,Y,Y,"WITH CTE AS (SELECT USER_ID,SPEND_DATE,SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT,SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END ) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID,SPEND_DATE), DTE AS (SELECT USER_ID,SPEND_DATE,CASE WHEN ((MOBILE_AMOUNT<>0) AND (DESKTOP_AMOUNT<>0)) THEN BOTH WHEN MOBILE_AMOUNT>0 THEN MOBILE ELSE DESKTOP END AS PLATFORM,(MOBILE_AMOUNT+DESKTOP_AMOUNT) AS AMOUNT FROM CTE), ETE AS (SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM DTE GROUP BY 1,2), FTE AS (SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING) SELECT FTE.SPEND_DATE,FTE.PLATFORM,IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT,IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM FTE LEFT JOIN ETE ON FTE.SPEND_DATE=ETE.SPEND_DATE AND FTE.PLATFORM=ETE.PLATFORM"
97,N,N,"WITH CTE AS (SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING) SELECT C.SPEND_DATE,C.PLATFORM, SUM(CASE WHEN A.PLATFORM IS NULL THEN 0 ELSE AMOUNT END) AS TOTAL_AMOUNT, SUM(CASE WHEN A.PLATFORM IS NULL THEN 0 ELSE 1 END) AS TOTAL_USERS FROM CTE C LEFT OUTER JOIN ( SELECT USER_ID,SPEND_DATE,SUM(AMOUNT) AS AMOUNT, COUNT(DISTINCT PLATFORM) AS CNT, CASE WHEN COUNT(DISTINCT PLATFORM)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING S GROUP BY USER_ID,SPEND_DATE)A ON C.SPEND_DATE=A.SPEND_DATE AND C.PLATFORM=A.PLATFORM GROUP BY C.SPEND_DATE,C.PLATFORM"
98,N,N,"WITH CTE AS (SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, SUM(CASE WHEN B.PLATFORM IS NULL THEN 0 ELSE B.TOT END) AS TOTAL_AMOUNT, SUM(CASE WHEN B.PLATFORM IS NULL THEN 0 ELSE 1 END) AS TOTAL_USERS FROM CTE A LEFT JOIN ( SELECT USER_ID,SPEND_DATE, COUNT(DISTINCT PLATFORM) AS CNT, (CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS TOT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) AS B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY A.SPEND_DATE, A.PLATFORM"
99,N,N,"WITH CTE AS (SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING) SELECT C.SPEND_DATE,C.PLATFORM,SUM(CASE WHEN A.PLATFORM IS NULL THEN 0 ELSE AMOUNT END) AS TOTAL_AMOUNT,SUM(CASE WHEN A.PLATFORM IS NULL THEN 0 ELSE 1 END) AS TOTAL_USERS FROM CTE C LEFT OUTER JOIN (SELECT USER_ID,SPEND_DATE,SUM(AMOUNT) AS AMOUNT,COUNT(DISTINCT PLATFORM) AS CNT,CASE WHEN COUNT(DISTINCT PLATFORM )=2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING GROUP BY 1,2)A ON A.SPEND_DATE=C.SPEND_DATE AND A.PLATFORM=C.PLATFORM GROUP BY 1,2"
100,N,N,"WITH CTE AS (SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING) SELECT C.SPEND_DATE,C.PLATFORM,SUM(CASE WHEN A.PLATFORM IS NULL THEN 0 ELSE AMOUNT END)AS TOTAL_AMOUNT,SUM(CASE WHEN A.PLATFORM IS NULL THEN 0 ELSE 1 END) AS TOTAL_USERS FROM CTE C LEFT OUTER JOIN (SELECT USER_ID,SPEND_DATE,SUM(AMOUNT) AS AMOUNT,COUNT(DISTINCT PLATFORM)AS CNT,CASE WHEN COUNT(DISTINCT PLATFORM)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING GROUP BY 1,2)AS A ON A.SPEND_DATE=C.SPEND_DATE AND A.PLATFORM=C.PLATFORM GROUP BY 1,2"
101,Y,N,"WITH CTE AS (SELECT S1.USER_ID, S1.SPEND_DATE, S1.AMOUNT, CASE WHEN S2.PLATFORM IS NULL THEN S1.PLATFORM ELSE BOTH END AS PLATFORM FROM SPENDING S1 LEFT JOIN SPENDING S2 ON S1.USER_ID=S2.USER_ID AND S1.SPEND_DATE=S2.SPEND_DATE AND S1.PLATFORM <> S2.PLATFORM), CTE2 AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT CTE2.SPEND_DATE, CTE2.PLATFORM, SUM(IFNULL(AMOUNT,0)) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE2 LEFT JOIN CTE ON CTE2.SPEND_DATE = CTE.SPEND_DATE AND CTE2.PLATFORM = CTE.PLATFORM GROUP BY CTE2.SPEND_DATE, CTE2.PLATFORM"
102,N,N,"WITH CTE AS (SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN SUM(AMOUNT) ELSE AMOUNT END AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE,USER_ID), BO AS (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) SELECT SPEND_DATE, PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM BO LEFT JOIN CTE USING(SPEND_DATE,PLATFORM) GROUP BY SPEND_DATE,PLATFORM"
103,Y,N,"WITH CTE AS (SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT END) AS MOBILE, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT END) AS DESKTOP FROM SPENDING GROUP BY SPEND_DATE, USER_ID) ,CTE2 AS ((SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING) UNION (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) UNION (SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING)) SELECT C1.SPEND_DATE,C1.PLATFORM,COALESCE(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT,COALESCE(TOTAL_USERS,0) TOTAL_USERS FROM CTE2 C1 LEFT JOIN (SELECT SPEND_DATE, (CASE WHEN MOBILE IS NULL THEN DESKTOP WHEN DESKTOP IS NULL THEN MOBILE ELSE BOTH END) AS PLATFORM, SUM(COALESCE(MOBILE,0)+COALESCE(DESKTOP,0)) AS TOTAL_AMOUNT , COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE C GROUP BY SPEND_DATE, PLATFORM) T1 ON C1.SPEND_DATE=T1.SPEND_DATE AND C1.PLATFORM=T1.PLATFORM"
104,Y,N,"WITH CTE AS (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MA, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS DA FROM SPENDING GROUP BY USER_ID, SPEND_DATE) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN CTE.DA>0 AND CTE.MA=0 THEN DA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN CTE.DA>0 AND CTE.MA=0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN CTE.DA=0 AND CTE.MA>0 THEN MA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN CTE.DA=0 AND CTE.MA>0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN CTE.DA>0 AND CTE.MA>0 THEN DA+MA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN CTE.DA>0 AND CTE.MA>0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE"
105,Y,N,"WITH CTE AS( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), CTE2 AS( SELECT A.SPEND_DATE, CASE WHEN B.PLATFORM IS NOT NULL THEN BOTH ELSE A.PLATFORM END PLATFORM, SUM(A.AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM SPENDING A LEFT JOIN SPENDING B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM != B.PLATFORM GROUP BY A.SPEND_DATE, PLATFORM ) SELECT CTE.SPEND_DATE, CTE.PLATFORM, COALESCE(CTE2.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(CTE2.TOTAL_USERS,0) AS TOTAL_USERS FROM CTE2 RIGHT JOIN CTE ON CTE2.SPEND_DATE = CTE.SPEND_DATE AND CTE2.PLATFORM = CTE.PLATFORM"
106,Y,Y,"WITH CTE AS( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), TMP AS( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY 1, 2 ), TMP2 AS( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM TMP ) SELECT CTE.SPEND_DATE, CTE.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM CTE LEFT JOIN TMP2 ON CTE.SPEND_DATE = TMP2.SPEND_DATE AND CTE.PLATFORM = TMP2.PLATFORM GROUP BY 1,2"
107,Y,N,"WITH CTE AS( SELECT DISTINCT SPEND_DATE, USER_ID, COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) N_PLATFORM, PLATFORM, AMOUNT FROM SPENDING), CTE2 AS ( SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING), CTE3 AS( SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE WHERE N_PLATFORM=2 GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE WHERE N_PLATFORM=1 AND PLATFORM='mobile' GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE WHERE N_PLATFORM=1 AND PLATFORM='desktop' GROUP BY SPEND_DATE) SELECT CTE2.SPEND_DATE, CTE2.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM CTE2 LEFT JOIN CTE3 ON CTE2.SPEND_DATE=CTE3.SPEND_DATE AND CTE2.PLATFORM=CTE3.PLATFORM"
108,N,N,"WITH CTE AS( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS TOTAL_AMOUNT, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END PLATFORM_ALL FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), GRPS AS( SELECT S1.SPEND_DATE, S2.PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM CTE ORDER BY 1) S1 CROSS JOIN (SELECT MOBILE AS PLATFORM UNION ALL SELECT DESKTOP AS PLATFORM UNION ALL SELECT BOTH AS PLATFORM ) S2 ), INTERM AS( SELECT SPEND_DATE, PLATFORM_ALL AS PLATFORM, SUM(TOTAL_AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM CTE C GROUP BY 1,2 ) SELECT G.SPEND_DATE, G.PLATFORM, IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM GRPS G LEFT JOIN INTERM I ON G.SPEND_DATE = I.SPEND_DATE AND G.PLATFORM = I.PLATFORM"
109,N,N,"WITH CTE AS( SELECT USER_ID,SPEND_DATE,SUM(AMOUNT) AS AMOUNT, CASE WHEN SUM(PLATFORM_N)=3 THEN BOTH ELSE PLATFORM END AS NEW_PLATFORM FROM (SELECT USER_ID,SPEND_DATE,PLATFORM,AMOUNT, CASE WHEN PLATFORM='mobile' THEN 2 ELSE 1 END AS PLATFORM_N FROM SPENDING) A GROUP BY USER_ID,SPEND_DATE ) SELECT DISTINCT A.SPEND_DATE,PLATFORM,IFNULL(SUM(B.AMOUNT),0) AS TOTAL_AMOUNT,IFNULL(COUNT(DISTINCT B.USER_ID),0) AS TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE),'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE),'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE),'both' PLATFORM FROM SPENDING ) A LEFT JOIN CTE B ON A.SPEND_DATE=B.SPEND_DATE AND A.PLATFORM=B.NEW_PLATFORM GROUP BY A.SPEND_DATE,A.PLATFORM"
110,Y,N,"WITH CTE1 AS ( SELECT SPEND_DATE, USER_ID FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(*)=1 ), CTE2 AS ( SELECT C.SPEND_DATE, 'desktop' PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT, COUNT(C.USER_ID) TOTAL_USERS FROM CTE1 C JOIN SPENDING S ON C.SPEND_DATE=S.SPEND_DATE AND C.USER_ID=S.USER_ID WHERE PLATFORM='desktop' GROUP BY C.SPEND_DATE UNION ALL SELECT C.SPEND_DATE, 'mobile' PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT, COUNT(C.USER_ID) TOTAL_USERS FROM CTE1 C JOIN SPENDING S ON C.SPEND_DATE=S.SPEND_DATE AND C.USER_ID=S.USER_ID WHERE PLATFORM='mobile' GROUP BY C.SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' PLAT, SUM(SUB) TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM (SELECT SPEND_DATE, USER_ID, SUM(AMOUNT) SUB FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(*) = 2) R1 GROUP BY SPEND_DATE ), CTE3 AS ( SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING ) SELECT C3.SPEND_DATE, C3.PLATFORM, IFNULL(C2.TOTAL_AMOUNT, 0) TOTAL_AMOUNT, IFNULL(C2.TOTAL_USERS, 0) TOTAL_USERS FROM CTE3 C3 LEFT JOIN CTE2 C2 ON C3.SPEND_DATE=C2.SPEND_DATE AND C3.PLATFORM=C2.PLATFORM"
111,Y,N,"WITH CTE1 AS ( SELECT SPEND_DATE, USER_ID, AMOUNT, 'mobile' AS PLATFORM FROM SPENDING S WHERE EXISTS (SELECT SPEND_DATE, USER_ID, PLATFORM FROM SPENDING WHERE PLATFORM = 'mobile' AND S.USER_ID = USER_ID AND S.SPEND_DATE = SPEND_DATE) AND NOT EXISTS (SELECT SPEND_DATE, USER_ID, PLATFORM FROM SPENDING WHERE PLATFORM = 'desktop' AND S.USER_ID = USER_ID AND S.SPEND_DATE = SPEND_DATE) ), CTE2 AS ( SELECT SPEND_DATE, USER_ID, AMOUNT, 'desktop' AS PLATFORM FROM SPENDING S WHERE NOT EXISTS (SELECT SPEND_DATE, USER_ID, PLATFORM FROM SPENDING WHERE PLATFORM = 'mobile' AND S.USER_ID = USER_ID AND S.SPEND_DATE = SPEND_DATE) AND EXISTS (SELECT SPEND_DATE, USER_ID, PLATFORM FROM SPENDING WHERE PLATFORM = 'desktop' AND S.USER_ID = USER_ID AND S.SPEND_DATE = SPEND_DATE) ), CTE3 AS ( SELECT SPEND_DATE, USER_ID, AMOUNT, 'both' AS PLATFORM FROM SPENDING S WHERE EXISTS (SELECT SPEND_DATE, USER_ID, PLATFORM FROM SPENDING WHERE PLATFORM = 'mobile' AND S.USER_ID = USER_ID AND S.SPEND_DATE = SPEND_DATE) AND EXISTS (SELECT SPEND_DATE, USER_ID, PLATFORM FROM SPENDING WHERE PLATFORM = 'desktop' AND S.USER_ID = USER_ID AND S.SPEND_DATE = SPEND_DATE) ) SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) TOTAL_USERS FROM ( SELECT * FROM CTE1 UNION ALL SELECT * FROM CTE2 UNION ALL SELECT * FROM CTE3 UNION ALL SELECT SPEND_DATE, NULL, 0, 'mobile' FROM SPENDING UNION ALL SELECT SPEND_DATE, NULL, 0, 'desktop' FROM SPENDING UNION ALL SELECT SPEND_DATE, NULL, 0, 'both' FROM SPENDING ) TEMP GROUP BY 1, 2 ORDER BY PLATFORM, SPEND_DATE"
112,Y,N,"WITH CTE1 AS ( SELECT USER_ID, SPEND_DATE FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(DISTINCT PLATFORM) = 2), CTE2 AS( SELECT USER_ID, SPEND_DATE, 'BOTH AS PLATFORM', AMOUNT FROM SPENDING WHERE (USER_ID, SPEND_DATE) IN (SELECT * FROM CTE1) UNION ALL SELECT * FROM SPENDING WHERE (USER_ID, SPEND_DATE) NOT IN (SELECT * FROM CTE1)), CTE3 AS ( SELECT DISTINCT SPEND_DATE FROM SPENDING), CTE4 AS ( SELECT DESKTOP AS PLATFORM UNION ALL SELECT MOBILE AS PLATFORM UNION ALL SELECT BOTH AS PLATFORM ) SELECT SPEND_DATE, PLATFORM, COALESCE(SUM(AMOUNT),0) AS TOTAL_AMOUNT , COALESCE(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM CTE3 CROSS JOIN CTE4 LEFT JOIN CTE2 USING (SPEND_DATE, PLATFORM) GROUP BY SPEND_DATE, PLATFORM"
113,N,N,"WITH CTE1 AS( SELECT USER_ID, SPEND_DATE, COUNT(*) AS CNT, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2), CTE2 AS( SELECT USER_ID, SPEND_DATE, IF(CNT=2,'both',PLATFORM) AS PLATFORM, AMOUNT FROM CTE1), CTE AS( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM CTE A LEFT JOIN CTE2 B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY 1,2"
114,N,N,"WITH CTE1 AS( SELECT USER_ID, SPEND_DATE, COUNT(*) AS CNT, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2), CTE2 AS( SELECT USER_ID, SPEND_DATE, IF(CNT=2,'both',PLATFORM) AS PLATFORM, AMOUNT FROM CTE1), CTE AS( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM CTE A LEFT JOIN CTE2 B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY 1,2"
115,N,N,"WITH DATE_PLATFORM AS ( SELECT DISTINCT SPEND_DATE, 'MOBILE AS PLATFORM' FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'DESKTOP AS PLATFORM' FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'BOTH AS PLATFORM' FROM SPENDING ), SPENDING_PLATFORM AS ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT, CASE WHEN COUNT(PLATFORM) = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT SPEND_DATE, DATE_PLATFORM.PLATFORM, SUM(IFNULL(AMOUNT, 0)) AS TOTAL_AMOUNT , COUNT(USER_ID) AS TOTAL_USERS FROM DATE_PLATFORM LEFT JOIN SPENDING_PLATFORM USING(SPEND_DATE, PLATFORM) GROUP BY SPEND_DATE, PLATFORM"
116,Y,N,"WITH DATE_PLATFORM AS ( SELECT S.SPEND_DATE, P.PLATFORM FROM ( SELECT DISTINCT SPEND_DATE FROM SPENDING ) S, ( SELECT DISTINCT PLATFORM FROM SPENDING UNION SELECT BOTH AS PLATFORM ) P ), TMP1 AS ( SELECT DISTINCT T1.USER_ID, T1.SPEND_DATE, CASE WHEN T1.N_PLATFORM = 1 THEN S.PLATFORM ELSE BOTH END AS PLATFORM, T1.TOTAL_A FROM ( SELECT USER_ID, SPEND_DATE, COUNT(DISTINCT PLATFORM) AS N_PLATFORM, SUM(AMOUNT) AS TOTAL_A FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) T1 LEFT JOIN SPENDING S ON S.USER_ID = T1.USER_ID AND S.SPEND_DATE = T1.SPEND_DATE ), TMP2 AS ( SELECT SPEND_DATE, PLATFORM, COUNT(USER_ID) AS TOTAL_USERS, SUM(TOTAL_A) AS TOTAL_AMOUNT FROM TMP1 GROUP BY SPEND_DATE, PLATFORM ) SELECT DP.SPEND_DATE, DP.PLATFORM, COALESCE(TMP2.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(TMP2.TOTAL_USERS, 0) AS TOTAL_USERS FROM DATE_PLATFORM DP LEFT JOIN TMP2 ON TMP2.SPEND_DATE = DP.SPEND_DATE AND TMP2.PLATFORM = DP.PLATFORM"
117,Y,N,"WITH DATES AS ( SELECT DISTINCT SPEND_DATE FROM SPENDING ), PLATFORMS AS ( SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM ), DATE_PLATFORM AS ( SELECT SPEND_DATE, PLATFORM FROM DATES JOIN PLATFORMS ON 1=1 ), USER_DAILY AS ( SELECT SPEND_DATE , USER_ID , SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_SPEND , SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_SPEND FROM SPENDING GROUP BY 1,2 ), DAILY_DATA AS ( SELECT SPEND_DATE , USER_ID , MOBILE_SPEND + DESKTOP_SPEND AMOUNT , CASE WHEN MOBILE_SPEND > 0 AND DESKTOP_SPEND > 0 THEN BOTH WHEN MOBILE_SPEND > 0 AND DESKTOP_SPEND = 0 THEN MOBILE WHEN MOBILE_SPEND = 0 AND DESKTOP_SPEND > 0 THEN DESKTOP END AS PLATFORM FROM USER_DAILY ) SELECT DP.SPEND_DATE , DP.PLATFORM , SUM(COALESCE(AMOUNT,0)) TOTAL_AMOUNT , COUNT(DISTINCT USER_ID) TOTAL_USERS FROM DATE_PLATFORM DP LEFT JOIN DAILY_DATA DD ON DP.SPEND_DATE = DD.SPEND_DATE AND DP.PLATFORM = DD.PLATFORM GROUP BY 1,2 ORDER BY 1"
118,Y,N,"WITH DATES AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), USERS AS ( SELECT USER_ID, SPEND_DATE, MIN(PLATFORM) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) = 1 UNION ALL SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) = 2 ) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(SUM(B.TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT B.USER_ID) AS TOTAL_USERS FROM DATES A LEFT OUTER JOIN USERS B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY A.SPEND_DATE, A.PLATFORM ORDER BY SPEND_DATE"
119,Y,Y,"WITH DATES AS ( SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT DATES.SPEND_DATE, DATES.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM DATES LEFT JOIN ( SELECT USER_ID, SPEND_DATE, IF(MOBILE > 0, IF(DESKTOP > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE + DESKTOP) AMOUNT FROM ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) AS A ) AS B ON DATES.SPEND_DATE = B.SPEND_DATE AND DATES.PLATFORM = B.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
120,Y,N,"WITH DATES_PLATFORM AS (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), SPENDING_COUNT AS ( SELECT USER_ID, SPEND_DATE, IF(CNT=2, 'both',PLATFORM) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM (SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT, COUNT(1) OVER(PARTITION BY USER_ID, SPEND_DATE) AS CNT FROM SPENDING) T GROUP BY USER_ID, SPEND_DATE, IF(CNT=2, 'both',PLATFORM) ) SELECT T1.SPEND_DATE, T1.PLATFORM, SUM(IFNULL(TOTAL_AMOUNT,0)) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM DATES_PLATFORM T1 LEFT JOIN SPENDING_COUNT T2 ON T1.SPEND_DATE = T2.SPEND_DATE AND T1.PLATFORM = T2.PLATFORM GROUP BY T1.SPEND_DATE, T1.PLATFORM"
121,N,N,"WITH FULL_TB AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), FULL_TB2 AS ( SELECT SPEND_DATE, USER_ID, (CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT_USER FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT B.SPEND_DATE, B.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT_USER),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM FULL_TB2 A RIGHT JOIN FULL_TB B ON A.SPEND_DATE=B.SPEND_DATE AND A.PLATFORM=B.PLATFORM GROUP BY SPEND_DATE, PLATFORM ORDER BY SPEND_DATE"
122,N,N,"WITH HEADER AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT H.SPEND_DATE, H.PLATFORM, IFNULL(SUM(AMOUNT),0) TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM HEADER H LEFT JOIN ( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(*) = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING S GROUP BY SPEND_DATE, USER_ID ) A ON H.SPEND_DATE = A.SPEND_DATE AND H.PLATFORM = A.PLATFORM GROUP BY H.SPEND_DATE, H.PLATFORM"
123,Y,N,"WITH JOINED AS ( SELECT T1.USER_ID, T1.SPEND_DATE, CASE WHEN T2.PLATFORM IS NOT NULL THEN BOTH ELSE T1.PLATFORM END AS PLAT_FORM, T1.AMOUNT FROM SPENDING T1 LEFT JOIN SPENDING T2 ON T1.USER_ID = T2.USER_ID AND T1.SPEND_DATE = T2.SPEND_DATE AND T1.PLATFORM != T2.PLATFORM ), DATE_PLAT AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT T2.SPEND_DATE,T2.PLATFORM AS PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM JOINED T1 RIGHT JOIN DATE_PLAT T2 ON T1.SPEND_DATE = T2.SPEND_DATE AND T1.PLAT_FORM = T2.PLATFORM GROUP BY 1,2"
124,Y,Y,"WITH O AS ( SELECT SPEND_DATE, USER_ID, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ), P AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(AMOUNT), 0) TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM P LEFT JOIN ( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AMOUNT FROM O ) T ON P.PLATFORM=T.PLATFORM AND P.SPEND_DATE=T.SPEND_DATE GROUP BY SPEND_DATE, PLATFORM"
125,Y,N,"WITH PF AS ( SELECT DESKTOP AS PLATFORM UNION ALL SELECT MOBILE UNION ALL SELECT BOTH ) , DATEDIM AS ( SELECT D.SPEND_DATE, PF.PLATFORM FROM ( SELECT DISTINCT SPEND_DATE FROM SPENDING )D CROSS JOIN PF ) ,PREP AS ( SELECT USER_ID ,SPEND_DATE ,PLATFORM ,AMOUNT , COUNT(PLATFORM)OVER(PARTITION BY USER_ID, SPEND_DATE)NUM FROM SPENDING ) , UNIPLATFORM AS ( SELECT SPEND_DATE ,PLATFORM ,SUM(AMOUNT)TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) TOTAL_USERS FROM PREP WHERE NUM=1 GROUP BY SPEND_DATE, PLATFORM ) , DUALPLATFORM AS ( SELECT SPEND_DATE ,'both' PLATFORM ,SUM(AMOUNT)TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) TOTAL_USERS FROM PREP WHERE NUM>1 GROUP BY SPEND_DATE ) SELECT DATEDIM.SPEND_DATE ,DATEDIM.PLATFORM , COALESCE(U.TOTAL_AMOUNT, 0) TOTAL_AMOUNT , COALESCE(U.TOTAL_USERS,0) TOTAL_USERS FROM DATEDIM LEFT OUTER JOIN ( SELECT SPEND_DATE , PLATFORM ,TOTAL_AMOUNT ,TOTAL_USERS FROM UNIPLATFORM UNION ALL SELECT SPEND_DATE , PLATFORM ,TOTAL_AMOUNT ,TOTAL_USERS FROM DUALPLATFORM ) U ON U.SPEND_DATE=DATEDIM.SPEND_DATE AND U.PLATFORM=DATEDIM.PLATFORM ORDER BY 2, 1"
126,Y,N,"WITH PLATFORMS (PLATFORM) AS ( SELECT * FROM (VALUES ROW('desktop'), ROW('mobile'), ROW('both')) P ) , PLATFORM_COUNT AS (SELECT USER_ID, SPEND_DATE, COUNT(DISTINCT PLATFORM) AS COUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) , ENTRIES (SPEND_DATE, PLATFORM) AS ( SELECT DISTINCT SPEND_DATE, PLATFORMS.PLATFORM FROM SPENDING CROSS JOIN PLATFORMS ) , RESULTS AS (SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM PLATFORM_COUNT NATURAL JOIN SPENDING WHERE COUNT = 1 GROUP BY SPEND_DATE, PLATFORM UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM PLATFORM_COUNT NATURAL JOIN SPENDING WHERE COUNT = 2 GROUP BY SPEND_DATE ) SELECT SPEND_DATE, PLATFORM, IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM ENTRIES NATURAL LEFT JOIN RESULTS ORDER BY SPEND_DATE"
127,N,N,"WITH PLATFORMSTABLE AS( SELECT DISTINCT PLATFORM AS PLATFORM FROM SPENDING UNION SELECT BOTH AS PLATFORM), DATESTABLE AS( SELECT DISTINCT SPEND_DATE FROM SPENDING), FORMATTEDTABLE AS(SELECT * FROM DATESTABLE,PLATFORMSTABLE), SUMMARYTABLE AS(SELECT S1.USER_ID,S1.SPEND_DATE,S1.PLATFORM,COUNT(*) AS COUNTS,SUM(S1.AMOUNT) AS AMOUNT FROM SPENDING S1,SPENDING S2 WHERE S1.USER_ID=S2.USER_ID AND S1.SPEND_DATE=S2.SPEND_DATE GROUP BY 1,2), SUMMARYTABLE2 AS(SELECT SPEND_DATE,CASE WHEN COUNTS=1 THEN PLATFORM ELSE BOTH END AS PLATFORM2,CASE WHEN COUNTS=1 THEN AMOUNT ELSE AMOUNT/2 END AS AMOUNT2 FROM SUMMARYTABLE) SELECT F1.SPEND_DATE,F1.PLATFORM,SUM(COALESCE(AMOUNT2,0)) AS TOTAL_AMOUNT,COUNT(S1.SPEND_DATE) AS TOTAL_USERS FROM FORMATTEDTABLE F1 LEFT JOIN SUMMARYTABLE2 S1 ON F1.SPEND_DATE=S1.SPEND_DATE AND F1.PLATFORM=S1.PLATFORM2 GROUP BY 1,2"
128,Y,N,"WITH PLATFORMS_PER_USER AS ( SELECT USER_ID, SPEND_DATE, COUNT(1) AS TOTAL_PLATFORMS FROM SPENDING GROUP BY 1,2 ), ALL_COMBOS AS ( SELECT SPEND_DATE, PLATFORM FROM ( SELECT MOBILE AS PLATFORM UNION ALL SELECT DESKTOP AS PLATFORM UNION ALL SELECT BOTH AS PLATFORM ) F CROSS JOIN ( SELECT DISTINCT SPEND_DATE FROM SPENDING ) G ) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(TOTAL_USERS, 0) AS TOTAL_USERS FROM ALL_COMBOS A LEFT JOIN ( SELECT S.SPEND_DATE, IF(TOTAL_PLATFORMS = 2, 'both', PLATFORM) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS FROM SPENDING S JOIN PLATFORMS_PER_USER P ON P.USER_ID = S.USER_ID AND P.SPEND_DATE = S.SPEND_DATE GROUP BY 1, 2 ) G ON A.SPEND_DATE = G.SPEND_DATE AND A.PLATFORM = G.PLATFORM"
129,N,N,"WITH RES AS (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID,SPEND_DATE), COMB AS( SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING ) SELECT COMB.SPEND_DATE,COMB.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM COMB LEFT JOIN RES ON COMB.SPEND_DATE = RES.SPEND_DATE AND COMB.PLATFORM = RES.PLATFORM GROUP BY 1,2"
130,Y,N,"WITH T AS ( SELECT *, COUNT(PLATFORM) OVER(PARTITION BY SPEND_DATE, USER_ID) AS TYPE FROM SPENDING ) SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN TYPE=2 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT(CASE WHEN TYPE=2 THEN USER_ID ELSE NULL END)) AS TOTAL_USERS FROM T GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN TYPE=1 AND PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(CASE WHEN TYPE=1 AND PLATFORM='mobile'THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM T GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN TYPE=1 AND PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(CASE WHEN TYPE=1 AND PLATFORM='desktop'THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM T GROUP BY SPEND_DATE"
131,Y,N,"WITH T AS ( SELECT USER_ID,SPEND_DATE,AMOUNT, CASE WHEN PLATFORM = 'mobile' THEN 1 ELSE 0 END AS MOBILE, CASE WHEN PLATFORM = 'desktop' THEN 1 ELSE 0 END AS DESKTOP FROM SPENDING ), T1 AS ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT, CASE WHEN SUM(MOBILE) >= 1 AND SUM(DESKTOP) >= 1 THEN BOTH WHEN SUM(MOBILE) >= 1 AND SUM(DESKTOP) < 1 THEN MOBILE WHEN SUM(MOBILE) < 1 AND SUM(DESKTOP) >= 1 THEN DESKTOP END AS PLATFORM FROM T GROUP BY 1,2 ), P AS ( SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM T1 UNION ALL SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM T1 UNION ALL SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM T1 ) SELECT SDS.SPEND_DATE, SDS.PLATFORM, COALESCE(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T1 RIGHT JOIN P SDS ON T1.SPEND_DATE = SDS.SPEND_DATE AND SDS.PLATFORM = T1.PLATFORM GROUP BY 1,2 ORDER BY 1,2"
132,Y,Y,"WITH T AS (SELECT DISTINCT(SPEND_DATE),'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE),'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE),'both' AS PLATFORM FROM SPENDING) SELECT T.SPEND_DATE,T.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM T LEFT JOIN ( SELECT USER_ID,SPEND_DATE, IF(MOBILE>0,IF(DESKTOP>0,'both','mobile'),'desktop') AS PLATFORM, (MOBILE+DESKTOP) AS TOTAL_AMOUNT FROM ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP FROM SPENDING GROUP BY 1,2) T1)T3 ON T.PLATFORM = T3.PLATFORM AND T.SPEND_DATE = T3.SPEND_DATE GROUP BY T.SPEND_DATE,T.PLATFORM"
133,Y,Y,"WITH T AS (SELECT USER_ID , SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END )AS MOBILE , SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP FROM SPENDING GROUP BY USER_ID, SPEND_DATE), SP AS ( SELECT DISTINCT SPEND_DATE ,'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING), T2 AS (SELECT USER_ID, SPEND_DATE, IF(MOBILE >0, IF(DESKTOP >0, 'both','mobile'),'desktop') AS PLATFORM , MOBILE + DESKTOP AS AMOUNT FROM T) SELECT SP.SPEND_DATE, SP.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM SP LEFT JOIN T2 ON SP.SPEND_DATE = T2.SPEND_DATE AND SP.PLATFORM = T2.PLATFORM GROUP BY SP.SPEND_DATE, SP.PLATFORM"
134,N,N,"WITH T1 AS ( SELECT SPEND_DATE, PLATFORM, COUNT(DISTINCT USER_ID) AS TOTAL_USERS, SUM(AMOUNT) AS TOTAL_AMOUNT FROM ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT, CASE WHEN COUNT(DISTINCT PLATFORM) = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM FROM SPENDING GROUP BY USER_ID, SPEND_DATE) AS T0 GROUP BY SPEND_DATE, PLATFORM), T2 AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING) SELECT T2.*, IFNULL(T1.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(T1.TOTAL_USERS,0) AS TOTAL_USERS FROM T2 LEFT JOIN T1 ON T2.PLATFORM = T1.PLATFORM AND T2.SPEND_DATE = T1.SPEND_DATE"
135,N,N,"WITH T1 AS ( SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING ), T2 AS( SELECT USER_ID,SPEND_DATE, IF(COUNT(DISTINCT PLATFORM) = 2,'both',PLATFORM) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) SELECT T1.*,IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T1 LEFT JOIN T2 USING(SPEND_DATE,PLATFORM) GROUP BY 1,2"
136,N,N,"WITH T1 AS ( SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING ), T2 AS( SELECT USER_ID,SPEND_DATE, IF(COUNT(DISTINCT PLATFORM) = 2,'both',PLATFORM) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) SELECT T1.*,IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T1 LEFT JOIN T2 USING(SPEND_DATE,PLATFORM) GROUP BY 1,2"
137,N,N,"WITH T1 AS ( SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING ), T2 AS( SELECT USER_ID,SPEND_DATE, IF(COUNT(DISTINCT PLATFORM) = 2,'both',PLATFORM) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) SELECT T1.*,IFNULL(SUM(T2.AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T1 LEFT JOIN T2 USING(SPEND_DATE,PLATFORM) GROUP BY 1,2"
138,N,N,"WITH T1 AS ( SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING ), T2 AS( SELECT USER_ID,SPEND_DATE, IF(COUNT(DISTINCT PLATFORM) = 2,'both',PLATFORM) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) SELECT T1.*,IFNULL(SUM(T2.AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T1 LEFT JOIN T2 USING(SPEND_DATE,PLATFORM) GROUP BY 1,2 ORDER BY SPEND_DATE"
139,N,N,"WITH T1 AS (SELECT USER_ID, SPEND_DATE, (CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT_USER FROM SPENDING GROUP BY 1,2), T3 AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT T3.SPEND_DATE, T3.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT_USER),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T1 RIGHT JOIN T3 ON T1.SPEND_DATE=T3.SPEND_DATE AND T1.PLATFORM=T3.PLATFORM GROUP BY 1,2 ORDER BY 2"
140,N,N,"WITH T1 AS (SELECT USER_ID, SPEND_DATE, (CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2), T2 AS (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT T2.*, SUM(IFNULL(TOTAL_AMOUNT,0)) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T2 LEFT JOIN T1 ON T2.SPEND_DATE = T1.SPEND_DATE AND T1.PLATFORM = T2.PLATFORM GROUP BY 1,2 ORDER BY 1,2"
141,Y,N,"WITH T1 AS( SELECT NULL AS USER_ID, SPEND_DATE, PLATFORM, 0 AS AMOUNT FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING)T1 JOIN (SELECT * FROM( SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM)T2)T3), T2 AS( SELECT *, COUNT(PLATFORM) OVER (PARTITION BY SPEND_DATE, USER_ID) AS CNT FROM SPENDING), T3 AS( SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT FROM T2 WHERE CNT=1 AND PLATFORM = 'mobile' UNION SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT FROM T2 WHERE CNT=1 AND PLATFORM = 'desktop' UNION SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) FROM T2 WHERE CNT=2 GROUP BY USER_ID, SPEND_DATE UNION SELECT * FROM T1 ) SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T3 GROUP BY SPEND_DATE, PLATFORM"
142,N,N,"WITH TAB1 AS (SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2 HAVING COUNT(*) >1 UNION SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2 HAVING COUNT(*) =1) , TABLE_DATE AS (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) , TABLE_USEDATE AS ( SELECT SPEND_DATE,PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM TAB1 GROUP BY 1,2 ) SELECT T.SPEND_DATE,T.PLATFORM, IFNULL(TU.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TU.TOTAL_USERS,0) AS TOTAL_USERS FROM TABLE_DATE T LEFT JOIN TABLE_USEDATE AS TU ON T.SPEND_DATE=TU.SPEND_DATE AND T.PLATFORM=TU.PLATFORM ORDER BY SPEND_DATE"
143,N,N,"WITH TAB_USER_DAY_PLATFORM AS ( SELECT USER_ID, SPEND_DATE, PLATFORM FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) = 1 UNION SELECT USER_ID, SPEND_DATE, 'both' FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) > 1 ), TEMPLATE_TAB AS ( SELECT * FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING ) AS A JOIN ( SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM) AS B ), TAB_PREP AS (SELECT T.SPEND_DATE, T.PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT T.USER_ID) AS TOTAL_USERS FROM TAB_USER_DAY_PLATFORM AS T JOIN SPENDING ON T.USER_ID = SPENDING.USER_ID AND T.SPEND_DATE = SPENDING.SPEND_DATE GROUP BY T.SPEND_DATE, T.PLATFORM) SELECT TEMPLATE_TAB.SPEND_DATE, TEMPLATE_TAB.PLATFORM, IFNULL(TAB_PREP.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TAB_PREP.TOTAL_USERS, 0) AS TOTAL_USERS FROM TEMPLATE_TAB LEFT JOIN TAB_PREP ON TEMPLATE_TAB.SPEND_DATE = TAB_PREP.SPEND_DATE AND TEMPLATE_TAB.PLATFORM = TAB_PREP.PLATFORM"
144,Y,N,"WITH TBALL AS ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT, CASE WHEN SUM(PLATFORM = 'mobile')=0 THEN 1 ELSE 0 END AS DESKTOP, CASE WHEN SUM(PLATFORM = 'desktop')=0 THEN 1 ELSE 0 END AS MOBILE, CASE WHEN SUM(PLATFORM = 'mobile')=0 OR SUM(PLATFORM = 'desktop')=0 THEN 0 ELSE 1 END AS BOTH FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(AMOUNT * MOBILE) AS TOTAL_AMOUNT, SUM(MOBILE) AS TOTAL_USERS FROM TBALL GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(AMOUNT * DESKTOP) AS TOTAL_AMOUNT, SUM(DESKTOP) AS TOTAL_USERS FROM TBALL GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT * BOTH ) AS TOTAL_AMOUNT, SUM( BOTH ) AS TOTAL_USERS FROM TBALL GROUP BY 1"
145,Y,N,"WITH TEM AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DA, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MA FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN DA > 0 AND MA = 0 THEN DA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN DA > 0 AND MA = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEM GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MA > 0 AND DA = 0 THEN MA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MA > 0 AND DA = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEM GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN MA > 0 AND DA > 0 THEN MA+DA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MA > 0 AND DA > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEM GROUP BY SPEND_DATE"
146,N,N,"WITH TEMP AS ( SELECT S1.SPEND_DATE , S1.USER_ID , S2.AMOUNT , CASE WHEN NUM_P=2 THEN BOTH WHEN NUM_P=1 THEN S2.PLATFORM END AS PLATFORM FROM( (SELECT *, COUNT(DISTINCT PLATFORM) AS NUM_P FROM SPENDING GROUP BY SPEND_DATE, USER_ID) AS S1 RIGHT JOIN SPENDING AS S2 ON S1.SPEND_DATE=S2.SPEND_DATE AND S1.USER_ID=S2.USER_ID)) SELECT T2.SPEND_DATE , T2.PLATFORM , IF(T1.TOTAL_AMOUNT IS NULL, 0, T1.TOTAL_AMOUNT) AS TOTAL_AMOUNT , IF(T1.TOTAL_USERS IS NULL, 0, T1.TOTAL_USERS) AS TOTAL_USERS FROM ( SELECT SPEND_DATE , PLATFORM , SUM(AMOUNT) AS TOTAL_AMOUNT , COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE, PLATFORM ORDER BY PLATFORM, SPEND_DATE) AS T1 RIGHT JOIN ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) AS T2 ON T1.SPEND_DATE = T2.SPEND_DATE AND T1.PLATFORM = T2.PLATFORM"
147,Y,N,"WITH TEMP AS (SELECT *, COUNT(USER_ID) OVER(PARTITION BY SPEND_DATE, USER_ID) AS TYPE FROM SPENDING ) SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN TYPE = 2 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN TYPE = 2 THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE UNION (SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN TYPE = 1 AND PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN TYPE = 1 AND PLATFORM = 'desktop' THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE) UNION (SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN TYPE = 1 AND PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN TYPE = 1 AND PLATFORM = 'mobile' THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE)"
148,N,N,"WITH TEMP1 AS( SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2,3), A AS( SELECT SPEND_DATE, COUNT(DISTINCT USER_ID)AS TOTAL_USERS, SUM(AMOUNT) AS TOTAL_AMOUNT FROM( SELECT SPEND_DATE, USER_ID, SUM(AMOUNT) AS AMOUNT FROM TEMP1 GROUP BY 1, 2 HAVING COUNT(PLATFORM)>=2) AS TEMP1 GROUP BY SPEND_DATE), B AS( SELECT DISTINCT SPEND_DATE FROM SPENDING ORDER BY SPEND_DATE), SALE_BOTH AS( SELECT B.SPEND_DATE, 'both' AS PLATFORM, IFNULL(A.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(A.TOTAL_USERS,0) AS TOTAL_USERS FROM B LEFT JOIN A ON B.SPEND_DATE=A.SPEND_DATE), TEMP2 AS( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM( SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM TEMP1 GROUP BY 1, 2 HAVING COUNT(PLATFORM)=1) AS TEMP2 WHERE PLATFORM='mobile' GROUP BY 1,2), SALE_MOBILE AS( SELECT B.SPEND_DATE, 'mobile' AS PLATFORM, IFNULL(TEMP2.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TEMP2.TOTAL_USERS,0) AS TOTAL_USERS FROM B LEFT JOIN TEMP2 ON B.SPEND_DATE=TEMP2.SPEND_DATE), TEMP3 AS( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM( SELECT USER_ID, SPEND_DATE, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM TEMP1 GROUP BY 1, 2 HAVING COUNT(PLATFORM)=1) AS TEMP2 WHERE PLATFORM='desktop' GROUP BY 1,2), SALE_DESKTOP AS( SELECT B.SPEND_DATE, 'desktop' AS PLATFORM, IFNULL(TEMP3.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TEMP3.TOTAL_USERS,0) AS TOTAL_USERS FROM B LEFT JOIN TEMP3 ON B.SPEND_DATE=TEMP3.SPEND_DATE) SELECT * FROM SALE_BOTH UNION ALL SELECT * FROM SALE_MOBILE UNION ALL SELECT * FROM SALE_DESKTOP ORDER BY 1"
149,Y,N,"WITH TEMP_TABLE AS ( SELECT SPEND_DATE FROM SPENDING GROUP BY SPEND_DATE ) SELECT T3.SPEND_DATE, T3.PLATFORM, COALESCE(TOTAL_AMOUNT, 0) TOTAL_AMOUNT, COALESCE(TOTAL_USERS, 0) TOTAL_USERS FROM ( SELECT SPEND_DATE, 'mobile' PLATFORM FROM TEMP_TABLE UNION SELECT SPEND_DATE, 'desktop' PLATFORM FROM TEMP_TABLE UNION SELECT SPEND_DATE, 'both' PLATFORM FROM TEMP_TABLE ) T3 LEFT OUTER JOIN ( SELECT SPEND_DATE, CASE WHEN USE_MOBILE=1 AND USE_DESKTOP=1 THEN BOTH WHEN USE_MOBILE=1 THEN MOBILE ELSE DESKTOP END PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) TOTAL_USERS FROM ( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM='mobile' THEN 1 ELSE 0 END) USE_MOBILE, SUM(CASE WHEN PLATFORM='desktop' THEN 1 ELSE 0 END) USE_DESKTOP, SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) T1 GROUP BY SPEND_DATE, CASE WHEN USE_MOBILE=1 AND USE_DESKTOP=1 THEN BOTH WHEN USE_MOBILE=1 THEN MOBILE ELSE DESKTOP END ) T2 ON T3.SPEND_DATE=T2.SPEND_DATE AND T3.PLATFORM = T2.PLATFORM ORDER BY TOTAL_AMOUNT, PLATFORM"
150,N,N,"WITH TMP AS ( SELECT SPEND_DATE, PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) T1 CROSS JOIN (SELECT DISTINCT PLATFORM FROM SPENDING UNION ALL SELECT BOTH AS PLATFORM) T2 ) SELECT TMP.SPEND_DATE, TMP.PLATFORM, SUM(IFNULL(AMOUNT, 0)) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID), 0) AS TOTAL_USERS FROM (SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(PLATFORM) = 1 THEN PLATFORM WHEN COUNT(PLATFORM) = 2 THEN BOTH END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) T RIGHT JOIN TMP ON TMP.SPEND_DATE = T.SPEND_DATE AND TMP.PLATFORM = T.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
151,Y,N,"WITH TMP AS ( SELECT USER_ID, SPEND_DATE, AMOUNT, SUM(IF(PLATFORM='mobile',1,0)) OVER(PARTITION BY USER_ID, SPEND_DATE) AS MOBILE, SUM(IF(PLATFORM='desktop',1,0)) OVER(PARTITION BY USER_ID, SPEND_DATE) AS DESKTOP FROM SPENDING ), TMP2 AS ( SELECT *, CASE WHEN MOBILE = 1 AND DESKTOP = 1 THEN BOTH WHEN MOBILE = 1 AND DESKTOP = 0 THEN MOBILE ELSE DESKTOP END AS PLATFORM FROM TMP ),SPINE AS ( SELECT DISTINCT TMP2.SPEND_DATE, TMP3.PLATFORM FROM TMP2, ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) AS TMP3 ) SELECT SPINE.SPEND_DATE, SPINE.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM SPINE LEFT JOIN TMP2 ON SPINE.SPEND_DATE = TMP2.SPEND_DATE AND SPINE.PLATFORM = TMP2.PLATFORM GROUP BY SPINE.SPEND_DATE, SPINE.PLATFORM"
152,Y,N,"WITH TMP AS (SELECT SPEND_DATE, USER_ID, MIN(PLATFORM) AS PLATFORM, COUNT(PLATFORM) AS CNT, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID), DATES AS (SELECT DISTINCT SPEND_DATE FROM SPENDING) SELECT DATES.SPEND_DATE, 'both' AS PLATFORM, SUM(IFNULL(AMOUNT, 0)) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM DATES LEFT JOIN TMP ON DATES.SPEND_DATE = TMP.SPEND_DATE AND CNT = 2 GROUP BY DATES.SPEND_DATE UNION SELECT DATES.SPEND_DATE, 'desktop' AS PLATFORM, SUM(IFNULL(AMOUNT, 0)) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM DATES LEFT JOIN TMP ON DATES.SPEND_DATE = TMP.SPEND_DATE AND PLATFORM = 'desktop' AND CNT = 1 GROUP BY DATES.SPEND_DATE UNION SELECT DATES.SPEND_DATE, 'mobile' AS PLATFORM, SUM(IFNULL(AMOUNT, 0)) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM DATES LEFT JOIN TMP ON DATES.SPEND_DATE = TMP.SPEND_DATE AND PLATFORM = 'mobile' AND CNT = 1 GROUP BY DATES.SPEND_DATE"
153,Y,N,"WITH TMP AS( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(*) > 1 ), TMP2 AS( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM SPENDING WHERE (USER_ID, SPEND_DATE) NOT IN (SELECT USER_ID, SPEND_DATE FROM TMP) GROUP BY SPEND_DATE, PLATFORM UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM TMP GROUP BY SPEND_DATE ), TMP3 AS ( SELECT * FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) A, (SELECT DISTINCT PLATFORM FROM SPENDING UNION SELECT BOTH AS PLATFORM) B ) SELECT SPEND_DATE, PLATFORM, IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM TMP3 NATURAL LEFT JOIN TMP2"
154,N,N,"WITH USER_PLATFORM AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM_NEW, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2 ), REPORT_PLATFORM AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT REPORT_PLATFORM.SPEND_DATE AS SPEND_DATE, REPORT_PLATFORM.PLATFORM AS PLATFORM, COALESCE(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COALESCE(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM REPORT_PLATFORM LEFT JOIN USER_PLATFORM ON REPORT_PLATFORM.PLATFORM = USER_PLATFORM.PLATFORM_NEW AND REPORT_PLATFORM.SPEND_DATE = USER_PLATFORM.SPEND_DATE GROUP BY 1,2"
155,Y,N,"WITH WRAPPER AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ORDER BY 1 ), USER_COUNTS AS ( SELECT DISTINCT *, COUNT(*) OVER (PARTITION BY SPEND_DATE, USER_ID)N_USERS FROM SPENDING ), PLATFORM_BOTH_ AS ( SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT)TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM USER_COUNTS WHERE N_USERS = 2 GROUP BY 1 ), PLATFORM_SINGLES AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT)TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM USER_COUNTS WHERE N_USERS = 1 GROUP BY 1,2 ) SELECT W.SPEND_DATE, W.PLATFORM, IFNULL(U.TOTAL_AMOUNT,0)TOTAL_AMOUNT, IFNULL(U.TOTAL_USERS,0) TOTAL_USERS FROM WRAPPER W LEFT JOIN (SELECT * FROM PLATFORM_BOTH_ UNION SELECT * FROM PLATFORM_SINGLES)U ON W.SPEND_DATE = U.SPEND_DATE AND W.PLATFORM = U.PLATFORM;"
156,Y,N,"WITH X AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT * FROM ( SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT = 0 THEN MOBILE_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM X GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT = 0 AND DESKTOP_AMOUNT > 0 THEN DESKTOP_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT = 0 AND DESKTOP_AMOUNT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM X GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT > 0 THEN MOBILE_AMOUNT+DESKTOP_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM X GROUP BY SPEND_DATE ) A"
157,Y,N,"WITH X AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT * FROM ( SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT = 0 THEN MOBILE_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM X GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT = 0 AND DESKTOP_AMOUNT > 0 THEN DESKTOP_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT = 0 AND DESKTOP_AMOUNT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM X GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT > 0 THEN MOBILE_AMOUNT+DESKTOP_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM X GROUP BY SPEND_DATE ) A ORDER BY SPEND_DATE, CASE WHEN PLATFORM = 'desktop' THEN 1 WHEN PLATFORM = 'mobile' THEN 2 ELSE 3 END"
158,Y,N,"WITH CTE1 AS (SELECT SPEND_DATE, USER_ID FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(*) = 1), CTE2 AS (SELECT SPEND_DATE, USER_ID FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(*) = 2), CTE3 AS (SELECT DISTINCT SPEND_DATE, SUB.* FROM SPENDING CROSS JOIN (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) SUB) SELECT CTE3.*, COALESCE(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(TOTAL_USERS, 0) AS TOTAL_USERS FROM CTE3 LEFT JOIN (SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM SPENDING WHERE PLATFORM = 'desktop' AND (SPEND_DATE, USER_ID) IN (SELECT * FROM CTE1) GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM SPENDING WHERE PLATFORM = 'mobile' AND (SPEND_DATE, USER_ID) IN (SELECT * FROM CTE1) GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM SPENDING WHERE (SPEND_DATE, USER_ID) IN (SELECT * FROM CTE2) GROUP BY SPEND_DATE) SUB ON CTE3.SPEND_DATE = SUB.SPEND_DATE AND CTE3.PLATFORM = SUB.PLATFORM"
159,Y,N,"WITH P AS ( SELECT A.SPEND_DATE, P.PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) A JOIN ( SELECT MOBILE PLATFORM UNION SELECT BOTH PLATFORM UNION SELECT DESKTOP PLATFORM ) P ON 1 ) SELECT P.*, COALESCE(SUM(AMOUNT), 0) TOTAL_AMOUNT, COALESCE(COUNT(DISTINCT USER_ID),0) TOTAL_USERS FROM P LEFT JOIN ( SELECT SPEND_DATE, CASE WHEN COUNT(PLATFORM) OVER(PARTITION BY USER_ID, SPEND_DATE) = 2 THEN BOTH ELSE PLATFORM END PLATFORM, AMOUNT, USER_ID FROM SPENDING) A ON P.SPEND_DATE = A.SPEND_DATE AND P.PLATFORM = A.PLATFORM GROUP BY P.SPEND_DATE, P.PLATFORM"
160,Y,N,"WITH TMP1 AS (SELECT SPEND_DATE, USER_ID, CASE WHEN GROUP_CONCAT(PLATFORM) = 'MOBILE THEN MOBILE' WHEN GROUP_CONCAT(PLATFORM) = 'DESKTOP THEN DESKTOP ELSE BOTH' END AS PLATFORM, SUM(AMOUNT) TOTAL1 FROM SPENDING GROUP BY SPEND_DATE, USER_ID), TMP2 AS (SELECT BOTH PLATFORM UNION SELECT MOBILE PLATFORM UNION SELECT DESKTOP PLATFORM), TMP3 AS (SELECT DISTINCT SPENDING.SPEND_DATE, TMP2.PLATFORM FROM SPENDING, TMP2), TMP4 AS (SELECT SPEND_DATE, PLATFORM, SUM(TOTAL1) TOTAL_AMOUNT1, COUNT(1) TOTAL_USERS1 FROM TMP1 GROUP BY SPEND_DATE, PLATFORM) SELECT T3.SPEND_DATE, T3.PLATFORM, COALESCE(TOTAL_AMOUNT1, 0) TOTAL_AMOUNT, COALESCE(TOTAL_USERS1, 0) TOTAL_USERS FROM TMP3 T3 LEFT JOIN TMP4 T4 ON T3.SPEND_DATE = T4.SPEND_DATE AND T3.PLATFORM = T4.PLATFORM"
161,Y,N,"WITH CTE AS (SELECT SPEND_DATE, USER_ID, SUM(IF(PLATFORM='mobile',AMOUNT,0)) AS MOBILE, SUM(IF(PLATFORM='desktop',AMOUNT,0)) AS DESKTOP FROM SPENDING GROUP BY SPEND_DATE, USER_ID) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(IF(MOBILE=0 AND DESKTOP>0,DESKTOP,0)) AS TOTAL_AMOUNT, SUM(IF(MOBILE=0 AND DESKTOP>0,1,0)) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(IF(MOBILE>0 AND DESKTOP=0,MOBILE,0)) AS TOTAL_AMOUNT, SUM(IF(MOBILE>0 AND DESKTOP=0,1,0)) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(IF(MOBILE>0 AND DESKTOP>0,MOBILE+DESKTOP,0)) AS TOTAL_AMOUNT, SUM(IF(MOBILE>0 AND DESKTOP>0,1,0)) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE"
162,Y,N,"WITH A AS(SELECT USER_ID, SPEND_DATE, AMOUNT , CASE WHEN (RANK() OVER(PARTITION BY USER_ID, SPEND_DATE ORDER BY PLATFORM ASC)!= RANK() OVER(PARTITION BY USER_ID, SPEND_DATE ORDER BY PLATFORM DESC)) THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING) ,B AS( SELECT SPEND_DATE, PLATFORM , SUM(AMOUNT) AS TOTAL_AMOUNT , COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM A GROUP BY 1,2) , T2 AS( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM) SELECT T4.*, COALESCE(T3.TOTAL_AMOUNT,0)AS TOTAL_AMOUNT, COALESCE(T3.TOTAL_USERS,0)AS TOTAL_USERS FROM (SELECT T1.SPEND_DATE, T2.PLATFORM FROM B T1, T2 GROUP BY 1,2) T4 LEFT JOIN B T3 ON T4.SPEND_DATE=T3.SPEND_DATE AND T4.PLATFORM=T3.PLATFORM"
163,Y,N,"WITH BASE AS ( SELECT S.SPEND_DATE,S.USER_ID,S.AMOUNT, CASE WHEN S.PLATFORM ='mobile' AND SS.PLATFORM='desktop' THEN BOTH WHEN S.PLATFORM ='desktop' AND SS.PLATFORM='mobile' THEN BOTH WHEN COALESCE(S.PLATFORM,SS.PLATFORM)='mobile' THEN MOBILE ELSE DESKTOP END AS PLATFORM FROM SPENDING S LEFT JOIN SPENDING SS ON S.SPEND_DATE=SS.SPEND_DATE AND S.USER_ID=SS.USER_ID AND S.PLATFORM<>SS.PLATFORM ) , PLT_LIST AS ( SELECT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE,'both' AS PLATFORM FROM SPENDING ) SELECT PL.SPEND_DATE,PL.PLATFORM, COALESCE(SUM(B.AMOUNT),0) AS TOTAL_AMOUNT,COUNT(DISTINCT B.USER_ID) AS TOTAL_USERS FROM PLT_LIST PL LEFT JOIN BASE B ON PL.PLATFORM=B.PLATFORM AND PL.SPEND_DATE=B.SPEND_DATE GROUP BY 1,2"
164,N,N,"WITH ETC AS (SELECT DISTINCT S.SPEND_DATE, P.PLATFORM FROM SPENDING AS S CROSS JOIN (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM) AS P) SELECT E.SPEND_DATE, E.PLATFORM, COALESCE(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COALESCE(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM ETC AS E LEFT JOIN (SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(PLATFORM)= 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING AS S2 GROUP BY SPEND_DATE, USER_ID) AS S3 ON E.SPEND_DATE = S3.SPEND_DATE AND E.PLATFORM = S3.PLATFORM GROUP BY E.SPEND_DATE, E.PLATFORM"
165,Y,N,"WITH CTE AS ( SELECT DISTINCT USER_ID ,SPEND_DATE ,COUNT(*) CT FROM SPENDING GROUP BY 1,2 ), CALENDER AS ( SELECT DISTINCT SPEND_DATE FROM SPENDING ) SELECT T3.SPEND_DATE ,'desktop' AS PLATFORM ,IFNULL(TOTAL_AMOUNT,0) TOTAL_AMOUNT ,IFNULL(TOTAL_USERS,0) TOTAL_USERS FROM CALENDER T3 LEFT JOIN ( SELECT T1.SPEND_DATE ,T1.PLATFORM ,SUM(T1.AMOUNT) TOTAL_AMOUNT ,COUNT( DISTINCT T1.USER_ID) TOTAL_USERS FROM SPENDING T1 JOIN CTE T2 ON T1.USER_ID = T2.USER_ID AND T1.SPEND_DATE = T2.SPEND_DATE WHERE T2.CT = 1 AND T1.PLATFORM = 'desktop' GROUP BY 1,2 ) T4 ON T3.SPEND_DATE = T4.SPEND_DATE UNION ALL SELECT T3.SPEND_DATE ,'mobile' AS PLATFORM ,IFNULL(TOTAL_AMOUNT,0) TOTAL_AMOUNT ,IFNULL(TOTAL_USERS,0) TOTAL_USERS FROM CALENDER T3 LEFT JOIN ( SELECT T1.SPEND_DATE ,T1.PLATFORM ,SUM(T1.AMOUNT) TOTAL_AMOUNT ,COUNT( DISTINCT T1.USER_ID) TOTAL_USERS FROM SPENDING T1 JOIN CTE T2 ON T1.USER_ID = T2.USER_ID AND T1.SPEND_DATE = T2.SPEND_DATE WHERE T2.CT = 1 AND T1.PLATFORM = 'mobile' GROUP BY 1,2 ) T4 ON T3.SPEND_DATE = T4.SPEND_DATE UNION ALL SELECT T3.SPEND_DATE ,'both' AS PLATFORM ,IFNULL(TOTAL_AMOUNT,0) TOTAL_AMOUNT ,IFNULL(TOTAL_USERS,0) TOTAL_USERS FROM CALENDER T3 LEFT JOIN ( SELECT T1.SPEND_DATE ,SUM(T1.AMOUNT) TOTAL_AMOUNT ,COUNT(DISTINCT T1.USER_ID) TOTAL_USERS FROM SPENDING T1 JOIN CTE T2 ON T1.USER_ID = T2.USER_ID AND T1.SPEND_DATE = T2.SPEND_DATE WHERE T2.CT = 2 GROUP BY 1 ) T4 ON T3.SPEND_DATE = T4.SPEND_DATE"
166,Y,N,"WITH TABLE_STRUCTURE AS ( SELECT SPEND_DATE, PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) T1 ,(SELECT DESKTOP AS PLATFORM UNION ALL SELECT MOBILE AS PLATFORM UNION ALL SELECT BOTH AS PLATFORM) T2 ) ,USED_BOTH AS ( SELECT USER_ID, SPEND_DATE FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(*) = 2 ) ,SPEND_BOTH AS ( SELECT SPEND_DATE, 'both' PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT, COUNT(DISTINCT(USER_ID)) TOTAL_USERS FROM SPENDING WHERE (USER_ID, SPEND_DATE) IN (SELECT * FROM USED_BOTH) GROUP BY SPEND_DATE ) , SPEND_ONE AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT, COUNT(DISTINCT(USER_ID)) TOTAL_USERS FROM SPENDING WHERE (USER_ID, SPEND_DATE) NOT IN (SELECT * FROM USED_BOTH) GROUP BY SPEND_DATE, PLATFORM ) SELECT SPEND_DATE, IFNULL(PLATFORM,'both') PLATFORM, IFNULL(TOTAL_AMOUNT,0) TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) TOTAL_USERS FROM TABLE_STRUCTURE LEFT JOIN ( SELECT * FROM SPEND_BOTH UNION ALL SELECT * FROM SPEND_ONE ) T1 USING(SPEND_DATE, PLATFORM)"
167,Y,N,"WITH USER_CATEGORY AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) > 1 THEN BOTH ELSE MIN(PLATFORM) END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), DATE_TABLE AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) SELECT D.SPEND_DATE, D.PLATFORM, IFNULL(SUM(U.AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(U.USER_ID),0) AS TOTAL_USERS FROM DATE_TABLE D LEFT JOIN USER_CATEGORY U ON D.SPEND_DATE = U.SPEND_DATE AND U.PLATFORM = D.PLATFORM GROUP BY D.SPEND_DATE, D.PLATFORM"
168,Y,N,"WITH T AS ( SELECT S.SPEND_DATE, S.PLATFORM, SUM(S.AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM SPENDING S WHERE S.PLATFORM = 'desktop' AND NOT EXISTS ( SELECT 1 FROM SPENDING S1 WHERE S.USER_ID = S1.USER_ID AND S.SPEND_DATE = S1.SPEND_DATE AND S1.PLATFORM = 'mobile') GROUP BY 1, 2 UNION ALL SELECT S.SPEND_DATE, S.PLATFORM, SUM(S.AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM SPENDING S WHERE S.PLATFORM = 'mobile' AND NOT EXISTS ( SELECT 1 FROM SPENDING S1 WHERE S.USER_ID = S1.USER_ID AND S.SPEND_DATE = S1.SPEND_DATE AND S1.PLATFORM = 'desktop') GROUP BY 1, 2 UNION ALL SELECT S.SPEND_DATE, 'both' AS PLATFORM, SUM(S.AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS FROM SPENDING S WHERE S.PLATFORM IN ( 'mobile', 'desktop') AND EXISTS ( SELECT 1 FROM SPENDING S1 WHERE S.USER_ID = S1.USER_ID AND S.SPEND_DATE = S1.SPEND_DATE AND S.PLATFORM != S1.PLATFORM ) GROUP BY 1, 2 ), T1 AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING ) SELECT T1.SPEND_DATE, T1.PLATFORM, IFNULL(T.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(T.TOTAL_USERS, 0) AS TOTAL_USERS FROM T1 LEFT OUTER JOIN T ON T1.SPEND_DATE = T.SPEND_DATE AND T1.PLATFORM = T.PLATFORM"
169,Y,N,"WITH TEMPLATE AS ( SELECT S.SPEND_DATE, P.PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) S, (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) P ), ADHOC_SPENDING AS ( SELECT USER_ID, SPEND_DATE, AMOUNT, CASE WHEN DENSE_RANK() OVER(PARTITION BY USER_ID, SPEND_DATE ORDER BY PLATFORM) + DENSE_RANK() OVER(PARTITION BY USER_ID, SPEND_DATE ORDER BY PLATFORM DESC) - 1 = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING ) SELECT T.SPEND_DATE, T.PLATFORM, IFNULL(SUM(S.AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS FROM TEMPLATE T LEFT JOIN ADHOC_SPENDING S ON T.SPEND_DATE = S.SPEND_DATE AND T.PLATFORM = S.PLATFORM GROUP BY T.SPEND_DATE, T.PLATFORM ORDER BY T.SPEND_DATE, T.PLATFORM"
170,Y,N,"WITH T_SPLIT AS( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT END) AS DESKTOP_AMOUNT, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT END) AS MOBILE_AMOUNT FROM SPENDING GROUP BY 1,2 ), T_GRP AS( SELECT SPEND_DATE, CASE WHEN DESKTOP_AMOUNT IS NOT NULL AND MOBILE_AMOUNT IS NOT NULL THEN BOTH WHEN DESKTOP_AMOUNT IS NULL THEN MOBILE ELSE DESKTOP END AS PLATFORM, SUM(IFNULL(DESKTOP_AMOUNT,0) + IFNULL(MOBILE_AMOUNT,0))AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T_SPLIT GROUP BY 1,2 ), T_MAIN AS( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT TM.SPEND_DATE, TM.PLATFORM, CASE WHEN TG.TOTAL_AMOUNT IS NULL THEN 0 ELSE TG.TOTAL_AMOUNT END AS TOTAL_AMOUNT, CASE WHEN TG.TOTAL_USERS IS NULL THEN 0 ELSE TG.TOTAL_USERS END AS TOTAL_USERS FROM T_MAIN TM LEFT JOIN T_GRP TG ON TM.SPEND_DATE = TG.SPEND_DATE AND TM.PLATFORM = TG.PLATFORM"
171,N,N,"WITH CTE1 AS (SELECT USER_ID, SPEND_DATE, IF(COUNT(DISTINCT PLATFORM)=1,PLATFORM,'both') AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE), CTE2 AS (SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM CTE1 GROUP BY SPEND_DATE, PLATFORM), CTE3 AS (SELECT SPEND_DATE, PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) T1 CROSS JOIN (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM) T2) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM CTE3 A LEFT JOIN CTE2 B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM=B.PLATFORM"
172,Y,N,"SELECT SPEND_DATE, PLATFORM, IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) A1 LEFT JOIN (SELECT SPEND_DATE, PLATFORM_REQUIRED AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT *, CASE WHEN NUM_PLATFORM = 2 THEN BOTH WHEN NUM_PLATFORM = 1 AND PLATFORM = 'MOBILE THEN MOBILE' WHEN NUM_PLATFORM = 1 AND PLATFORM = 'DESKTOP THEN DESKTOP' END AS PLATFORM_REQUIRED FROM SPENDING LEFT JOIN (SELECT USER_ID, SPEND_DATE, COUNT(DISTINCT PLATFORM) AS NUM_PLATFORM FROM SPENDING GROUP BY USER_ID, SPEND_DATE) TEMP USING(USER_ID, SPEND_DATE)) TEMP GROUP BY SPEND_DATE, PLATFORM_REQUIRED) A2 USING(SPEND_DATE, PLATFORM)"
173,Y,N,"WITH DAT AS ( SELECT SPEND_DATE, CASE WHEN PLATFORM_CT = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT USER_ID, SPEND_DATE,PLATFORM,AMOUNT, COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) AS PLATFORM_CT FROM SPENDING ) A GROUP BY 1, 2 ), XREF AS ( SELECT A.SPEND_DATE, B.PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM DAT) A CROSS JOIN (SELECT BOTH AS PLATFORM UNION SELECT MOBILE UNION SELECT DESKTOP ) B ) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(B.TOTAL_USERS,0) AS TOTAL_USERS FROM XREF A LEFT JOIN DAT B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM"
174,Y,Y,"SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(B.TOTAL_USERS,0) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) A LEFT JOIN ( SELECT SPEND_DATE, IF( MOBILE_AMOUNT>0, IF( DESKTOP_AMOUNT>0, 'both', 'mobile' ), 'desktop' ) AS PLATFORM, SUM(MOBILE_AMOUNT+DESKTOP_AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY 1,2 ) X GROUP BY 1,2 ) B ON ( A.SPEND_DATE=B.SPEND_DATE AND A.PLATFORM=B.PLATFORM )"
175,Y,N,"WITH CTE1 AS ( SELECT DISTINCT SPEND_DATE AS SPEND_DATE FROM SPENDING) ,CTE2 AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM ) ,CTE3 AS (SELECT SPEND_DATE, PLATFORM FROM CTE1, CTE2) ,CTE4 AS (SELECT * ,COUNT(PLATFORM) OVER(PARTITION BY USER_ID, SPEND_DATE) AS CNT ,CASE WHEN COUNT(PLATFORM) OVER(PARTITION BY USER_ID, SPEND_DATE) = 2 THEN BOTH ELSE PLATFORM END AS CATEGORY FROM SPENDING ) ,CTE5 AS ( SELECT SPEND_DATE ,CATEGORY ,SUM(AMOUNT) AS TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE4 GROUP BY SPEND_DATE,CATEGORY) SELECT CTE3.SPEND_DATE ,CTE3.PLATFORM ,IFNULL(CTE5.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT ,IFNULL(CTE5.TOTAL_USERS,0) AS TOTAL_USERS FROM CTE3 LEFT JOIN CTE5 ON CTE3.SPEND_DATE = CTE5.SPEND_DATE AND CTE3.PLATFORM = CTE5.CATEGORY"
176,N,N,"SELECT X.SPEND_DATE, X.PLATFORM, IFNULL(SUM(Y.TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(Y.USER_ID),0) AS TOTAL_USERS FROM ( SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) X LEFT JOIN ( SELECT SPEND_DATE, USER_ID, IF(COUNT(PLATFORM)=2, 'both', PLATFORM) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1, 2 ) Y ON X.SPEND_DATE = Y.SPEND_DATE AND X.PLATFORM = Y.PLATFORM GROUP BY 1, 2"
177,N,N,"WITH GET_DAILY_TOTAL AS ( SELECT USER_ID , SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS DAILY_TOTAL FROM SPENDING GROUP BY 1,2 ), GET_PLATFORM_TOTAL AS ( SELECT SPEND_DATE , PLATFORM, SUM(DAILY_TOTAL) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM GET_DAILY_TOTAL GROUP BY SPEND_DATE , PLATFORM ), GET_TEMPLATE AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT A.*, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM GET_TEMPLATE A LEFT JOIN GET_PLATFORM_TOTAL B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM"
178,Y,N,"WITH CTE AS (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN 1 ELSE 2 END ) AS NUMERIC_IND, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2), PLATS AS ( SELECT MOBILE AS PLATFORM, 1 AS NUMERIC_IND UNION SELECT DESKTOP AS PLATFORM, 2 AS NUMERIC_IND UNION SELECT BOTH AS PLATFORM, 3 AS NUMERIC_IND ), PLAT_DATE AS ( SELECT PLATFORM, NUMERIC_IND, SPEND_DATE FROM PLATS, (SELECT DISTINCT SPEND_DATE FROM CTE) B ) SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT, IFNULL(COUNT(C.NUMERIC_IND), 0) AS TOTAL_USERS FROM PLAT_DATE P LEFT JOIN CTE C ON P.SPEND_DATE = C.SPEND_DATE AND P.NUMERIC_IND = C.NUMERIC_IND GROUP BY 1,2"
179,Y,N,"WITH TB AS ( SELECT A.SPEND_DATE, B.PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS A JOIN (SELECT BOTH AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM) AS B), TB2 AS ( SELECT A.SPEND_DATE, CASE WHEN PLATFORM_COUNTS=2 THEN BOTH ELSE A.PLATFORM END AS CHANNEL_NEW, SUM(A.AMOUNT) AS AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_MEMBERS FROM SPENDING A LEFT JOIN ( SELECT SPEND_DATE, USER_ID, COUNT(DISTINCT PLATFORM) AS PLATFORM_COUNTS FROM SPENDING GROUP BY 1,2) AS B ON A.SPEND_DATE=B.SPEND_DATE AND A.USER_ID = B.USER_ID GROUP BY 1,2 ORDER BY 1,2) SELECT TB.SPEND_DATE, TB.PLATFORM, IFNULL(AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_MEMBERS,0) AS TOTAL_USERS FROM TB LEFT JOIN TB2 ON TB.SPEND_DATE = TB2.SPEND_DATE AND PLATFORM = CAST(CHANNEL_NEW AS CHAR CHARACTER SET UTF8)"
180,Y,Y,"WITH CTE1 AS(SELECT USER_ID,SPEND_DATE, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID,SPEND_DATE), CTE2 AS (SELECT USER_ID,SPEND_DATE,MOBILE_AMOUNT,DESKTOP_AMOUNT,MOBILE_AMOUNT+DESKTOP_AMOUNT AS BOTH_AMOUNT, CASE WHEN MOBILE_AMOUNT >0 THEN (CASE WHEN DESKTOP_AMOUNT > 0 THEN BOTH ELSE MOBILE END) ELSE DESKTOP END AS PLATFORM FROM CTE1), CTE3 AS(SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) SELECT CTE3.SPEND_DATE,CTE3.PLATFORM,COUNT(CTE2.USER_ID) AS TOTAL_USERS,SUM(IFNULL(CTE2.BOTH_AMOUNT,0)) AS TOTAL_AMOUNT FROM CTE3 LEFT JOIN CTE2 ON CTE3.SPEND_DATE=CTE2.SPEND_DATE AND CTE3.PLATFORM=CTE2.PLATFORM GROUP BY CTE3.SPEND_DATE,CTE3.PLATFORM"
181,Y,N,"WITH CTE_1 AS ( SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(PLATFORM) = 2 ), CTE_2 AS ( SELECT S.USER_ID, S.SPEND_DATE, S.PLATFORM, S.AMOUNT FROM SPENDING AS S LEFT JOIN CTE_1 AS C ON S.USER_ID = C.USER_ID AND S.SPEND_DATE = C.SPEND_DATE WHERE C.USER_ID IS NULL UNION ALL SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT FROM CTE_1 ), CTE_3 AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(SUM(B.AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(B.USER_ID) AS TOTAL_USERS FROM CTE_3 AS A LEFT JOIN CTE_2 AS B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY A.SPEND_DATE, A.PLATFORM ORDER BY A.SPEND_DATE ASC"
182,N,N,"WITH FINAL_FORMAT AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), PLATFORMS AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM_AUX FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT F.SPEND_DATE, F.PLATFORM AS PLATFORM, IFNULL(SUM(S.AMOUNT), 0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT P.USER_ID), 0) AS TOTAL_USERS FROM FINAL_FORMAT F LEFT JOIN PLATFORMS P ON P.PLATFORM_AUX = F.PLATFORM AND P.SPEND_DATE = F.SPEND_DATE LEFT JOIN SPENDING S ON P.USER_ID = S.USER_ID AND P.SPEND_DATE = S.SPEND_DATE GROUP BY F.SPEND_DATE, F.PLATFORM ORDER BY F.SPEND_DATE, F.PLATFORM"
183,Y,N,"WITH CTE AS ( SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING) SELECT Y.SPEND_DATE,Y.PLATFORM,IFNULL(X.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT,IFNULL(X.TOTAL_USERS,0) AS TOTAL_USERS FROM CTE Y LEFT JOIN ( SELECT X.SPEND_DATE,CASE WHEN RN=2 THEN BOTH ELSE X.PLATFORM END AS PLATFORM,SUM(X.AMOUNT) AS TOTAL_AMOUNT,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT USER_ID,SPEND_DATE,PLATFORM,AMOUNT,COUNT(USER_ID) OVER (PARTITION BY USER_ID,SPEND_DATE) AS RN FROM SPENDING)X GROUP BY 1,2)X ON Y.SPEND_DATE = X.SPEND_DATE AND Y.PLATFORM = X.PLATFORM"
184,N,N,"WITH CTE AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING ) SELECT C.SPEND_DATE, C.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT), 0) TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) TOTAL_USERS FROM CTE C LEFT JOIN ( SELECT S1.SPEND_DATE, S1.USER_ID, CASE WHEN COUNT(PLATFORM) = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(S1.AMOUNT) TOTAL_AMOUNT FROM SPENDING S1 GROUP BY 1,2 ) A ON C.SPEND_DATE = A.SPEND_DATE AND C.PLATFORM = A.PLATFORM GROUP BY 1,2"
185,Y,N,"WITH T1 AS ( SELECT USER_ID , SPEND_DATE , SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOB , SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DES FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT SPEND_DATE , 'desktop' AS PLATFORM , SUM(CASE WHEN DES > 0 AND MOB = 0 THEN DES ELSE 0 END) AS TOTAL_AMOUNT , SUM(CASE WHEN DES > 0 AND MOB = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM T1 GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE , 'mobile' PLATFORM , SUM(CASE WHEN MOB > 0 AND DES = 0 THEN MOB ELSE 0 END) TOTAL_AMOUNT , SUM(CASE WHEN MOB > 0 AND DES = 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM T1 GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE , 'both' AS PLATFORM , SUM(CASE WHEN DES > 0 AND MOB > 0 THEN MOB + DES ELSE 0 END) AS TOTAL_AMOUNT , SUM(CASE WHEN DES > 0 AND MOB > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM T1 GROUP BY SPEND_DATE"
186,Y,N,"WITH PLAT AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) > 1 THEN BOTH ELSE MIN(PLATFORM) END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), DATE_TABLE AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING ) SELECT D.SPEND_DATE, D.PLATFORM, IFNULL(SUM(AMOUNT),0) TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID),0) TOTAL_USERS FROM DATE_TABLE D LEFT JOIN PLAT USING(SPEND_DATE,PLATFORM) GROUP BY D.SPEND_DATE, D.PLATFORM"
187,Y,Y,"SELECT X.SPEND_DATE, X.PLATFORM, COALESCE(C.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(C.TOTAL_USERS,0) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING ) X LEFT JOIN ( SELECT SPEND_DATE, PLATFORM, SUM(TOTAL_AMOUNT) TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( SELECT SPEND_DATE, USER_ID, CASE WHEN MOBILE_AMOUNT>0 AND DESKTOP_AMOUNT>0 THEN BOTH WHEN MOBILE_AMOUNT>0 AND DESKTOP_AMOUNT=0 THEN MOBILE ELSE DESKTOP END AS PLATFORM, MOBILE_AMOUNT + DESKTOP_AMOUNT AS TOTAL_AMOUNT FROM ( SELECT SPEND_DATE, USER_ID, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) A ) B GROUP BY 1,2 ) C ON X.SPEND_DATE = C.SPEND_DATE AND X.PLATFORM = C.PLATFORM"
188,Y,N,"WITH CTE1 AS ( SELECT USER_ID,SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN 1 ELSE 0 END) AS MOBILE, SUM(CASE WHEN PLATFORM = 'desktop' THEN 1 ELSE 0 END) AS DESKTOP FROM SPENDING GROUP BY USER_ID,SPEND_DATE), CTE2 AS (SELECT S.SPEND_DATE, S.PLATFORM,S.AMOUNT,S.USER_ID,MOBILE,DESKTOP FROM SPENDING S JOIN CTE1 ON S.SPEND_DATE = CTE1.SPEND_DATE AND S.USER_ID = CTE1.USER_ID) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MOBILE = 1 AND DESKTOP =0 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT(CASE WHEN MOBILE = 1 AND DESKTOP =0 THEN USER_ID ELSE NULL END)) AS TOTAL_USERS FROM CTE2 GROUP BY SPEND_DATE,'mobile' UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN MOBILE = 0 AND DESKTOP =1 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT(CASE WHEN MOBILE = 0 AND DESKTOP =1 THEN USER_ID ELSE NULL END)) AS TOTAL_USERS FROM CTE2 GROUP BY SPEND_DATE,'desktop' UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN MOBILE = 1 AND DESKTOP =1 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT(CASE WHEN MOBILE = 1 AND DESKTOP =1 THEN USER_ID ELSE NULL END)) AS TOTAL_USERS FROM CTE2 GROUP BY SPEND_DATE,'both'"
189,Y,N,"WITH TEMP_1 AS( SELECT SPEND_DATE, PLATFORM, AMOUNT, USER_ID, COUNT(PLATFORM) OVER(PARTITION BY SPEND_DATE, USER_ID) CNT FROM SPENDING ) SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN CNT = 2 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN CNT = 2 THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM TEMP_1 GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN CNT = 1 AND PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN CNT = 1 AND PLATFORM = 'desktop' THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM TEMP_1 GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN CNT = 1 AND PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN CNT = 1 AND PLATFORM = 'mobile' THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM TEMP_1 GROUP BY 1"
190,Y,N,"WITH T1 AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESK_PLAT, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOB_PLAT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT T1.SPEND_DATE, 'desktop' PLATFORM, SUM(CASE WHEN T1.DESK_PLAT > 0 AND T1.MOB_PLAT = 0 THEN T1.DESK_PLAT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN T1.DESK_PLAT > 0 AND T1.MOB_PLAT = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM T1 GROUP BY T1.SPEND_DATE, PLATFORM UNION ALL SELECT T1.SPEND_DATE, 'mobile' PLATFORM, SUM(CASE WHEN T1.MOB_PLAT > 0 AND T1.DESK_PLAT = 0 THEN T1.MOB_PLAT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN T1.MOB_PLAT > 0 AND T1.DESK_PLAT = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM T1 GROUP BY T1.SPEND_DATE, PLATFORM UNION ALL SELECT T1.SPEND_DATE, 'both' PLATFORM, SUM(CASE WHEN T1.MOB_PLAT > 0 AND T1.DESK_PLAT > 0 THEN T1.MOB_PLAT + T1.DESK_PLAT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN T1.DESK_PLAT > 0 AND T1.MOB_PLAT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM T1 GROUP BY T1.SPEND_DATE, PLATFORM"
191,Y,Y,"WITH AGG_T AS (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE), SEP_T AS (SELECT USER_ID, SPEND_DATE, IF(MOBILE_AMOUNT >0, IF(DESKTOP_AMOUNT >0, 'both', 'mobile') , 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM AGG_T), DATE_T AS (SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT D.SPEND_DATE, D.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM DATE_T D LEFT JOIN SEP_T S ON D.SPEND_DATE = S.SPEND_DATE AND D.PLATFORM = S.PLATFORM GROUP BY D.SPEND_DATE, D.PLATFORM"
192,Y,N,"SELECT T2.SPEND_DATE, T1.PLATFORM, SUM(IF(T1.PLATFORM = T2.PLATFORM, AMOUNT, 0)) TOTAL_AMOUNT, COUNT(IF(T1.PLATFORM = T2.PLATFORM, 1, NULL)) TOTAL_USERS FROM ( SELECT MOBILE PLATFORM UNION SELECT DESKTOP PLATFORM UNION SELECT BOTH PLATFORM ) T1, ( SELECT USER_ID, SPEND_DATE, ANY_VALUE(IF(COUNT(PLATFORM) = 2, 'both', PLATFORM)) PLATFORM, SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) T2 GROUP BY T2.SPEND_DATE, T1.PLATFORM"
193,Y,N,"WITH A1 AS (SELECT DISTINCT SPEND_DATE FROM SPENDING), A2 AS (SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM), A3 AS (SELECT SPEND_DATE, PLATFORM FROM A1, A2), A4 AS (SELECT *, (CASE WHEN COUNT(PLATFORM) OVER(PARTITION BY USER_ID, SPEND_DATE) = 2 THEN BOTH WHEN COUNT(PLATFORM) OVER(PARTITION BY USER_ID, SPEND_DATE) =1 AND PLATFORM = 'DESKTOP THEN DESKTOP ELSE MOBILE' END) AS LABEL FROM SPENDING), A5 AS (SELECT A3.SPEND_DATE, A3.PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM A3 LEFT JOIN A4 ON A3.SPEND_DATE = A4.SPEND_DATE AND A3.PLATFORM = A4.LABEL GROUP BY 1,2 ) SELECT SPEND_DATE, PLATFORM, IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM A5"
194,Y,N,"WITH BASE AS ( SELECT T.SPEND_DATE, T.PLATFORM FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) T ), TMP AS ( SELECT SPEND_DATE, USER_ID, MAX(PLATFORM) AS PL, COUNT(DISTINCT PLATFORM) AS PLATFORM_NUM FROM SPENDING GROUP BY SPEND_DATE, USER_ID) SELECT BASE.SPEND_DATE, BASE.PLATFORM, COALESCE(TMP2.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(TMP2.TOTAL_USERS, 0) AS TOTAL_USERS FROM BASE LEFT JOIN ( SELECT A.SPEND_DATE, CASE WHEN PLATFORM_NUM = 1 THEN A.PL ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM TMP A LEFT JOIN SPENDING B ON A.SPEND_DATE = B.SPEND_DATE AND A.USER_ID = B.USER_ID GROUP BY A.SPEND_DATE, CASE WHEN PLATFORM_NUM = 1 THEN PL ELSE BOTH END ) TMP2 ON BASE.SPEND_DATE = TMP2.SPEND_DATE AND BASE.PLATFORM = TMP2.PLATFORM"
195,Y,N,"WITH AMT AS ( SELECT SPEND_DATE, USER_ID, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2,3 ), PF AS (SELECT SPEND_DATE, USER_ID, PLATFORM, AMOUNT, COUNT(*) OVER (PARTITION BY SPEND_DATE, USER_ID) AS CNT FROM SPENDING), PF_ADJUST AS ( SELECT SPEND_DATE, USER_ID, AMOUNT, CASE WHEN CNT = 2 THEN BOTH WHEN CNT = 1 THEN PLATFORM END AS PLATFORM FROM PF ), CTE AS ( SELECT SPEND_DATE,PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM PF_ADJUST GROUP BY 1,2 ) SELECT T.*, COALESCE(CTE.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(CTE.TOTAL_USERS,0) AS TOTAL_USERS FROM (SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) T LEFT JOIN CTE USING (SPEND_DATE, PLATFORM)"
196,N,N,"WITH T1 AS( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1, 2 ), T2 AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT T2.SPEND_DATE, T2.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T2 LEFT JOIN T1 ON T2.SPEND_DATE = T1.SPEND_DATE AND T2.PLATFORM = T1.PLATFORM GROUP BY 1, 2"
197,Y,N,"WITH T1 AS (SELECT PLATFORM, SPEND_DATE FROM (SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM) AS A, (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS B), T2 AS (SELECT USER_ID, SPEND_DATE, COUNT(1) CT, SUM(AMOUNT) SUB_TOTAL FROM SPENDING GROUP BY 1,2), T3 AS (SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) TOTAL_USERS FROM SPENDING WHERE (USER_ID, SPEND_DATE) IN (SELECT USER_ID, SPEND_DATE FROM T2 WHERE CT = 1) GROUP BY SPEND_DATE, PLATFORM UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) TOTAL_USERS FROM SPENDING WHERE (USER_ID, SPEND_DATE) IN (SELECT USER_ID, SPEND_DATE FROM T2 WHERE CT = 2) GROUP BY SPEND_DATE) SELECT T1.SPEND_DATE, T1.PLATFORM, IFNULL(TOTAL_AMOUNT,0) TOTAL_AMOUNT , IFNULL(TOTAL_USERS, 0) TOTAL_USERS FROM T1 LEFT JOIN T3 ON T1.SPEND_DATE = T3.SPEND_DATE AND T1.PLATFORM = T3.PLATFORM"
198,Y,N,"WITH TMP AS (SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(PLATFORM) = 2 THEN BOTH ELSE MIN(PLATFORM) END AS PLATFORM, SUM(AMOUNT) AS AMOUNT_PER_USER FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) , DT_HIST AS (SELECT DISTINCT SPEND_DATE, P.PLATFORM FROM TMP CROSS JOIN (SELECT BOTH AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM) P ) SELECT D.SPEND_DATE, D.PLATFORM, IFNULL(SUM(AMOUNT_PER_USER), 0) AS TOTAL_AMOUNT, IFNULL(COUNT(USER_ID), 0) AS TOTAL_USERS FROM DT_HIST D LEFT JOIN TMP T ON D.SPEND_DATE=T.SPEND_DATE AND D.PLATFORM = T.PLATFORM GROUP BY D.SPEND_DATE, D.PLATFORM"
199,Y,N,"WITH CTE1 AS ( SELECT DISTINCT SPEND_DATE AS SPEND_DATE FROM SPENDING), CTE2 AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM ), CTE3 AS (SELECT SPEND_DATE, PLATFORM FROM CTE1, CTE2), CTE4 AS (SELECT *, CASE WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) = 2 THEN BOTH WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) = 1 AND PLATFORM = 'DESKTOP THEN DESKTOP ELSE MOBILE' END AS ILABEL FROM SPENDING), CTE5 AS ( SELECT SPEND_DATE, ILABEL, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE4 GROUP BY SPEND_DATE,ILABEL) SELECT CTE3.SPEND_DATE, CTE3.PLATFORM, IFNULL(CTE5.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(CTE5.TOTAL_USERS,0) AS TOTAL_USERS FROM CTE3 LEFT JOIN CTE5 ON CTE3.SPEND_DATE = CTE5.SPEND_DATE AND CTE3.PLATFORM = CTE5.ILABEL"
200,N,N,"WITH CTE AS ( SELECT SPEND_DATE, USER_ID, COUNT(PLATFORM), SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(PLATFORM) = 2 ), CTE_MOBILE AS ( SELECT SPEND_DATE, USER_ID, PLATFORM, COUNT(PLATFORM), SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(PLATFORM) = 1 AND PLATFORM='mobile' ), CTE_DESKTOP AS ( SELECT SPEND_DATE, USER_ID, PLATFORM, COUNT(PLATFORM), SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(PLATFORM) = 1 AND PLATFORM='desktop' ) SELECT DISTINCT SPENDING.SPEND_DATE, 'both' AS PLATFORM , IFNULL(TMP.AM, 0) AS TOTAL_AMOUNT, IFNULL(TMP.CNT, 0) AS TOTAL_USERS FROM SPENDING LEFT JOIN ( SELECT SPEND_DATE, COUNT(USER_ID) AS CNT, SUM(AMOUNT) AS AM FROM CTE GROUP BY 1 ) TMP ON SPENDING.SPEND_DATE = TMP.SPEND_DATE UNION ALL SELECT DISTINCT SPENDING.SPEND_DATE, 'mobile' AS PLATFORM , IFNULL(TMP.AM, 0) AS TOTAL_AMOUNT, IFNULL(TMP.CNT, 0) AS TOTAL_USERS FROM SPENDING LEFT JOIN ( SELECT SPEND_DATE, COUNT(USER_ID) AS CNT, SUM(AMOUNT) AS AM FROM CTE_MOBILE GROUP BY 1 ) TMP ON SPENDING.SPEND_DATE = TMP.SPEND_DATE UNION ALL SELECT DISTINCT SPENDING.SPEND_DATE, 'desktop' AS PLATFORM , IFNULL(TMP.AM, 0) AS TOTAL_AMOUNT, IFNULL(TMP.CNT, 0) AS TOTAL_USERS FROM SPENDING LEFT JOIN ( SELECT SPEND_DATE, COUNT(USER_ID) AS CNT, SUM(AMOUNT) AS AM FROM CTE_DESKTOP GROUP BY 1 ) TMP ON SPENDING.SPEND_DATE = TMP.SPEND_DATE"
201,Y,N,"WITH CTE AS( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT = 0 THEN MOBILE_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT = 0 AND DESKTOP_AMOUNT > 0 THEN DESKTOP_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT = 0 AND DESKTOP_AMOUNT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT > 0 THEN MOBILE_AMOUNT+DESKTOP_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE"
202,N,N,"SELECT DT.SPEND_DATE, DT.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT USER_ID, SPEND_DATE, IF(CT=2, 'both', PLATFORM) AS PLATFORM, AMOUNT FROM (SELECT USER_ID, SPEND_DATE, COUNT(USER_ID) AS CT, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) AS A ) AS B RIGHT JOIN (SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING ) AS DT ON B.SPEND_DATE = DT.SPEND_DATE AND B.PLATFORM = DT.PLATFORM GROUP BY SPEND_DATE, PLATFORM ORDER BY SPEND_DATE"
203,N,N,"WITH USER_CATEGORY AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), DATE_TABLE AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) SELECT D.SPEND_DATE, D.PLATFORM, IFNULL(SUM(U.AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(U.USER_ID),0) AS TOTAL_USERS FROM DATE_TABLE D LEFT JOIN USER_CATEGORY U ON D.SPEND_DATE = U.SPEND_DATE AND U.PLATFORM = D.PLATFORM GROUP BY D.SPEND_DATE, D.PLATFORM"
204,N,N,"WITH A AS(SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, COUNT(I.USER_ID) AS TOTAL_USERS FROM A LEFT JOIN (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(*)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2) I ON I.SPEND_DATE = A.SPEND_DATE AND I.PLATFORM = A.PLATFORM GROUP BY 1,2"
205,N,N,"WITH TEMPLATE AS (SELECT DISTINCT SPEND_DATE, P.PLATFORM FROM SPENDING S INNER JOIN ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM) P) SELECT T.SPEND_DATE, T.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM TEMPLATE T LEFT JOIN (SELECT USER_ID, SPEND_DATE,(CASE WHEN COUNT(PLATFORM) =2 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) S ON T.SPEND_DATE = S.SPEND_DATE AND T.PLATFORM = S.PLATFORM GROUP BY T.SPEND_DATE, T.PLATFORM ORDER BY 1,2"
206,Y,N,"WITH A AS (SELECT *, SUM(CASE WHEN PLATFORM='mobile' THEN 1 ELSE 0 END) OVER(PARTITION BY USER_ID, SPEND_DATE) AS IF_MOBILE, SUM(CASE WHEN PLATFORM='desktop' THEN 1 ELSE 0 END) OVER(PARTITION BY USER_ID, SPEND_DATE) AS IF_DESK FROM SPENDING), B AS (SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN IF_MOBILE=0 AND IF_DESK=1 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN IF_MOBILE=0 AND IF_DESK=1 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM A GROUP BY SPEND_DATE), C AS (SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN IF_MOBILE=1 AND IF_DESK=0 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN IF_MOBILE=1 AND IF_DESK=0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM A GROUP BY SPEND_DATE), D AS (SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN IF_MOBILE=1 AND IF_DESK=1 THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, ROUND(SUM(CASE WHEN IF_MOBILE=1 AND IF_DESK=1 THEN 1 ELSE 0 END)/2,0) AS TOTAL_USERS FROM A GROUP BY SPEND_DATE) SELECT * FROM B UNION SELECT * FROM C UNION SELECT * FROM D"
207,Y,N,"WITH A AS(SELECT USER_ID, SPEND_DATE, IFNULL(SUM(AMOUNT),0)AS TOTAL_AMOUNT, COUNT(PLATFORM)PLATFORM, IFNULL(COUNT(DISTINCT USER_ID),0)AS TOTAL_USERS FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING PLATFORM=2), B AS(SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT)TOTAL_AMOUNT, COUNT(USER_ID)TOTAL_USERS FROM SPENDING WHERE PLATFORM='desktop' AND (USER_ID, SPEND_DATE) NOT IN (SELECT USER_ID, SPEND_DATE FROM A) GROUP BY SPEND_DATE), C AS(SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT)TOTAL_AMOUNT, COUNT(USER_ID)TOTAL_USERS FROM SPENDING WHERE PLATFORM='mobile' AND (USER_ID, SPEND_DATE) NOT IN (SELECT USER_ID, SPEND_DATE FROM A) GROUP BY SPEND_DATE) SELECT DISTINCT S.SPEND_DATE, IFNULL(B.PLATFORM,'desktop')PLATFORM, IFNULL(TOTAL_AMOUNT,0)TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0)TOTAL_USERS FROM SPENDING S LEFT JOIN B ON S.SPEND_DATE=B.SPEND_DATE UNION SELECT DISTINCT S.SPEND_DATE, IFNULL(C.PLATFORM,'mobile')PLATFORM, IFNULL(TOTAL_AMOUNT,0)TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0)TOTAL_USERS FROM SPENDING S LEFT JOIN C ON S.SPEND_DATE=C.SPEND_DATE UNION SELECT DISTINCT S.SPEND_DATE, 'both'AS PLATFORM, IFNULL(TOTAL_AMOUNT,0)TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0)TOTAL_USERS FROM SPENDING S LEFT JOIN A ON S.SPEND_DATE=A.SPEND_DATE"
208,N,N,"WITH CTE AS( SELECT DISTINCT (SPEND_DATE) AS SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT (SPEND_DATE) AS SPEND_DATE,'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT (SPEND_DATE) AS SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING ), CTE1 AS ( SELECT USER_ID,SPEND_DATE,CASE WHEN COUNT(1)=1 THEN PLATFORM ELSE BOTH END AS PLATFORM,SUM(AMOUNT) AS TOT FROM SPENDING GROUP BY USER_ID,SPEND_DATE) SELECT A.SPEND_DATE,A.PLATFORM,SUM( CASE WHEN B.TOT IS NOT NULL THEN B.TOT ELSE 0 END) AS TOTAL_AMOUNT,SUM( CASE WHEN B.USER_ID IS NULL THEN 0 ELSE 1 END) AS TOTAL_USERS FROM CTE A LEFT JOIN CTE1 B ON A.PLATFORM=B.PLATFORM AND A.SPEND_DATE=B.SPEND_DATE GROUP BY A.SPEND_DATE,A.PLATFORM"
209,Y,N,"WITH CTE AS ( SELECT SPEND_DATE, USER_ID, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2,3 ORDER BY 1,2,3 ), CTE1 AS ( SELECT *, CASE WHEN PLATFORM='mobile' THEN 1 WHEN PLATFORM='desktop' THEN -1 END AS CATEGORY FROM CTE ), PFORM AS ( SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM ), DATES AS ( SELECT DISTINCT SPEND_DATE FROM SPENDING ), SKELTON AS ( SELECT SPEND_DATE, PLATFORM FROM DATES, PFORM ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(B.TOTAL_USERS,0) AS TOTAL_USERS FROM SKELTON AS A LEFT JOIN ( SELECT SPEND_DATE, CASE WHEN CATE=1 THEN MOBILE WHEN CATE=-1 THEN DESKTOP WHEN CATE=0 THEN BOTH END AS PLATFORM, SUM(TOTAL_AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM( SELECT SPEND_DATE, USER_ID, SUM(CATEGORY) AS CATE, SUM(TOTAL_AMOUNT) AS TOTAL_AMOUNT FROM CTE1 GROUP BY 1,2 ) AS C GROUP BY 1,2) AS B ON A.SPEND_DATE=B.SPEND_DATE AND A.PLATFORM=B.PLATFORM"
210,N,N,"SELECT T1.SPEND_DATE,T1.PLATFORM,SUM(COALESCE(T2.AM,0)) AS TOTAL_AMOUNT, COALESCE ( COUNT(T2.USER_ID),0 ) AS TOTAL_USERS FROM ( SELECT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE,'both' AS PLATFORM FROM SPENDING )T1 LEFT OUTER JOIN ( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(PLATFORM)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM,SUM(AMOUNT) AS AM FROM SPENDING GROUP BY 1,2 )T2 ON T1.PLATFORM=T2.PLATFORM AND T1.SPEND_DATE=T2.SPEND_DATE GROUP BY 1,2"
211,N,N,"WITH CLEAN_DATA AS (SELECT USER_ID, SPEND_DATE, (CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2), PLATFORM AS (SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING ) SELECT PLATFORM.*, IFNULL(SUM(TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM PLATFORM LEFT JOIN CLEAN_DATA USING (SPEND_DATE, PLATFORM) GROUP BY 1,2"
212,N,N,"SELECT DT.SPEND_DATE, DT.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT USER_ID, SPEND_DATE, IF(CT = 2, 'both', PLATFORM) AS PLATFORM, AMOUNT FROM (SELECT USER_ID, SPEND_DATE, COUNT(USER_ID) AS CT, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) A ) B RIGHT JOIN (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) DT ON B.SPEND_DATE = DT.SPEND_DATE AND B.PLATFORM = DT.PLATFORM GROUP BY SPEND_DATE, PLATFORM ORDER BY SPEND_DATE"
213,N,N,"WITH TEMPLATE AS (SELECT DISTINCT SPEND_DATE, P.PLATFORM FROM SPENDING S CROSS JOIN ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM) P) SELECT T.SPEND_DATE, T.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM TEMPLATE T LEFT JOIN (SELECT USER_ID, SPEND_DATE,(CASE WHEN COUNT(PLATFORM) =2 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) S ON T.SPEND_DATE = S.SPEND_DATE AND T.PLATFORM = S.PLATFORM GROUP BY T.SPEND_DATE, T.PLATFORM ORDER BY 1,2"
214,Y,N,"WITH SUBTOTALS AS ( SELECT SPEND_DATE, USER_ID, SUM(AMOUNT) AS AMOUNT, CASE WHEN GROUP_CONCAT(PLATFORM) LIKE '%,%' THEN BOTH ELSE GROUP_CONCAT(PLATFORM) END AS PLATFORM FROM SPENDING GROUP BY SPEND_DATE, USER_ID ), UNIVERSAL AS ( SELECT * FROM (SELECT MOBILE AS PLATFORM UNION ALL SELECT DESKTOP UNION ALL SELECT BOTH ) AS T JOIN (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS T2 ), TOTALS AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM SUBTOTALS GROUP BY SPEND_DATE, PLATFORM ) SELECT U.SPEND_DATE, U.PLATFORM, COALESCE(T.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(TOTAL_USERS, 0) AS TOTAL_USERS FROM UNIVERSAL AS U LEFT JOIN TOTALS AS T ON U.SPEND_DATE = T.SPEND_DATE AND U.PLATFORM = T.PLATFORM"
215,N,N,"WITH A AS ( SELECT S.SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING S UNION SELECT S.SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING S UNION SELECT S.SPEND_DATE, 'both' AS PLATFORM FROM SPENDING S ), B AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1, 2 ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(B.TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT B.USER_ID), 0) AS TOTAL_USERS FROM A LEFT JOIN B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY 1, 2"
216,Y,N,"WITH CTE AS (SELECT USER_ID, SPEND_DATE , SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT , SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT , CASE WHEN SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT END) IS NULL THEN MOBILE WHEN SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT END) IS NULL THEN DESKTOP ELSE BOTH END AS TYPE FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT SPEND_DATE , 'desktop' AS PLATFORM , SUM(CASE WHEN TYPE = 'desktop' THEN DESKTOP_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT , SUM(CASE WHEN TYPE = 'desktop' THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION SELECT SPEND_DATE , 'mobile' AS PLATFORM , SUM(CASE WHEN TYPE = 'mobile' THEN MOBILE_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT , SUM(CASE WHEN TYPE = 'mobile' THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION SELECT SPEND_DATE , 'both' AS PLATFORM , SUM(CASE WHEN TYPE = 'both' THEN DESKTOP_AMOUNT+MOBILE_AMOUNT ELSE 0 END) AS TOTAL_AMOUNT , SUM(CASE WHEN TYPE = 'both' THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE ORDER BY 1"
217,Y,N,"WITH USER AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) = 1 THEN MIN(PLATFORM) ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), DATE_PLATFORM AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT D.SPEND_DATE, D.PLATFORM, SUM(COALESCE(U.AMOUNT,0)) AS TOTAL_AMOUNT, COALESCE(COUNT(DISTINCT U.USER_ID),0) AS TOTAL_USERS FROM DATE_PLATFORM D LEFT JOIN USER U ON D.SPEND_DATE = U.SPEND_DATE AND D.PLATFORM = U.PLATFORM GROUP BY 1,2 ORDER BY SPEND_DATE"
218,Y,N,"WITH CTE_STRU AS ( SELECT DISTINCT SPEND_DATE, SUB.PLATFORM FROM SPENDING JOIN (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM ) SUB ), PLAT_BOTH_GROUP AS ( SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM ( SELECT DISTINCT A.SPEND_DATE, A.USER_ID, A.AMOUNT+B.AMOUNT AS AMOUNT FROM SPENDING A JOIN SPENDING B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM != B.PLATFORM) SUB GROUP BY 1 ), PLAT_BOTH AS ( SELECT DISTINCT A.SPEND_DATE, A.USER_ID, 1 AS MARK FROM SPENDING A JOIN SPENDING B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM != B.PLATFORM ), PLAT_ONE_GROUP AS ( SELECT SPENDING.SPEND_DATE, SPENDING.PLATFORM, SUM(SPENDING.AMOUNT), COUNT(SPENDING.USER_ID) FROM SPENDING LEFT JOIN PLAT_BOTH ON SPENDING.SPEND_DATE = PLAT_BOTH.SPEND_DATE AND SPENDING.USER_ID = PLAT_BOTH.USER_ID WHERE MARK IS NULL GROUP BY 1, 2 ) SELECT CTE_STRU.SPEND_DATE, CTE_STRU.PLATFORM, IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM CTE_STRU LEFT JOIN ( SELECT * FROM PLAT_BOTH_GROUP UNION SELECT * FROM PLAT_ONE_GROUP) SUB ON SUB.SPEND_DATE = CTE_STRU.SPEND_DATE AND SUB.PLATFORM = CTE_STRU.PLATFORM"
219,Y,N,"WITH T AS( SELECT DISTINCT A.*, CASE WHEN A.PLATFORM = 'mobile' AND B.PLATFORM IS NULL THEN MOBILE WHEN A.PLATFORM = 'desktop' AND B.PLATFORM IS NULL THEN DESKTOP ELSE BOTH END AS PURCHASE FROM SPENDING A LEFT JOIN SPENDING B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM != B.PLATFORM ), T1 AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) SELECT T1.SPEND_DATE, T1.PLATFORM, SUM(COALESCE(T.AMOUNT,0)) TOTAL_AMOUNT, COUNT(DISTINCT T.USER_ID) TOTAL_USERS FROM T1 LEFT JOIN T ON T1.SPEND_DATE = T.SPEND_DATE AND T1.PLATFORM = T.PURCHASE GROUP BY 1,2"
220,Y,N,"WITH ONLY AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM SPENDING WHERE CONCAT(SPEND_DATE,',',USER_ID) IN ( SELECT CONCAT(SPEND_DATE,',',USER_ID) FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(DISTINCT PLATFORM)=1 ) GROUP BY SPEND_DATE, PLATFORM ), BOTH_APP AS ( SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM SPENDING WHERE CONCAT(SPEND_DATE,',',USER_ID) IN ( SELECT CONCAT(SPEND_DATE,',',USER_ID) FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(DISTINCT PLATFORM)=2 ) GROUP BY SPEND_DATE ), FULL_TB AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), COMBINED AS ( SELECT * FROM ONLY UNION SELECT * FROM BOTH_APP ) SELECT FULL_TB.SPEND_DATE,FULL_TB.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM FULL_TB LEFT JOIN COMBINED ON FULL_TB.SPEND_DATE= COMBINED.SPEND_DATE AND FULL_TB.PLATFORM=COMBINED.PLATFORM"
221,Y,N,"WITH CTE1 AS ( SELECT DISTINCT SPEND_DATE AS SPEND_DATE FROM SPENDING), CTE2 AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM ), CTE3 AS (SELECT SPEND_DATE, PLATFORM FROM CTE1, CTE2), CTE4 AS (SELECT *, CASE WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) = 2 THEN BOTH WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) = 1 AND PLATFORM = 'DESKTOP THEN DESKTOP' WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) = 1 AND PLATFORM = 'MOBILE THEN MOBILE ELSE OTHERS' END AS ILABEL FROM SPENDING), CTE5 AS ( SELECT SPEND_DATE, ILABEL, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE4 GROUP BY SPEND_DATE,ILABEL) SELECT CTE3.SPEND_DATE, CTE3.PLATFORM, IFNULL(CTE5.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(CTE5.TOTAL_USERS,0) AS TOTAL_USERS FROM CTE3 LEFT JOIN CTE5 ON CTE3.SPEND_DATE = CTE5.SPEND_DATE AND CTE3.PLATFORM = CTE5.ILABEL WHERE PLATFORM IN ('desktop', 'mobile', 'both')"
222,N,N,"WITH TEMP1 AS ( SELECT DISTINCT SPEND_DATE, P.PLATFORM FROM SPENDING S CROSS JOIN ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM ) P ) SELECT T.SPEND_DATE, T.PLATFORM, COALESCE(SUM(TOTAL_AMOUNT),0) AS TOTAL_AMOUNT , COALESCE(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM TEMP1 T LEFT JOIN (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM , SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) S ON T.PLATFORM=S.PLATFORM AND T.SPEND_DATE=S.SPEND_DATE GROUP BY T.SPEND_DATE, T.PLATFORM ORDER BY 1,2"
223,Y,N,"WITH CTE1 AS ( SELECT USER_ID, SPEND_DATE, MAX(PLATFORM) PLATFORM, MAX(AMOUNT) AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(PLATFORM) = 1 ),CTE2 AS ( SELECT USER_ID, SPEND_DATE, 'both' PLATFORM, SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(PLATFORM) > 1 ),CTE3 AS ( SELECT * FROM CTE1 UNION ALL SELECT * FROM CTE2 ),CTE4 AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, SUM(COALESCE(AMOUNT,0)) AS TOTAL_AMOUNT, COUNT(B.USER_ID) AS TOTAL_USERS FROM CTE4 A LEFT JOIN CTE3 B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY A.SPEND_DATE, A.PLATFORM"
224,Y,N,"WITH BOTH_PLT AS (SELECT USER_ID, SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) = 2), FRAME AS (SELECT DISTINCT SPEND_DATE, 'MOBILE AS PLATFORM' FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'DESKTOP AS PLATFORM' FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'BOTH AS PLATFORM' FROM SPENDING), ONLY_ONE AS (SELECT S.USER_ID, S.SPEND_DATE, S.PLATFORM, SUM(S.AMOUNT) AS AMOUNT FROM SPENDING S LEFT JOIN BOTH_PLT B ON S.USER_ID = B.USER_ID AND S.SPEND_DATE = B.SPEND_DATE WHERE B.USER_ID IS NULL GROUP BY S.USER_ID, S.SPEND_DATE, S.PLATFORM), MERGED AS (SELECT * FROM BOTH_PLT UNION SELECT * FROM ONLY_ONE) SELECT F.SPEND_DATE, F.PLATFORM, IFNULL(SUM(M.AMOUNT), 0) AS TOTAL_AMOUNT , COUNT(DISTINCT M.USER_ID) AS TOTAL_USERS FROM FRAME F LEFT JOIN MERGED M ON F.SPEND_DATE = M.SPEND_DATE AND F.PLATFORM = M.PLATFORM GROUP BY F.SPEND_DATE, F.PLATFORM"
225,Y,N,"WITH T1 AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESK_PLAT, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOB_PLAT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT T1.SPEND_DATE, 'desktop' PLATFORM, SUM(CASE WHEN T1.DESK_PLAT > 0 AND T1.MOB_PLAT = 0 THEN T1.DESK_PLAT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN T1.DESK_PLAT > 0 AND T1.MOB_PLAT = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM T1 GROUP BY T1.SPEND_DATE UNION ALL SELECT T1.SPEND_DATE, 'mobile' PLATFORM, SUM(CASE WHEN T1.MOB_PLAT > 0 AND T1.DESK_PLAT = 0 THEN T1.MOB_PLAT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN T1.MOB_PLAT > 0 AND T1.DESK_PLAT = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM T1 GROUP BY T1.SPEND_DATE UNION ALL SELECT T1.SPEND_DATE, 'both' PLATFORM, SUM(CASE WHEN T1.MOB_PLAT > 0 AND T1.DESK_PLAT > 0 THEN T1.MOB_PLAT + T1.DESK_PLAT ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN T1.DESK_PLAT > 0 AND T1.MOB_PLAT > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM T1 GROUP BY T1.SPEND_DATE"
226,Y,N,"WITH CTE2 AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) =2 THEN BOTH ELSE MAX(PLATFORM) END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID,SPEND_DATE ) , P AS ( SELECT DISTINCT(SPEND_DATE) DT, 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE) DT, 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE) DT, 'both' PLATFORM FROM SPENDING ) SELECT DT SPEND_DATE, P.PLATFORM ,SUM(COALESCE(AMOUNT,0)) AS TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM P LEFT JOIN CTE2 ON P.PLATFORM = CTE2.PLATFORM AND DT = CTE2.SPEND_DATE GROUP BY 1,2"
227,N,N,"WITH CTE AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2 ), DATE_PLATFORM AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(B.TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(B.USER_ID) AS TOTAL_USERS FROM DATE_PLATFORM A LEFT JOIN CTE B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY 1,2"
228,N,N,"WITH TMP AS ( SELECT SPEND_DATE, USER_ID, SUM(AMOUNT) AS TOTAL_AMOUNT, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING GROUP BY SPEND_DATE, USER_ID ), TMP1 AS ( SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,'both' FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,'desktop' FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(SUM(B.TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, COALESCE(COUNT(DISTINCT B.USER_ID),0) AS TOTAL_USERS FROM TMP1 AS A LEFT JOIN TMP AS B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
229,Y,N,"SELECT A.SPEND_DATE, A.PLATFORM, SUM(IFNULL(AMOUNT,0)) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) A LEFT JOIN (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM, AMOUNT FROM SPENDING) B ON A.PLATFORM = B.PLATFORM AND A.SPEND_DATE = B.SPEND_DATE GROUP BY SPEND_DATE, PLATFORM"
230,Y,Y,"SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) P LEFT JOIN ( SELECT SPEND_DATE, USER_ID, IF (MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM ( SELECT SPEND_DATE, USER_ID, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) O ) T ON P.PLATFORM = T.PLATFORM AND P.SPEND_DATE = T.SPEND_DATE GROUP BY SPEND_DATE, PLATFORM"
231,Y,N,"WITH PLATFORMS AS ( SELECT USER_ID, SPEND_DATE, AMOUNT, CASE WHEN COUNT(1) OVER (PARTITION BY USER_ID, SPEND_DATE) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING), PLATFORMS_AGGR AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM PLATFORMS GROUP BY SPEND_DATE, PLATFORM), DIM_PLATFORMS AS (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM), DATES AS (SELECT DISTINCT SPEND_DATE FROM PLATFORMS) SELECT D.SPEND_DATE, DM.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM DATES D CROSS JOIN DIM_PLATFORMS DM LEFT JOIN PLATFORMS_AGGR PA ON D.SPEND_DATE = PA.SPEND_DATE AND DM.PLATFORM = PA.PLATFORM"
232,Y,N,"WITH DERIVED AS (SELECT SPEND_DATE, CASE WHEN PLATFORM_COUNT = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT *, COUNT(*) OVER(PARTITION BY USER_ID, SPEND_DATE) AS PLATFORM_COUNT FROM SPENDING) AS PC GROUP BY SPEND_DATE, CASE WHEN PLATFORM_COUNT = 2 THEN BOTH ELSE PLATFORM END), TEMP AS (SELECT SPEND_DATE, PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS DATES, (SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM) AS PLATFORM_VALUES) SELECT T.SPEND_DATE, T.PLATFORM, COALESCE(D.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(D.TOTAL_USERS, 0) AS TOTAL_USERS FROM TEMP T LEFT JOIN DERIVED D ON T.SPEND_DATE = D.SPEND_DATE AND T.PLATFORM = D.PLATFORM"
233,N,N,"WITH CTE AS( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(*)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1, 2 ), CTE2 AS( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM CTE GROUP BY 1, 2 ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(B.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(B.TOTAL_USERS, 0) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) A LEFT JOIN (SELECT * FROM CTE2) B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM=B.PLATFORM"
234,Y,N,"WITH BOTH_PLATFORM AS ( SELECT SPEND_DATE , USER_ID , ( CASE WHEN COUNT(PLATFORM) = 2 THEN BOTH WHEN MAX(PLATFORM) = 'MOBILE THEN MOBILE ELSE DESKTOP' END ) AS PLATFORM , SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ORDER BY SPEND_DATE ), FULL_TABLE AS (SELECT SPEND_DATE , PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM BOTH_PLATFORM) T1 JOIN ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) T2) SELECT T2.SPEND_DATE, T2.PLATFORM, SUM( IFNULL (TOTAL_AMOUNT, 0)) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM FULL_TABLE T2 LEFT JOIN BOTH_PLATFORM ON T2.SPEND_DATE = BOTH_PLATFORM.SPEND_DATE AND T2.PLATFORM = BOTH_PLATFORM.PLATFORM GROUP BY T2.SPEND_DATE, T2.PLATFORM"
235,N,N,"WITH CTE AS( SELECT D.SPEND_DATE, D.PLATFORM, SUM(D.TOTAL_AMOUNT) AS TOTAL_AMOUNT, COUNT(D.USER_ID) AS TOTAL_USERS FROM( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(*)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) D GROUP BY 1, 2 ORDER BY 1 ) SELECT T.SPEND_DATE, T.PLATFORM, IFNULL(D.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(D.TOTAL_USERS,0) AS TOTAL_USERS FROM (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) T LEFT JOIN (SELECT * FROM CTE) D ON T.SPEND_DATE = D.SPEND_DATE AND T.PLATFORM = D.PLATFORM"
236,Y,N,"WITH CTE AS ( SELECT *, COUNT(PLATFORM) OVER(PARTITION BY SPEND_DATE, USER_ID) AS TYPE FROM SPENDING ) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN TYPE = 1 AND PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN TYPE = 1 AND PLATFORM = 'mobile' THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN TYPE = 1 AND PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN TYPE = 1 AND PLATFORM = 'desktop' THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN TYPE = 2 THEN AMOUNT ELSE 0 END ) AS TOTAL_AMOUNT, COUNT(DISTINCT CASE WHEN TYPE = 2 THEN USER_ID ELSE NULL END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE"
237,Y,N,"WITH SPEND_BY_USER AS( SELECT SPEND_DATE, USER_ID, SUM( CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END ) AS DESKTOP_SPEND, SUM( CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END ) AS MOBILE_SPEND FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN DESKTOP_SPEND > 0 AND MOBILE_SPEND = 0 THEN DESKTOP_SPEND ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN DESKTOP_SPEND > 0 AND MOBILE_SPEND = 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM SPEND_BY_USER GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN DESKTOP_SPEND = 0 AND MOBILE_SPEND > 0 THEN MOBILE_SPEND ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN DESKTOP_SPEND = 0 AND MOBILE_SPEND > 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM SPEND_BY_USER GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN DESKTOP_SPEND > 0 AND MOBILE_SPEND > 0 THEN DESKTOP_SPEND + MOBILE_SPEND ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN DESKTOP_SPEND > 0 AND MOBILE_SPEND > 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM SPEND_BY_USER GROUP BY SPEND_DATE"
238,Y,N,"WITH T_SPLIT AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY 1,2 ), T_AGG AS ( SELECT SPEND_DATE, CASE WHEN MOBILE_AMOUNT IS NULL THEN DESKTOP WHEN DESKTOP_AMOUNT IS NULL THEN MOBILE ELSE BOTH END AS PLATFORM, SUM(IFNULL(MOBILE_AMOUNT, 0) + IFNULL(DESKTOP_AMOUNT, 0)) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T_SPLIT GROUP BY 1,2 ), T_MAIN AS( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT TM.SPEND_DATE, TM.PLATFORM, IFNULL(T_AGG.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(T_AGG.TOTAL_USERS,0) AS TOTAL_USERS FROM T_MAIN TM LEFT JOIN T_AGG ON TM.SPEND_DATE = T_AGG.SPEND_DATE AND TM.PLATFORM = T_AGG.PLATFORM"
239,N,N,"WITH A AS ( SELECT SPEND_DATE, USER_ID, (CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING AS S GROUP BY 1,2 ), S AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING ) SELECT S.SPEND_DATE, S.PLATFORM, COALESCE(SUM(A.AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM S LEFT JOIN A ON A.SPEND_DATE = S.SPEND_DATE AND S.PLATFORM = A.PLATFORM GROUP BY 1,2 ORDER BY 1,2"
240,N,N,"WITH T1 AS ( SELECT SPEND_DATE, USER_ID, PLATFORM, AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(DISTINCT PLATFORM) = 1 ), T2 AS( SELECT SPEND_DATE, USER_ID, 'both' AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(DISTINCT PLATFORM) = 2 ), T3 AS ( SELECT SPEND_DATE, PLATFORM FROM T1 GROUP BY SPEND_DATE HAVING COUNT(DISTINCT PLATFORM) = 1 ), T4 AS ( SELECT DISTINCT SPEND_DATE FROM SPENDING WHERE SPEND_DATE NOT IN (SELECT SPEND_DATE FROM T1) AND SPEND_DATE IN (SELECT SPEND_DATE FROM T2) ) SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T1 GROUP BY SPEND_DATE, PLATFORM UNION ALL SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T2 GROUP BY SPEND_DATE, PLATFORM UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM, 0 AS TOTAL_AMOUNT, 0 AS TOTAL_USERS FROM T1 WHERE SPEND_DATE NOT IN (SELECT SPEND_DATE FROM T2) UNION ALL SELECT DISTINCT SPEND_DATE, CASE WHEN PLATFORM = 'MOBILE THEN DESKTOP ELSE MOBILE' END AS PLATFORM, 0 AS TOTAL_AMOUNT, 0 AS TOTAL_USERS FROM T3 UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM, 0 AS TOTAL_AMOUNT, 0 AS TOTAL_USERS FROM T4 UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM, 0 AS TOTAL_AMOUNT, 0 AS TOTAL_USERS FROM T4"
241,N,N,"WITH P AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(B.AMOUNT), 0) AS TOTAL_AMOUNT, IFNULL(COUNT(B.PLATFORM), 0) AS TOTAL_USERS FROM P A LEFT JOIN ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) B ON A.SPEND_DATE=B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY A.SPEND_DATE, A.PLATFORM"
242,N,N,"WITH PLATFORMS AS( SELECT DISTINCT PLATFORM FROM SPENDING UNION SELECT BOTH AS PLATFORM ), DATES AS( SELECT DISTINCT SPEND_DATE FROM SPENDING ), SPENDING_ONE_BOTH AS( SELECT SPEND_DATE, USER_ID, 'both' AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(DISTINCT PLATFORM) = 2 UNION ALL SELECT SPEND_DATE, USER_ID, PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(DISTINCT PLATFORM) = 1 ) SELECT D.SPEND_DATE, P.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM DATES D CROSS JOIN PLATFORMS P LEFT JOIN SPENDING_ONE_BOTH S ON P.PLATFORM = S.PLATFORM AND D.SPEND_DATE = S.SPEND_DATE GROUP BY D.SPEND_DATE, P.PLATFORM ORDER BY 1,2"
243,Y,N,"WITH TB1 AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) OVER(PARTITION BY SPEND_DATE, USER_ID)=1 THEN PLATFORM ELSE BOTH END AS PLATFORM, AMOUNT FROM SPENDING ), SUM_T AS ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TB1 GROUP BY SPEND_DATE, PLATFORM), D AS ( SELECT SPEND_DATE FROM SPENDING GROUP BY SPEND_DATE), P AS ( SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM) SELECT D.SPEND_DATE, P.PLATFORM, IFNULL(S.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(S.TOTAL_USERS,0) AS TOTAL_USERS FROM D CROSS JOIN P LEFT JOIN SUM_T S ON D.SPEND_DATE=S.SPEND_DATE AND P.PLATFORM =S.PLATFORM"
244,N,N,"WITH NUM AS (SELECT USER_ID,SPEND_DATE,CASE WHEN COUNT(DISTINCT PLATFORM)>1 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE), TT AS ( SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM NUM GROUP BY SPEND_DATE,PLATFORM ), FORM AS ( SELECT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE,'both' AS PLATFORM FROM SPENDING GROUP BY SPEND_DATE ) SELECT FORM.SPEND_DATE,FORM.PLATFORM,IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM FORM LEFT JOIN TT ON FORM.SPEND_DATE=TT.SPEND_DATE AND FORM.PLATFORM=TT.PLATFORM"
245,N,N,"WITH CTE AS (SELECT SPEND_DATE,USER_ID,CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2),FULL_TABLE AS( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT FULL_TABLE.SPEND_DATE,FULL_TABLE.PLATFORM, IFNULL(SUM(CTE.TOTAL_AMOUNT),0) TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT CTE.USER_ID),0) AS TOTAL_USERS FROM CTE RIGHT JOIN FULL_TABLE ON FULL_TABLE.SPEND_DATE = CTE.SPEND_DATE AND FULL_TABLE.PLATFORM = CTE.PLATFORM GROUP BY 1,2"
246,Y,N,"WITH CTE1 AS (SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT FROM SPENDING WHERE PLATFORM='mobile'), CTE2 AS (SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT FROM SPENDING WHERE PLATFORM='desktop'), CTE3 AS (SELECT CTE1.SPEND_DATE, (SELECT BOTH ) AS PLATFORM , SUM(CTE1.AMOUNT+CTE2.AMOUNT) AS TOTAL_AMOUNT , COUNT(CTE1.USER_ID) AS TOTAL_USERS FROM CTE1 JOIN CTE2 ON CTE1.USER_ID=CTE2.USER_ID AND CTE1.SPEND_DATE=CTE2.SPEND_DATE AND CTE1.PLATFORM!=CTE2.PLATFORM GROUP BY SPEND_DATE), CTE4 AS (SELECT DISTINCT SPEND_DATE FROM SPENDING), CTE5 AS (SELECT CTE4.SPEND_DATE, (SELECT BOTH ) AS PLATFORM , IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT , IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM CTE4 LEFT JOIN CTE3 ON CTE3.SPEND_DATE=CTE4.SPEND_DATE), CTE6 AS (SELECT CTE1.SPEND_DATE, CTE1.PLATFORM, SUM(CTE1.AMOUNT) AS TOTAL_AMOUNT , COUNT(CTE1.USER_ID) AS TOTAL_USERS FROM CTE1 LEFT JOIN CTE2 ON CTE1.USER_ID=CTE2.USER_ID AND CTE1.SPEND_DATE=CTE2.SPEND_DATE AND CTE1.PLATFORM!=CTE2.PLATFORM WHERE CTE2.USER_ID IS NULL GROUP BY CTE1.SPEND_DATE), CTE7 AS (SELECT CTE4.SPEND_DATE, (SELECT MOBILE ) AS PLATFORM , IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT , IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM CTE4 LEFT JOIN CTE6 ON CTE6.SPEND_DATE=CTE4.SPEND_DATE), CTE8 AS (SELECT CTE2.SPEND_DATE, CTE2.PLATFORM, SUM(CTE2.AMOUNT) AS TOTAL_AMOUNT , COUNT(CTE2.USER_ID) AS TOTAL_USERS FROM CTE2 LEFT JOIN CTE1 ON CTE1.USER_ID=CTE2.USER_ID AND CTE1.SPEND_DATE=CTE2.SPEND_DATE AND CTE1.PLATFORM!=CTE2.PLATFORM WHERE CTE1.USER_ID IS NULL GROUP BY CTE2.SPEND_DATE) SELECT CTE4.SPEND_DATE, (SELECT DESKTOP ) AS PLATFORM , IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT , IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM CTE4 LEFT JOIN CTE8 ON CTE8.SPEND_DATE=CTE4.SPEND_DATE UNION SELECT * FROM CTE7 UNION SELECT * FROM CTE5"
247,Y,N,"WITH USER_CHANNEL AS( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE MAX(PLATFORM) END AS PLATFORM , SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), UNIVERSE AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT U.SPEND_DATE, U.PLATFORM, COALESCE(SUM(C.TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT , COALESCE(COUNT(DISTINCT C.USER_ID), 0) AS TOTAL_USERS FROM UNIVERSE U LEFT JOIN USER_CHANNEL C ON C.PLATFORM = U.PLATFORM AND C.SPEND_DATE = U.SPEND_DATE GROUP BY U.SPEND_DATE, U.PLATFORM"
248,Y,N,"WITH T1 AS( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT, COUNT(PLATFORM)-SUM(IF(PLATFORM='mobile',1,0)) AS NUM_DIFF, SUM(IF(PLATFORM='mobile',1,0)) AS NUM_MOB FROM SPENDING GROUP BY USER_ID, SPEND_DATE ), T2 AS( SELECT USER_ID, SPEND_DATE,AMOUNT, CASE WHEN NUM_DIFF>0 AND NUM_MOB=0 THEN DESKTOP WHEN NUM_DIFF>0 AND NUM_MOB>0 THEN BOTH WHEN NUM_DIFF = 0 THEN MOBILE END AS PLATFORM FROM T1 ), T3(SPEND_DATE,PLATFORM) AS( SELECT * FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) S1 CROSS JOIN ((SELECT DESKTOP ) UNION (SELECT MOBILE ) UNION (SELECT BOTH )) S2 ) SELECT T3.SPEND_DATE, T3.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM T3 LEFT JOIN( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM T2 GROUP BY SPEND_DATE, PLATFORM) AS T4 ON T3.SPEND_DATE = T4. SPEND_DATE AND T3.PLATFORM = T4.PLATFORM"
249,Y,N,"WITH TEMP AS (SELECT USER_ID, SPEND_DATE, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) AS MOB, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) AS DES FROM SPENDING GROUP BY USER_ID, SPEND_DATE) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MOB > 0 AND DES = 0 THEN MOB ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MOB > 0 AND DES = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN DES > 0 AND MOB = 0 THEN DES ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN DES > 0 AND MOB = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN DES > 0 AND MOB > 0 THEN DES + MOB ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN DES > 0 AND MOB > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE"
250,Y,N,"WITH SPEND_PLAT AS( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), MOBILE_DESKTOP_BOTH AS( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(*) = 1 THEN MIN(PLATFORM) ELSE BOTH END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT S.SPEND_DATE, S.PLATFORM, IFNULL(SUM(M.TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(M.SPEND_DATE) AS TOTAL_USERS FROM SPEND_PLAT S LEFT JOIN MOBILE_DESKTOP_BOTH M ON S.SPEND_DATE = M.SPEND_DATE AND S.PLATFORM = M.PLATFORM GROUP BY S.SPEND_DATE, S.PLATFORM"
251,Y,N,"WITH TEMP AS ( SELECT A.USER_ID,A.SPEND_DATE,A.PLATFORM,AMOUNT,NUM_PLATFORM FROM SPENDING A LEFT JOIN (SELECT USER_ID,SPEND_DATE, COUNT(DISTINCT PLATFORM) AS NUM_PLATFORM FROM SPENDING GROUP BY USER_ID,SPEND_DATE) B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE ), TEMP2 AS (SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP WHERE NUM_PLATFORM = 1 AND PLATFORM = 'desktop' GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP WHERE PLATFORM = 'mobile' AND NUM_PLATFORM = 1 GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP WHERE NUM_PLATFORM = 2 GROUP BY SPEND_DATE), DATE_TABLE AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) SELECT A.SPEND_DATE,A.PLATFORM,IFNULL(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT,IFNULL(B.TOTAL_USERS,0) AS TOTAL_USERS FROM DATE_TABLE A LEFT JOIN TEMP2 B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM"
252,Y,N,"WITH BOTH_PLATFORM AS ( SELECT USER_ID , SPEND_DATE FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(PLATFORM) > 1 ) , SKELETON_PLATFORM AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM ) , SKELETON_DATES AS ( SELECT DISTINCT SPEND_DATE FROM SPENDING ) , SKELETON AS ( SELECT SPEND_DATE, PLATFORM FROM SKELETON_PLATFORM, SKELETON_DATES ) , DATA AS ( SELECT S.SPEND_DATE , CASE WHEN B.USER_ID IS NULL THEN S.PLATFORM ELSE BOTH END AS PLATFORM , SUM(S.AMOUNT) AS TOTAL_AMOUNT , COUNT(DISTINCT S.USER_ID) AS TOTAL_USERS FROM SPENDING S LEFT JOIN BOTH_PLATFORM B ON S.USER_ID = B.USER_ID AND S.SPEND_DATE = B.SPEND_DATE GROUP BY 1,2 ) SELECT S.SPEND_DATE , S.PLATFORM , IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT , IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM SKELETON S LEFT JOIN DATA D ON S.SPEND_DATE = D.SPEND_DATE AND S.PLATFORM = D.PLATFORM"
253,Y,N,"SELECT P.SPEND_DATE ,P.PLATFORM ,SUM(IFNULL(B.AMOUNT,0)) AS TOTAL_AMOUNT ,COUNT(B.USER_ID) AS TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING ) P LEFT JOIN (SELECT SPEND_DATE, USER_ID, CASE WHEN MOBILE_AMOUNT >0 AND DESKTOP_AMOUNT > 0 THEN BOTH WHEN MOBILE_AMOUNT = 0 AND DESKTOP_AMOUNT >0 THEN DESKTOP ELSE MOBILE END AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM ( SELECT SPEND_DATE, USER_ID , SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT , SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) A ) B ON P.PLATFORM = B.PLATFORM AND P.SPEND_DATE=B.SPEND_DATE GROUP BY 1,2"
254,Y,Y,"SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(O.TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING )P LEFT JOIN ( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS TOTAL_AMOUNT FROM ( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID )T )O ON P.SPEND_DATE = O.SPEND_DATE AND O.PLATFORM = P.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
255,N,N,"WITH A AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, CASE WHEN SUM(DAILY_TOTAL) IS NULL THEN 0 ELSE SUM(DAILY_TOTAL) END AS TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM A LEFT JOIN( SELECT USER_ID, SPEND_DATE, (CASE WHEN COUNT(DISTINCT PLATFORM)=2 THEN BOTH ELSE PLATFORM END) PLATFORM, SUM(AMOUNT) DAILY_TOTAL FROM SPENDING GROUP BY USER_ID, SPEND_DATE) B ON B.SPEND_DATE=A.SPEND_DATE AND B.PLATFORM=A.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
256,Y,N,"WITH COUNT_DEVICE AS ( SELECT *, COUNT(*) OVER (PARTITION BY USER_ID, SPEND_DATE) AS CNT FROM SPENDING ) , ADD_NEW_DEVICE AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN CNT = 2 THEN BOTH ELSE PLATFORM END AS DEVICE_PLATFORM, AMOUNT FROM COUNT_DEVICE ) , ALL_TYPES AS ( SELECT DESKTOP AS PLATFORM FROM SPENDING UNION SELECT MOBILE AS PLATFORM FROM SPENDING UNION SELECT BOTH AS PLATFORM FROM SPENDING ) , RESULTS AS ( SELECT SPEND_DATE, DEVICE_PLATFORM AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM ADD_NEW_DEVICE AS B GROUP BY 1, 2 ) , FORMAT AS ( SELECT * FROM ALL_TYPES CROSS JOIN (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS A ) SELECT A.PLATFORM, A.SPEND_DATE, COALESCE(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(B.TOTAL_USERS,0) AS TOTAL_USERS FROM FORMAT AS A LEFT JOIN RESULTS AS B ON A.PLATFORM = B.PLATFORM AND A.SPEND_DATE = B.SPEND_DATE"
257,N,N,"WITH GET_DAILY_TOTAL AS ( SELECT USER_ID , SPEND_DATE, SUM(AMOUNT) AS DAILY_TOTAL, CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING GROUP BY 1,2 ), GET_USERS_CNT AS ( SELECT SPEND_DATE , PLATFORM, SUM(DAILY_TOTAL) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM GET_DAILY_TOTAL GROUP BY SPEND_DATE , PLATFORM ), GET_TEMPLATE AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(B.TOTAL_USERS,0) AS TOTAL_USERS FROM GET_TEMPLATE A LEFT JOIN GET_USERS_CNT B USING (SPEND_DATE,PLATFORM)"
258,N,N,"WITH T AS ( SELECT USER_ID, SPEND_DATE, IF(COUNT(*) = 2, 'both', PLATFORM) AS PLATFORM, IF(COUNT(*) = 2, SUM(AMOUNT), AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE), P AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM) SELECT TEMP.SPEND_DATE, P.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(T.USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS TEMP CROSS JOIN P LEFT JOIN T ON TEMP.SPEND_DATE = T.SPEND_DATE AND P.PLATFORM = T.PLATFORM GROUP BY TEMP.SPEND_DATE, P.PLATFORM ORDER BY TEMP.SPEND_DATE, P.PLATFORM"
259,N,N,"WITH CTE AS( SELECT SPEND_DATE, USER_ID, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2), CTE2 AS( SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING) SELECT C2.SPEND_DATE, C2.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE2 C2 LEFT JOIN CTE C USING (SPEND_DATE, PLATFORM) GROUP BY 1, 2"
260,Y,N,"WITH CTE AS (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS DA, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MA FROM SPENDING GROUP BY USER_ID, SPEND_DATE) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MA>0 AND DA=0 THEN MA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MA>0 AND DA=0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE, PLATFORM UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN MA=0 AND DA>0 THEN DA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MA=0 AND DA>0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE, PLATFORM UNION SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN MA>0 AND DA>0 THEN (DA+MA) ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MA>0 AND DA>0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE, PLATFORM"
261,Y,N,"WITH CTE AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MA, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DA FROM SPENDING GROUP BY 1,2 ) SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MA > 0 AND DA = 0 THEN MA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN MA > 0 AND DA = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN DA > 0 AND MA = 0 THEN DA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN DA > 0 AND MA = 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY 1 UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN DA > 0 AND MA > 0 THEN MA+DA ELSE 0 END) AS TOTAL_AMOUNT, SUM(CASE WHEN DA > 0 AND MA > 0 THEN 1 ELSE 0 END) AS TOTAL_USERS FROM CTE GROUP BY 1"
262,Y,N,"WITH TEMP1 AS (SELECT SPEND_DATE,PLATFORM, USER_ID,COUNT(PLATFORM) OVER (PARTITION BY SPEND_DATE,USER_ID) AS TOTAL_PLATFORM,AMOUNT FROM SPENDING), TEMP2 AS (SELECT SPEND_DATE, USER_ID,CASE WHEN TOTAL_PLATFORM=2 THEN BOTH ELSE PLATFORM END AS PLATFORM, AMOUNT FROM TEMP1), TEMP3 AS (SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP2 GROUP BY SPEND_DATE,PLATFORM), ALL_TABLE AS (SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM TEMP2 UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM TEMP2 UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM TEMP2) SELECT DISTINCT A.SPEND_DATE,A.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM ALL_TABLE A LEFT JOIN TEMP3 T ON A.SPEND_DATE=T.SPEND_DATE AND A.PLATFORM = T.PLATFORM"
263,Y,Y,"WITH A AS (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY 1, 2), B AS (SELECT USER_ID, SPEND_DATE, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, MOBILE_AMOUNT + DESKTOP_AMOUNT AS TOTAL_AMOUNT FROM A), ORG AS (SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) SELECT O.SPEND_DATE, O.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM ORG O LEFT JOIN B ON O.SPEND_DATE = B.SPEND_DATE AND O.PLATFORM = B.PLATFORM GROUP BY 1, 2"
264,Y,Y,"WITH T1 AS (SELECT SPEND_DATE, USER_ID, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID), T2 AS (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING), T3 AS (SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AMOUNT FROM T1) SELECT T2.SPEND_DATE, T2.PLATFORM, IFNULL(SUM(AMOUNT), 0) TOTAL_AMOUNT, COUNT(USER_ID) TOTAL_USERS FROM T2 LEFT JOIN T3 ON T2.PLATFORM = T3.PLATFORM AND T2.SPEND_DATE = T3.SPEND_DATE GROUP BY 1, 2"
265,Y,N,"WITH TEMP AS( SELECT A.USER_ID, A.AMOUNT,A.SPEND_DATE,A.PLATFORM,B.CNT AS CNT FROM SPENDING A INNER JOIN ( SELECT USER_ID, SPEND_DATE,COUNT(1)AS CNT FROM (SELECT DISTINCT USER_ID, SPEND_DATE,PLATFORM FROM SPENDING) D GROUP BY USER_ID, SPEND_DATE ) B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE ) SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT)AS TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP WHERE CNT =2 GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(AMOUNT)AS TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP WHERE CNT =1 AND PLATFORM = 'desktop' GROUP BY SPEND_DATE UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(AMOUNT)AS TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP WHERE CNT =1 AND PLATFORM = 'mobile' GROUP BY SPEND_DATE UNION SELECT DISTINCT SPEND_DATE, PLATFORM, TOTAL_AMOUNT,TOTAL_USERS FROM ( SELECT SPEND_DATE, 'both' AS PLATFORM ,0 AS TOTAL_AMOUNT, 0 AS TOTAL_USERS FROM SPENDING WHERE SPEND_DATE NOT IN( SELECT SPEND_DATE FROM TEMP WHERE CNT =2 ) )A UNION SELECT DISTINCT SPEND_DATE, PLATFORM, TOTAL_AMOUNT,TOTAL_USERS FROM ( SELECT SPEND_DATE, 'desktop' AS PLATFORM ,0 AS TOTAL_AMOUNT, 0 AS TOTAL_USERS FROM SPENDING WHERE SPEND_DATE NOT IN( SELECT SPEND_DATE FROM TEMP WHERE CNT =1 AND PLATFORM = 'desktop' ) )B UNION SELECT DISTINCT SPEND_DATE, PLATFORM, TOTAL_AMOUNT,TOTAL_USERS FROM ( SELECT SPEND_DATE, 'mobile' AS PLATFORM ,0 AS TOTAL_AMOUNT, 0 AS TOTAL_USERS FROM SPENDING WHERE SPEND_DATE NOT IN( SELECT SPEND_DATE FROM TEMP WHERE CNT = 1 AND PLATFORM = 'mobile' ) )C ORDER BY FIELD(PLATFORM,'desktop','mobile','both') ,SPEND_DATE"
266,Y,N,"WITH GROUP_SPENDING AS( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT FROM SPENDING GROUP BY 1,2), DUMMY AS( SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), INFO AS( SELECT USER_ID, SPEND_DATE, CASE WHEN DESKTOP_AMOUNT > 0 AND MOBILE_AMOUNT > 0 THEN BOTH WHEN DESKTOP_AMOUNT > 0 AND MOBILE_AMOUNT = 0 THEN DESKTOP ELSE MOBILE END AS PLATFORM, SUM(DESKTOP_AMOUNT+MOBILE_AMOUNT) AS AMOUNT FROM GROUP_SPENDING GROUP BY 1,2,3 ), FINAL AS( SELECT I.USER_ID, D.SPEND_DATE, D.PLATFORM, I.AMOUNT FROM DUMMY D LEFT JOIN INFO I ON D.SPEND_DATE = I.SPEND_DATE AND D.PLATFORM = I.PLATFORM) SELECT SPEND_DATE, PLATFORM, SUM(IFNULL(AMOUNT,0)) AS TOTAL_AMOUNT, SUM(CASE WHEN USER_ID IS NULL THEN 0 ELSE 1 END) AS TOTAL_USERS FROM FINAL GROUP BY 1,2"
267,Y,N,"WITH AGG AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) = 1 THEN ANY_VALUE(PLATFORM) ELSE ANY_VALUE('both') END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2 ), BASE AS ( SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) SELECT SPEND_DATE, PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID),0) AS TOTAL_USERS FROM BASE LEFT JOIN AGG USING(SPEND_DATE, PLATFORM) GROUP BY 1,2"
268,Y,Y,"WITH MY_TABLE AS (SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT M.SPEND_DATE, M.PLATFORM, IFNULL(SUM(PERSONAL_AMOUNT), 0) AS TOTAL_AMOUNT, IFNULL(COUNT(USER_ID), 0) AS TOTAL_USERS FROM MY_TABLE AS M LEFT JOIN (SELECT SPEND_DATE, USER_ID, CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT > 0 THEN BOTH WHEN MOBILE_AMOUNT > 0 THEN MOBILE ELSE DESKTOP END AS PLATFORM, MOBILE_AMOUNT + DESKTOP_AMOUNT AS PERSONAL_AMOUNT FROM (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) TMP) FINAL ON M.SPEND_DATE = FINAL.SPEND_DATE AND M.PLATFORM = FINAL.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
269,Y,N,"WITH PLATFORM AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), CTE AS ( SELECT A.SPEND_DATE, CASE WHEN A.PLATFORM = 'desktop' AND B.PLATFORM IS NULL THEN DESKTOP WHEN A.PLATFORM = 'mobile' AND B.PLATFORM IS NULL THEN MOBILE WHEN A.PLATFORM != B.PLATFORM THEN BOTH END AS PLATFORM, A.AMOUNT FROM SPENDING A LEFT JOIN SPENDING B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM != B.PLATFORM ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, CASE WHEN B.PLATFORM = 'both' THEN COUNT(B.PLATFORM) / 2 ELSE COUNT(B.PLATFORM) END AS TOTAL_USERS FROM PLATFORM A LEFT JOIN CTE B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY SPEND_DATE, A.PLATFORM"
270,Y,N,"WITH CTE1 AS ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MOBILE, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP FROM SPENDING GROUP BY USER_ID, SPEND_DATE), CTE2 AS ( SELECT USER_ID, SPEND_DATE, CASE WHEN MOBILE > 0 AND DESKTOP = 0 THEN MOBILE ELSE 0 END AS MOBILE, CASE WHEN MOBILE = 0 AND DESKTOP > 0 THEN DESKTOP ELSE 0 END AS DESKTOP, CASE WHEN MOBILE > 0 AND DESKTOP > 0 THEN MOBILE + DESKTOP ELSE 0 END AS BOTH_ FROM CTE1), CTE3 AS ( SELECT SPEND_DATE, SUM(MOBILE) MOBILE_TOTAL, SUM(CASE WHEN MOBILE > 0 THEN 1 ELSE 0 END) MOBILE_COUNT, SUM(DESKTOP) DESKTOP_TOTAL, SUM(CASE WHEN DESKTOP > 0 THEN 1 ELSE 0 END) DESKTOP_COUNT, SUM(BOTH_) BOTH_TOTAL, SUM(CASE WHEN BOTH_ > 0 THEN 1 ELSE 0 END) BOTH_COUNT FROM CTE2 GROUP BY SPEND_DATE) SELECT SPEND_DATE, 'mobile' AS PLATFORM, MOBILE_TOTAL AS TOTAL_AMOUNT , MOBILE_COUNT AS TOTAL_USERS FROM CTE3 UNION SELECT SPEND_DATE, 'desktop', DESKTOP_TOTAL, DESKTOP_COUNT FROM CTE3 UNION SELECT SPEND_DATE, 'both', BOTH_TOTAL, BOTH_COUNT FROM CTE3"
271,N,N,"WITH GET_DAILY AS ( SELECT USER_ID , SPEND_DATE, CASE WHEN COUNT(*) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS DAILY_TOTAL FROM SPENDING GROUP BY 1,2 ), GET_BY_PLATFORM AS ( SELECT SPEND_DATE,PLATFORM, SUM(DAILY_TOTAL) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM GET_DAILY GROUP BY 1,2 ), GET_TEMPLATE AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING ) SELECT A.*, IFNULL(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(B.TOTAL_USERS,0) AS TOTAL_USERS FROM GET_TEMPLATE A LEFT JOIN GET_BY_PLATFORM B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM"
272,Y,N,"SELECT Y.*, IF(Z.TOTAL_AMOUNT IS NULL, 0, Z.TOTAL_AMOUNT) AS TOTAL_AMOUNT, IF(Z.TOTAL_USERS IS NULL, 0, Z.TOTAL_USERS) AS TOTAL_USERS FROM (SELECT DISTINCT S.SPEND_DATE, X.PLATFORM FROM SPENDING AS S CROSS JOIN (SELECT MOBILE AS PLATFORM UNION ALL SELECT DESKTOP AS PLATFORM UNION ALL SELECT BOTH AS PLATFORM ) AS X) AS Y LEFT JOIN (SELECT A.SPEND_DATE, 'mobile' AS PLATFORM, SUM(A.AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM SPENDING AS A INNER JOIN (SELECT SPEND_DATE, USER_ID FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(*) = 1) AS B ON A.SPEND_DATE = B.SPEND_DATE AND A.USER_ID = B.USER_ID WHERE PLATFORM = 'mobile' GROUP BY SPEND_DATE UNION ALL SELECT A.SPEND_DATE, 'desktop' AS PLATFORM, SUM(A.AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM SPENDING AS A INNER JOIN (SELECT SPEND_DATE, USER_ID FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(*) = 1) AS B ON A.SPEND_DATE = B.SPEND_DATE AND A.USER_ID = B.USER_ID WHERE PLATFORM = 'desktop' GROUP BY SPEND_DATE UNION ALL SELECT A.SPEND_DATE, 'both' AS PLATFORM, SUM(A.AMOUNT) AS TOTAL_AMOUNT, COUNT(*) DIV 2 AS TOTAL_USERS FROM SPENDING AS A INNER JOIN (SELECT SPEND_DATE, USER_ID FROM SPENDING GROUP BY SPEND_DATE, USER_ID HAVING COUNT(*) = 2) AS B ON A.SPEND_DATE = B.SPEND_DATE AND A.USER_ID = B.USER_ID GROUP BY SPEND_DATE) AS Z ON Y.SPEND_DATE = Z.SPEND_DATE AND Y.PLATFORM = Z.PLATFORM"
273,Y,Y,"WITH CTE1 AS ( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID), CTE2 AS ( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM CTE1), CTE3 AS ( SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(B.AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(B.USER_ID) AS TOTAL_USERS FROM CTE3 A LEFT JOIN CTE2 B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM GROUP BY A.SPEND_DATE, A.PLATFORM"
274,N,N,"WITH DEMO AS ( SELECT A.SPEND_DATE, A.PLATFORM FROM ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING)A) SELECT B.SPEND_DATE, B.PLATFORM, IFNULL(SUM(A.AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT A.USER_ID),0) AS TOTAL_USERS FROM ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) A RIGHT JOIN DEMO B ON B.SPEND_DATE=A.SPEND_DATE AND B.PLATFORM=A.PLATFORM GROUP BY B.SPEND_DATE, B.PLATFORM"
275,Y,Y,"WITH PLATFORM_ALL AS (SELECT * FROM (SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP UNION SELECT BOTH ) A CROSS JOIN (SELECT DISTINCT SPEND_DATE FROM SPENDING )B ), SPEND_ALL AS (SELECT SPEND_DATE, CASE WHEN MOBILE_AMOUNT>0 AND DESKTOP_AMOUNT>0 THEN BOTH WHEN MOBILE_AMOUNT>0 THEN MOBILE ELSE DESKTOP END AS PLATFORM, SUM(MOBILE_AMOUNT)+SUM(DESKTOP_AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) T GROUP BY SPEND_DATE, PLATFORM) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT,IFNULL(B.TOTAL_USERS,0) AS TOTAL_USERS FROM PLATFORM_ALL A LEFT JOIN SPEND_ALL B ON A.PLATFORM = B.PLATFORM AND A.SPEND_DATE = B.SPEND_DATE"
276,Y,N,"SELECT T2.SPEND_DATE, T2.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) T2 LEFT JOIN (SELECT USER_ID, SPEND_DATE, CASE WHEN DESKTOP_AMT > 0 AND MOBILE_AMT > 0 THEN BOTH WHEN DESKTOP_AMT > 0 THEN DESKTOP ELSE MOBILE END AS PLATFORM, DESKTOP_AMT + MOBILE_AMT AS AMOUNT FROM (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMT, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMT FROM SPENDING GROUP BY USER_ID,SPEND_DATE) T1) T3 ON T2.SPEND_DATE = T3.SPEND_DATE AND T2.PLATFORM = T3.PLATFORM GROUP BY T2.SPEND_DATE, T2.PLATFORM"
277,Y,N,"WITH DATES AS (SELECT DISTINCT SPEND_DATE FROM SPENDING), PLATFORMS AS (SELECT DISTINCT PLATFORM FROM SPENDING UNION SELECT BOTH ), DATE_PLATFROM AS (SELECT * FROM DATES CROSS JOIN PLATFORMS), MOBILE AS (SELECT USER_ID, SPEND_DATE, PLATFORM, CASE WHEN PLATFORM = 'mobile' THEN AMOUNT END AS AMOUNT FROM SPENDING), DESKTOP AS (SELECT USER_ID, SPEND_DATE, PLATFORM, CASE WHEN PLATFORM = 'desktop' THEN AMOUNT END AS AMOUNT FROM SPENDING), BOTH_FLAG AS (SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS AMOUNT,COUNT(DISTINCT PLATFORM) AS PLATFORMS FROM SPENDING GROUP BY 1,2), BOTH_SPEND AS (SELECT USER_ID, SPEND_DATE AS SPEND_DATE_B, 'both' AS PLATFORM, AMOUNT FROM BOTH_FLAG WHERE PLATFORMS >1), JUSTMOBILE AS (SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT FROM MOBILE M WHERE USER_ID NOT IN (SELECT USER_ID FROM BOTH_SPEND WHERE SPEND_DATE_B = M.SPEND_DATE)), JUSTDESK AS (SELECT USER_ID, SPEND_DATE, PLATFORM, AMOUNT FROM DESKTOP D WHERE USER_ID NOT IN (SELECT USER_ID FROM BOTH_SPEND WHERE SPEND_DATE_B = D.SPEND_DATE)), FINAL AS (SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT * FROM JUSTMOBILE UNION SELECT DISTINCT * FROM JUSTDESK UNION SELECT * FROM BOTH_SPEND) AS TEMP GROUP BY 1,2) SELECT DP.SPEND_DATE, DP.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS, 0) AS TOTAL_USERS FROM DATE_PLATFROM DP LEFT JOIN FINAL F ON DP.SPEND_DATE = F.SPEND_DATE AND DP.PLATFORM = F.PLATFORM"
278,Y,Y,"WITH TEMP0 AS( SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM FROM SPENDING ), TEMP1 AS( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MOBILE, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP FROM SPENDING GROUP BY 1,2), TEMP2 AS( SELECT USER_ID, SPEND_DATE, IF(MOBILE>0, IF(DESKTOP>0,'both','mobile'),'desktop') AS PLATFORM, MOBILE+DESKTOP AS TOTAL_AMOUNT FROM TEMP1 ) SELECT T0.SPEND_DATE, T0.PLATFORM,IFNULL(SUM(T2.TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(T2.USER_ID),0) AS TOTAL_USERS FROM TEMP0 T0 LEFT JOIN TEMP2 T2 ON T0.SPEND_DATE=T2.SPEND_DATE AND T0.PLATFORM=T2.PLATFORM GROUP BY 1,2"
279,N,N,"WITH CTE AS ( SELECT DISTINCT(SPEND_DATE) FROM SPENDING ) SELECT C.SPEND_DATE,COALESCE(MIN(T1.PLATFORM),'mobile') PLATFORM,COALESCE(SUM(T1.AMOUNT),0) TOTAL_AMOUNT,COALESCE(COUNT(T1.TOTAL_USERS),0) TOTAL_USERS FROM CTE C LEFT JOIN ( SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AMOUNT,USER_ID TOTAL_USERS FROM SPENDING GROUP BY SPEND_DATE,USER_ID HAVING COUNT(DISTINCT(PLATFORM)) = 1 AND PLATFORM = 'mobile') T1 ON C.SPEND_DATE = T1.SPEND_DATE GROUP BY C.SPEND_DATE UNION ALL SELECT C.SPEND_DATE,COALESCE(MIN(T2.PLATFORM),'desktop') PLATFORM,COALESCE(SUM(T2.AMOUNT),0) TOTAL_AMOUNT,COALESCE(COUNT(T2.TOTAL_USERS),0) TOTAL_USERS FROM CTE C LEFT JOIN ( SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AMOUNT ,USER_ID TOTAL_USERS FROM SPENDING GROUP BY SPEND_DATE,USER_ID HAVING COUNT(DISTINCT(PLATFORM)) = 1 AND PLATFORM = 'desktop') T2 ON C.SPEND_DATE = T2.SPEND_DATE GROUP BY C.SPEND_DATE UNION ALL SELECT C.SPEND_DATE,COALESCE(MIN(T3.PLATFORM),'both') PLATFORM,COALESCE(SUM(T3.AMOUNT),0) TOTAL_AMOUNT,COALESCE(COUNT(T3.TOTAL_USERS),0) TOTAL_USERS FROM CTE C LEFT JOIN ( SELECT SPEND_DATE,'both' AS PLATFORM,SUM(AMOUNT) AMOUNT ,USER_ID TOTAL_USERS FROM SPENDING GROUP BY SPEND_DATE,USER_ID HAVING COUNT(DISTINCT(PLATFORM)) >1) T3 ON C.SPEND_DATE = T3.SPEND_DATE GROUP BY C.SPEND_DATE"
280,Y,N,"WITH NON_COMP AS (SELECT A.SPEND_DATE, B.PLATFORM, SUM(A.AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM SPENDING A LEFT JOIN (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) > 1 THEN BOTH ELSE MAX(PLATFORM) END AS PLATFORM FROM SPENDING GROUP BY 1,2) B ON A.SPEND_DATE = B.SPEND_DATE AND A.USER_ID = B.USER_ID GROUP BY 1,2) SELECT A.SPEND_DATE AS SPEND_DATE, A.PLATFORM AS PLATFORM, CASE WHEN B.TOTAL_AMOUNT THEN B.TOTAL_AMOUNT ELSE 0 END AS TOTAL_AMOUNT, CASE WHEN B.TOTAL_USERS THEN B.TOTAL_USERS ELSE 0 END AS TOTAL_USERS FROM (SELECT * FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) A CROSS JOIN (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) B) A LEFT JOIN NON_COMP B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM ORDER BY 2,1"
281,Y,N,"WITH CTE AS (SELECT USER_ID, SPEND_DATE, SUM(IF(PLATFORM='mobile',AMOUNT,0)) AS MOBILE, SUM(IF(PLATFORM='desktop',AMOUNT,0)) AS DESKTOP FROM SPENDING GROUP BY USER_ID, SPEND_DATE) SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(IF(MOBILE=0 AND DESKTOP>0,DESKTOP,0)) AS TOTAL_AMOUNT, SUM(IF(MOBILE=0 AND DESKTOP>0,1,0)) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(IF(MOBILE>0 AND DESKTOP=0,MOBILE,0)) AS TOTAL_AMOUNT, SUM(IF(MOBILE>0 AND DESKTOP=0,1,0)) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(IF(MOBILE>0 AND DESKTOP>0,DESKTOP+MOBILE,0)) AS TOTAL_AMOUNT, SUM(IF(MOBILE>0 AND DESKTOP>0,1,0)) AS TOTAL_USERS FROM CTE GROUP BY SPEND_DATE"
282,Y,N,"WITH CTE AS (SELECT SPEND_DATE, CASE WHEN COUNT(PLATFORM) OVER(PARTITION BY USER_ID, SPEND_DATE)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM , AMOUNT, USER_ID FROM SPENDING), PLATFORM_TABLE AS (SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(C.AMOUNT), 0) AS TOTAL_AMOUNT, IFNULL(COUNT(DISTINCT USER_ID), 0) AS TOTAL_USERS FROM PLATFORM_TABLE P LEFT JOIN CTE C ON P.SPEND_DATE = C.SPEND_DATE AND P.PLATFORM = C.PLATFORM GROUP BY P.SPEND_DATE, P.PLATFORM"
283,N,N,"WITH CLEAN_DATA AS (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) > 1 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNTS FROM SPENDING GROUP BY 1,2), PLATFORM AS (SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE AS SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING) SELECT PLATFORM.*, IFNULL(SUM(TOTAL_AMOUNTS),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM PLATFORM LEFT JOIN CLEAN_DATA ON PLATFORM.SPEND_DATE = CLEAN_DATA.SPEND_DATE AND PLATFORM.PLATFORM = CLEAN_DATA.PLATFORM GROUP BY 1,2"
284,Y,N,"WITH DERIVED AS (SELECT SPEND_DATE, CASE WHEN PLATFORM_COUNT = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM_TMP, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM (SELECT *, COUNT(*) OVER(PARTITION BY USER_ID, SPEND_DATE) AS PLATFORM_COUNT FROM SPENDING) AS PC GROUP BY SPEND_DATE, PLATFORM_TMP), TEMP AS (SELECT SPEND_DATE, PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) AS DATES, (SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM) AS PLATFORM_VALUES) SELECT T.SPEND_DATE, T.PLATFORM, COALESCE(D.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(D.TOTAL_USERS, 0) AS TOTAL_USERS FROM TEMP T LEFT JOIN DERIVED D ON T.SPEND_DATE = D.SPEND_DATE AND T.PLATFORM = D.PLATFORM_TMP"
285,Y,N,"WITH PLATFORM_ALL AS (SELECT * FROM (SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP UNION SELECT BOTH ) A CROSS JOIN (SELECT DISTINCT SPEND_DATE FROM SPENDING ) B ), SPEND_ALL AS (SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(*) AS TOTAL_USERS FROM SPENDING WHERE (SPEND_DATE,USER_ID) IN (SELECT SPEND_DATE,USER_ID FROM SPENDING GROUP BY SPEND_DATE,USER_ID HAVING COUNT(*)=1) GROUP BY SPEND_DATE,PLATFORM UNION SELECT SPEND_DATE,'both' AS PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM SPENDING WHERE (SPEND_DATE,USER_ID) IN (SELECT SPEND_DATE,USER_ID FROM SPENDING GROUP BY SPEND_DATE,USER_ID HAVING COUNT(*)=2) GROUP BY SPEND_DATE) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT,IFNULL(B.TOTAL_USERS,0) AS TOTAL_USERS FROM PLATFORM_ALL A LEFT JOIN SPEND_ALL B ON A.PLATFORM = B.PLATFORM AND A.SPEND_DATE = B.SPEND_DATE"
286,Y,Y,"WITH CTE AS( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY 1, 2), CTE1 AS( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, MOBILE_AMOUNT + DESKTOP_AMOUNT AS TOTAL_AMOUNT FROM CTE), CTE2 AS( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) SELECT C2.SPEND_DATE, C2.PLATFORM, SUM(IFNULL(C1.TOTAL_AMOUNT, 0)) AS TOTAL_AMOUNT, COUNT(C1.USER_ID) AS TOTAL_USERS FROM CTE2 C2 LEFT JOIN CTE1 C1 ON C1.SPEND_DATE = C2.SPEND_DATE AND C1.PLATFORM = C2.PLATFORM GROUP BY 1, 2"
287,N,N,"WITH P AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), X AS( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS DAILY_TTA FROM SPENDING GROUP BY USER_ID, SPEND_DATE) SELECT P.SPEND_DATE, P.PLATFORM, COALESCE(SUM(DAILY_TTA), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM P LEFT JOIN X ON X.SPEND_DATE=P.SPEND_DATE AND X.PLATFORM=P.PLATFORM GROUP BY SPEND_DATE, P.PLATFORM"
288,Y,N,"WITH T_ALL AS ( SELECT DISTINCT S1.USER_ID, S1.SPEND_DATE, CASE WHEN S1.AMOUNT IS NOT NULL AND S2.AMOUNT IS NOT NULL THEN BOTH WHEN S2.AMOUNT IS NULL AND S1.PLATFORM = 'MOBILE THEN MOBILE ELSE DESKTOP' END AS PLATFORM, S1.AMOUNT + IFNULL(S2.AMOUNT, 0) AS AMOUNT FROM SPENDING S1 LEFT JOIN SPENDING S2 ON S1.USER_ID = S2.USER_ID AND S1.SPEND_DATE = S2.SPEND_DATE AND S1.PLATFORM <> S2.PLATFORM ), T_MAIN AS( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT T_MAIN.SPEND_DATE, T_MAIN.PLATFORM, IFNULL(T_AGG.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(T_AGG.TOTAL_USERS, 0) AS TOTAL_USERS FROM T_MAIN LEFT JOIN ( SELECT SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T_ALL GROUP BY 1, 2 ) T_AGG ON T_MAIN.SPEND_DATE = T_AGG.SPEND_DATE AND T_MAIN.PLATFORM = T_AGG.PLATFORM"
289,Y,N,"WITH CTE1 AS ( SELECT SPEND_DATE,USER_ID ,'both' AS PLATFORM,SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY SPEND_DATE ,USER_ID HAVING COUNT(DISTINCT(PLATFORM)) = 2 UNION ALL SELECT SPEND_DATE,USER_ID ,MAX(PLATFORM) PLATFORM,SUM(AMOUNT) AMOUNT FROM SPENDING GROUP BY SPEND_DATE ,USER_ID HAVING COUNT(DISTINCT(PLATFORM)) = 1 UNION ALL SELECT SPEND_DATE,NULL AS USER_ID ,'both' AS PLATFORM ,0 AS AMOUNT FROM SPENDING UNION ALL SELECT SPEND_DATE,NULL AS USER_ID ,'mobile' AS PLATFORM ,0 AS AMOUNT FROM SPENDING UNION ALL SELECT SPEND_DATE,NULL AS USER_ID ,'desktop' AS PLATFORM ,0 AS AMOUNT FROM SPENDING ) SELECT SPEND_DATE , PLATFORM ,SUM(AMOUNT) TOTAL_AMOUNT , COUNT(USER_ID) TOTAL_USERS FROM CTE1 GROUP BY SPEND_DATE , PLATFORM ORDER BY SPEND_DATE , PLATFORM DESC"
290,Y,Y,"WITH CTE AS( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT , SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY 1,2 ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(T.AMOUNT),0) AS TOTAL_AMOUNT, COUNT(T.USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'both' AS PLATFORM FROM SPENDING) AS A LEFT JOIN (SELECT USER_ID,SPEND_DATE, IF(MOBILE_AMOUNT>0, IF(DESKTOP_AMOUNT >0, 'both', 'mobile'), 'desktop') AS PLATFORM , (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM CTE) T ON A.SPEND_DATE = T.SPEND_DATE AND A.PLATFORM = T.PLATFORM GROUP BY 1,2"
291,N,N,"SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(SUM(B.AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT B.USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE,'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE,'both' PLATFORM FROM SPENDING) A LEFT JOIN (SELECT USER_ID, SPEND_DATE,SUM(AMOUNT) AS AMOUNT, (CASE WHEN COUNT(DISTINCT PLATFORM)>1 THEN BOTH ELSE PLATFORM END) PLATFORM FROM SPENDING GROUP BY 1,2) B ON A.SPEND_DATE=B.SPEND_DATE AND A.PLATFORM=B.PLATFORM GROUP BY 1,2"
292,Y,N,"WITH TMP AS ( SELECT *, COUNT(PLATFORM) OVER (PARTITION BY SPEND_DATE, USER_ID) AS CNT FROM SPENDING) , TMP1 AS ( SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM, USER_ID FROM TMP WHERE CNT = 2 UNION ALL SELECT SPEND_DATE, PLATFORM, USER_ID FROM TMP WHERE CNT = 1) , TMP2 AS ( SELECT A.SPEND_DATE, B.PLATFORM FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) A, (SELECT DISTINCT PLATFORM FROM SPENDING UNION ALL SELECT BOTH AS PLATFORM) B) , TMP3 AS ( SELECT A.SPEND_DATE, B.PLATFORM, SUM(A.AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM SPENDING A JOIN TMP1 B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE GROUP BY 1,2) SELECT A.SPEND_DATE, A.PLATFORM, COALESCE(B.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(B.TOTAL_USERS,0) AS TOTAL_USERS FROM TMP2 A LEFT JOIN TMP3 B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM ORDER BY 1,2"
293,N,N,"WITH PLT AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) , UNIT_LEVEL AS (SELECT USER_ID , SPEND_DATE , CASE WHEN COUNT(DISTINCT PLATFORM) >1 THEN BOTH ELSE PLATFORM END AS PLATFORM , SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT P.SPEND_DATE , P.PLATFORM , COALESCE(SUM(AMOUNT), 0) AS TOTAL_AMOUNT , COALESCE(COUNT(DISTINCT USER_ID), 0) AS TOTAL_USERS FROM PLT AS P LEFT JOIN UNIT_LEVEL AS U ON U.SPEND_DATE=P.SPEND_DATE AND U.PLATFORM=P.PLATFORM GROUP BY P.SPEND_DATE, P.PLATFORM"
294,Y,N,"WITH TEMP_CTE AS (SELECT USER_ID,SPEND_DATE,CASE WHEN LEAD_ROW IS NULL AND LAG_ROW IS NULL THEN PLATFORM ELSE BOTH END AS PLATFORM,AMOUNT FROM (SELECT *,LEAD(PLATFORM) OVER(PARTITION BY SPEND_DATE,USER_ID ORDER BY PLATFORM ASC) AS LEAD_ROW,LAG(PLATFORM) OVER(PARTITION BY SPEND_DATE,USER_ID ORDER BY PLATFORM ASC) AS LAG_ROW FROM SPENDING) X), EMPTY_BOTH AS (SELECT DISTINCT SPEND_DATE,'both' AS PLATFORM,0 AS TOTAL_AMOUNT,0 AS TOTAL_USERS FROM SPENDING WHERE SPEND_DATE NOT IN (SELECT SPEND_DATE FROM TEMP_CTE WHERE PLATFORM = 'both')), EMPTY_MOBILE AS (SELECT DISTINCT SPEND_DATE,'mobile' AS PLATFORM,0 AS TOTAL_AMOUNT,0 AS TOTAL_USERS FROM SPENDING WHERE SPEND_DATE NOT IN (SELECT SPEND_DATE FROM TEMP_CTE WHERE PLATFORM = 'mobile')), EMPTY_DESKTOP AS (SELECT DISTINCT SPEND_DATE,'desktop' AS PLATFORM,0 AS TOTAL_AMOUNT,0 AS TOTAL_USERS FROM SPENDING WHERE SPEND_DATE NOT IN (SELECT SPEND_DATE FROM TEMP_CTE WHERE PLATFORM = 'desktop')) SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM TEMP_CTE Y GROUP BY SPEND_DATE,PLATFORM UNION ALL SELECT * FROM EMPTY_BOTH UNION ALL SELECT * FROM EMPTY_MOBILE UNION ALL SELECT * FROM EMPTY_DESKTOP"
295,Y,N,"WITH BOTH_PLATFORM_ID_DAY AS( SELECT USER_ID, SPEND_DATE FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING COUNT(1) > 1 ), ONLY_MOBILE AS ( SELECT A.SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM SPENDING A LEFT JOIN BOTH_PLATFORM_ID_DAY B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE WHERE B.USER_ID IS NULL AND A.PLATFORM = 'mobile' GROUP BY SPEND_DATE, PLATFORM ), ONLY_DESK AS( SELECT A.SPEND_DATE, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM SPENDING A LEFT JOIN BOTH_PLATFORM_ID_DAY B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE WHERE B.USER_ID IS NULL AND PLATFORM = 'desktop' GROUP BY SPEND_DATE, PLATFORM ), COMBINE AS ( SELECT A.SPEND_DATE, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM SPENDING A LEFT JOIN BOTH_PLATFORM_ID_DAY B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE WHERE B.USER_ID IS NOT NULL GROUP BY SPEND_DATE ) SELECT BASE.SPEND_DATE, 'mobile' AS PLATFORM, COALESCE(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(TOTAL_USERS, 0) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) BASE LEFT JOIN ONLY_MOBILE ON BASE.SPEND_DATE = ONLY_MOBILE.SPEND_DATE UNION SELECT BASE.SPEND_DATE, 'desktop' AS PLATFORM, COALESCE(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(TOTAL_USERS, 0) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) BASE LEFT JOIN ONLY_DESK ON BASE.SPEND_DATE = ONLY_DESK.SPEND_DATE UNION SELECT BASE.SPEND_DATE, 'both' AS PLATFORM, COALESCE(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(TOTAL_USERS, 0) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) BASE LEFT JOIN COMBINE ON BASE.SPEND_DATE = COMBINE.SPEND_DATE"
296,N,N,"SELECT DISTINCT S.SPEND_DATE, L.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM SPENDING AS S CROSS JOIN (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE UNION SELECT BOTH ) L LEFT JOIN (SELECT SPEND_DATE, PLAT AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM (SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(PLATFORM) = 2 THEN BOTH WHEN COUNT(PLATFORM) = 1 AND PLATFORM = 'MOBILE THEN MOBILE ELSE DESKTOP' END AS PLAT, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) K GROUP BY SPEND_DATE, PLAT) M ON S.SPEND_DATE = M.SPEND_DATE AND L.PLATFORM = M.PLATFORM"
297,Y,N,"WITH ALL_COMBINATIONS AS (SELECT * FROM (SELECT SPEND_DATE FROM SPENDING GROUP BY SPEND_DATE) A CROSS JOIN ( SELECT BOTH AS PLATFORM UNION SELECT PLATFORM FROM SPENDING GROUP BY PLATFORM)B), USER_TRANS AS (SELECT USER_ID, SPEND_DATE, COUNT(PLATFORM) AS CNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE), USER_SEG AS ( SELECT A.SPEND_DATE, CASE WHEN B.CNT = 1 THEN PLATFORM ELSE BOTH END AS PLATFORM, SUM(A.AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT A.USER_ID) AS TOTAL_USERS FROM SPENDING A LEFT JOIN USER_TRANS B ON A.USER_ID = B.USER_ID AND A.SPEND_DATE = B.SPEND_DATE GROUP BY A.SPEND_DATE, CASE WHEN B.CNT = 1 THEN PLATFORM ELSE BOTH END ) SELECT AC.SPEND_DATE, AC.PLATFORM, COALESCE(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, COALESCE(TOTAL_USERS,0) AS TOTAL_USERS FROM ALL_COMBINATIONS AC LEFT JOIN USER_SEG A ON (AC.SPEND_DATE = A.SPEND_DATE AND AC.PLATFORM = A.PLATFORM)"
298,Y,N,"WITH NEW AS ( SELECT S.*, PLATFORM_NUM FROM SPENDING S LEFT JOIN (SELECT SPEND_DATE, USER_ID, COUNT(DISTINCT PLATFORM) PLATFORM_NUM FROM SPENDING GROUP BY 1,2) T ON S.USER_ID = T.USER_ID AND S.SPEND_DATE = T.SPEND_DATE ) SELECT P.*, IFNULL(TOTAL_AMOUNT,0) TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) TOTAL_USERS FROM (SELECT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING) P LEFT JOIN (SELECT SPEND_DATE, 'both' AS PLATFORM , IFNULL(SUM(AMOUNT),0) TOTAL_AMOUNT , COUNT(DISTINCT USER_ID) TOTAL_USERS FROM NEW WHERE PLATFORM_NUM = 2 GROUP BY 1,2 UNION SELECT SPEND_DATE, 'desktop' AS PLATFORM , SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) TOTAL_AMOUNT , COUNT(DISTINCT CASE WHEN PLATFORM = 'desktop' THEN USER_ID END) TOTAL_USERS FROM NEW WHERE PLATFORM_NUM = 1 GROUP BY 1,2 UNION SELECT SPEND_DATE, 'mobile' AS PLATFORM , SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) TOTAL_AMOUNT , COUNT(DISTINCT CASE WHEN PLATFORM = 'mobile' THEN USER_ID END) TOTAL_USERS FROM NEW WHERE PLATFORM_NUM = 1 GROUP BY 1,2) T ON P.SPEND_DATE = T.SPEND_DATE AND P.PLATFORM = T.PLATFORM"
299,Y,N,"WITH CTE AS ( SELECT *, CASE WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) = 2 THEN BOTH WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) = 1 AND PLATFORM = 'DESKTOP THEN DESKTOP ELSE MOBILE' END AS CAL_PLATFORM FROM SPENDING ), FINAL_SPENDING AS ( SELECT SPEND_DATE, CAL_PLATFORM AS PLATFORM, COUNT(DISTINCT USER_ID) AS TOTAL_USERS, SUM(AMOUNT) AS TOTAL_AMOUNT FROM CTE GROUP BY 1,2 ), PLATFORMS AS ( SELECT MOBILE AS PLATFORM UNION ALL SELECT DESKTOP AS PLATFORM UNION ALL SELECT BOTH AS PLATFORM ), SPEND_DATE AS ( SELECT DISTINCT SPEND_DATE FROM SPENDING ), SPEND_PLATFORM AS ( SELECT SPEND_DATE, PLATFORM FROM SPEND_DATE, PLATFORMS ) SELECT S.SPEND_DATE, S.PLATFORM, IFNULL(TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM SPEND_PLATFORM S LEFT OUTER JOIN FINAL_SPENDING C ON S.SPEND_DATE = C.SPEND_DATE AND S.PLATFORM = C.PLATFORM GROUP BY 1,2"
300,Y,N,"WITH CTE1 AS (SELECT USER_ID,SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) DESKTOP_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE), CTE2 AS (SELECT USER_ID, SPEND_DATE, CASE WHEN MOBILE_AMOUNT > 0 AND DESKTOP_AMOUNT > 0 THEN BOTH WHEN MOBILE_AMOUNT =0 AND DESKTOP_AMOUNT > 0 THEN DESKTOP ELSE MOBILE END PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AMOUNT FROM CTE1), CTE3 AS ( SELECT DISTINCT SPEND_DATE, 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' PLATFORM FROM SPENDING) SELECT C.SPEND_DATE, C.PLATFORM, IFNULL(SUM(S.AMOUNT),0) TOTAL_AMOUNT, COUNT(S.USER_ID) TOTAL_USERS FROM CTE3 C LEFT JOIN CTE2 S ON C.SPEND_DATE = S.SPEND_DATE AND C.PLATFORM = S.PLATFORM GROUP BY C.SPEND_DATE,C.PLATFORM"
301,Y,N,"WITH SPEND_BY_USER AS( SELECT SPEND_DATE, USER_ID, SUM( CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END ) AS DESKTOP_SPEND, SUM( CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END ) AS MOBILE_SPEND FROM SPENDING GROUP BY SPEND_DATE, USER_ID ), SPEND_ALLOCATION AS( SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN DESKTOP_SPEND > 0 AND MOBILE_SPEND = 0 THEN DESKTOP_SPEND ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN DESKTOP_SPEND > 0 AND MOBILE_SPEND = 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM SPEND_BY_USER GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN DESKTOP_SPEND = 0 AND MOBILE_SPEND > 0 THEN MOBILE_SPEND ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN DESKTOP_SPEND = 0 AND MOBILE_SPEND > 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM SPEND_BY_USER GROUP BY SPEND_DATE UNION ALL SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN DESKTOP_SPEND > 0 AND MOBILE_SPEND > 0 THEN DESKTOP_SPEND + MOBILE_SPEND ELSE 0 END) TOTAL_AMOUNT, SUM(CASE WHEN DESKTOP_SPEND > 0 AND MOBILE_SPEND > 0 THEN 1 ELSE 0 END) TOTAL_USERS FROM SPEND_BY_USER GROUP BY SPEND_DATE ) SELECT SPEND_DATE, PLATFORM, TOTAL_AMOUNT, TOTAL_USERS FROM SPEND_ALLOCATION"
302,Y,N,"WITH USERLEVEL AS ( SELECT USER_ID,SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM) >1 THEN BOTH ELSE MAX(PLATFORM) END AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2 ) SELECT A.SPEND_DATE, B.PLATFORM, IFNULL(SUM(C.TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT C.USER_ID) AS TOTAL_USERS FROM (SELECT DISTINCT SPEND_DATE FROM SPENDING) A INNER JOIN ( SELECT DISTINCT PLATFORM FROM SPENDING UNION ALL SELECT BOTH PLATFORM ) B LEFT JOIN USERLEVEL C ON A.SPEND_DATE = C.SPEND_DATE AND B.PLATFORM = C.PLATFORM GROUP BY 1,2"
303,N,N,"WITH DATE_PLATFORM AS( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), DATE_USER AS( SELECT SPEND_DATE, USER_ID, SUM(AMOUNT) AS AMOUNT, CASE WHEN COUNT(PLATFORM) = 2 THEN BOTH ELSE PLATFORM END PLATFORM FROM SPENDING GROUP BY SPEND_DATE, USER_ID ) SELECT DP.SPEND_DATE, DP.PLATFORM, IFNULL(SUM(AMOUNT),0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM DATE_PLATFORM AS DP LEFT JOIN DATE_USER AS DU ON DP.SPEND_DATE = DU.SPEND_DATE AND DP.PLATFORM = DU.PLATFORM GROUP BY DP.SPEND_DATE, DP.PLATFORM ORDER BY 1,2"
304,N,N,"WITH T0 AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) , T1 AS ( SELECT USER_ID, SPEND_DATE, SUM(AMOUNT) AS TOTAL1_AMOUNT, CASE WHEN COUNT(DISTINCT PLATFORM) = 2 THEN BOTH ELSE PLATFORM END AS PLATFORM FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) SELECT A.SPEND_DATE, A.PLATFORM, IFNULL(TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) AS TOTAL_USERS FROM T0 A LEFT JOIN ( SELECT DISTINCT SPEND_DATE, PLATFORM, SUM(TOTAL1_AMOUNT) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM T1 GROUP BY 1, 2 ) B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM ORDER BY 1, 2"
305,Y,N,"WITH T AS (SELECT MOBILE PLATFORM UNION SELECT DESKTOP PLATFORM UNION SELECT BOTH PLATFORM), T1 AS (SELECT DISTINCT T.PLATFORM, SPEND_DATE FROM T, SPENDING), T2 AS (SELECT SPEND_DATE, USER_ID, IF(COUNT(PLATFORM) = 1, MIN(PLATFORM), 'both') PLATFORM, SUM(AMOUNT) TOTAL_AMOUNT FROM SPENDING GROUP BY 1,2) SELECT T1.SPEND_DATE, T1.PLATFORM, IFNULL(TOTAL_AMOUNT,0) TOTAL_AMOUNT, IFNULL(TOTAL_USERS,0) TOTAL_USERS FROM (SELECT SPEND_DATE, PLATFORM, SUM(TOTAL_AMOUNT) TOTAL_AMOUNT , COUNT(1) TOTAL_USERS FROM T2 GROUP BY 1, 2) AS A RIGHT JOIN T1 ON A.SPEND_DATE = T1.SPEND_DATE AND A.PLATFORM = T1.PLATFORM"
306,Y,N,"SELECT A.SPEND_DATE, A.TYPE AS PLATFORM, IFNULL(SUM(T.SUM_AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(T.USER_ID) AS TOTAL_USERS FROM ((SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'desktop' AS TYPE FROM SPENDING) UNION (SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'mobile' AS TYPE FROM SPENDING) UNION (SELECT DISTINCT(SPEND_DATE) AS SPEND_DATE, 'both' AS TYPE FROM SPENDING)) A LEFT JOIN (SELECT USER_ID, SPEND_DATE, (CASE WHEN SUM(PLATFORM = 'desktop') = 0 THEN MOBILE WHEN SUM(PLATFORM = 'mobile') = 0 THEN DESKTOP ELSE BOTH END) AS TYPE, SUM(AMOUNT) AS SUM_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID) T ON A.SPEND_DATE = T.SPEND_DATE AND A.TYPE = T.TYPE GROUP BY A.SPEND_DATE, A.TYPE"
307,N,N,"WITH BOTH_PLAT_USERS AS ( SELECT USER_ID, SPEND_DATE, COUNT(DISTINCT PLATFORM) AS DISTINCT_PLATFORM, 'both' AS PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING DISTINCT_PLATFORM >= 2), SINGLE_PLAT_USER AS ( SELECT USER_ID, SPEND_DATE, COUNT(DISTINCT PLATFORM) AS DISTINCT_PLATFORM, PLATFORM, SUM(AMOUNT) AS TOTAL_AMOUNT FROM SPENDING GROUP BY USER_ID, SPEND_DATE HAVING DISTINCT_PLATFORM = 1 ), UNIVERSE AS ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT U.SPEND_DATE, U.PLATFORM, COALESCE(SUM(B.TOTAL_AMOUNT), SUM(S.TOTAL_AMOUNT), 0) AS TOTAL_AMOUNT, CASE WHEN B.PLATFORM IS NULL THEN COUNT(S.USER_ID) WHEN S.PLATFORM IS NULL THEN COUNT(B.USER_ID) ELSE 0 END AS TOTAL_USERS FROM UNIVERSE U LEFT JOIN BOTH_PLAT_USERS B ON B.SPEND_DATE = U.SPEND_DATE AND B.PLATFORM = U.PLATFORM LEFT JOIN SINGLE_PLAT_USER S ON S.SPEND_DATE = U.SPEND_DATE AND S.PLATFORM = U.PLATFORM GROUP BY U.SPEND_DATE, U.PLATFORM, S.PLATFORM, B.PLATFORM"
308,Y,Y,"SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(AMOUNT), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM ( SELECT DISTINCT(SPEND_DATE), 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' AS PLATFORM FROM SPENDING ) P LEFT JOIN (SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AS AMOUNT FROM (SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE , USER_ID) O) T ON P.SPEND_DATE = T.SPEND_DATE AND P.PLATFORM = T.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
309,Y,N,"WITH T(SPEND_DATE,PLATFORM,TOTAL_AMOUNT,USER_ID) AS ( SELECT DISTINCT A.SPEND_DATE,CASE WHEN B.USER_ID IS NOT NULL THEN BOTH ELSE A.PLATFORM END ,A.AMOUNT+COALESCE(B.AMOUNT,0),A.USER_ID FROM SPENDING A LEFT JOIN SPENDING B ON A.SPEND_DATE=B.SPEND_DATE AND A.USER_ID=B.USER_ID AND A.PLATFORM!=B.PLATFORM ), T1(PLATFORM) AS ( SELECT MOBILE UNION ALL SELECT DESKTOP UNION ALL SELECT BOTH ), T2(PLATFORM,SPEND_DATE) AS ( SELECT DISTINCT T1.PLATFORM, SPEND_DATE FROM T1,SPENDING ) SELECT T2.SPEND_DATE ,T2.PLATFORM ,COALESCE(SUM(TOTAL_AMOUNT),0) TOTAL_AMOUNT ,COUNT(DISTINCT USER_ID) TOTAL_USERS FROM T2 LEFT JOIN T ON T2.PLATFORM=T.PLATFORM AND T2.SPEND_DATE=T.SPEND_DATE GROUP BY T2.SPEND_DATE,T2.PLATFORM"
310,Y,N,"WITH TMP_TBL AS (SELECT SPEND_DATE, USER_ID, SUM(IF(PLATFORM='mobile', AMOUNT, 0)) AS MOBILE_AMT, SUM(IF(PLATFORM='desktop', AMOUNT, 0)) AS DESKTOP_AMT FROM SPENDING GROUP BY SPEND_DATE, USER_ID), LABELS AS (SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM ), DIST_DT AS (SELECT DISTINCT SPEND_DATE AS SPEND_DATE FROM SPENDING ), RESULT_DUMMY AS (SELECT B.SPEND_DATE AS SPEND_DATE, A.PLATFORM AS PLATFORM FROM LABELS AS A, DIST_DT AS B ) SELECT B.SPEND_DATE, B.PLATFORM, COALESCE(A.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, COALESCE(A.TOTAL_USERS, 0) AS TOTAL_USERS FROM (SELECT SPEND_DATE, CASE WHEN MOBILE_AMT <> 0 AND DESKTOP_AMT = 0 THEN MOBILE WHEN MOBILE_AMT = 0 AND DESKTOP_AMT <> 0 THEN DESKTOP ELSE BOTH END AS PLATFORM, SUM(MOBILE_AMT+DESKTOP_AMT) AS TOTAL_AMOUNT, COUNT(1) AS TOTAL_USERS FROM TMP_TBL GROUP BY SPEND_DATE, CASE WHEN MOBILE_AMT <> 0 AND DESKTOP_AMT = 0 THEN MOBILE WHEN MOBILE_AMT = 0 AND DESKTOP_AMT <> 0 THEN DESKTOP ELSE BOTH END) AS A RIGHT JOIN RESULT_DUMMY AS B ON A.SPEND_DATE = B.SPEND_DATE AND A.PLATFORM = B.PLATFORM"
311,Y,N,"WITH CTE1 AS ( SELECT *, CASE WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) =2 THEN BOTH WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) =1 AND PLATFORM = 'MOBILE THEN MOBILE' WHEN COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) =1 AND PLATFORM = 'DESKTOP THEN DESKTOP' END AS LABEL FROM SPENDING ), CTE2 AS ( SELECT SPEND_DATE, LABEL, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE1 GROUP BY SPEND_DATE, LABEL ), CTE3 AS ( SELECT DISTINCT SPEND_DATE AS SPEND_DATE FROM SPENDING ), CTE4 AS ( SELECT MOBILE AS PLATFORM UNION SELECT DESKTOP AS PLATFORM UNION SELECT BOTH AS PLATFORM ), CTE5 AS ( SELECT SPEND_DATE, PLATFORM FROM CTE3, CTE4 ) SELECT CTE5.SPEND_DATE, CTE5.PLATFORM, IFNULL(CTE2.TOTAL_AMOUNT, 0) AS TOTAL_AMOUNT, IFNULL(CTE2.TOTAL_USERS, 0) AS TOTAL_USERS FROM CTE5 LEFT JOIN CTE2 ON CTE5.SPEND_DATE = CTE2.SPEND_DATE AND CTE5.PLATFORM = CTE2.LABEL"
312,Y,N,"WITH TEMP AS (SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM='mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMT, SUM(CASE WHEN PLATFORM='desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMT FROM SPENDING GROUP BY USER_ID, SPEND_DATE) (SELECT SPEND_DATE, 'mobile' AS PLATFORM, SUM(CASE WHEN MOBILE_AMT > 0 AND DESKTOP_AMT = 0 THEN MOBILE_AMT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(CASE WHEN MOBILE_AMT > 0 AND DESKTOP_AMT = 0 THEN 1 END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE) UNION ALL (SELECT SPEND_DATE, 'desktop' AS PLATFORM, SUM(CASE WHEN MOBILE_AMT = 0 AND DESKTOP_AMT > 0 THEN DESKTOP_AMT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(CASE WHEN MOBILE_AMT = 0 AND DESKTOP_AMT > 0 THEN 1 END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE) UNION ALL (SELECT SPEND_DATE, 'both' AS PLATFORM, SUM(CASE WHEN MOBILE_AMT > 0 AND DESKTOP_AMT > 0 THEN MOBILE_AMT+DESKTOP_AMT ELSE 0 END) AS TOTAL_AMOUNT, COUNT(CASE WHEN MOBILE_AMT > 0 AND DESKTOP_AMT > 0 THEN 1 END) AS TOTAL_USERS FROM TEMP GROUP BY SPEND_DATE)"
313,Y,N,"WITH CTE1 AS ( SELECT DISTINCT SPEND_DATE AS SPEND_DATE FROM SPENDING), CTE2 AS ( SELECT DESKTOP AS PLATFORM UNION SELECT MOBILE AS PLATFORM UNION SELECT BOTH AS PLATFORM ), CTE3 AS (SELECT SPEND_DATE, PLATFORM FROM CTE1, CTE2), CTE4 AS (SELECT *, IF(COUNT(PLATFORM) OVER (PARTITION BY USER_ID, SPEND_DATE) = 2, 'both',PLATFORM) AS ILABEL FROM SPENDING), CTE5 AS ( SELECT SPEND_DATE, ILABEL, SUM(AMOUNT) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM CTE4 GROUP BY SPEND_DATE,ILABEL) SELECT CTE3.SPEND_DATE, CTE3.PLATFORM, IFNULL(CTE5.TOTAL_AMOUNT,0) AS TOTAL_AMOUNT, IFNULL(CTE5.TOTAL_USERS,0) AS TOTAL_USERS FROM CTE3 LEFT JOIN CTE5 ON CTE3.SPEND_DATE = CTE5.SPEND_DATE AND CTE3.PLATFORM = CTE5.ILABEL"
314,N,N,"WITH P AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) SELECT P.SPEND_DATE, P.PLATFORM, COALESCE(SUM(DAILY_TTA), 0) AS TOTAL_AMOUNT, COUNT(USER_ID) AS TOTAL_USERS FROM P LEFT JOIN ( SELECT USER_ID, SPEND_DATE, CASE WHEN COUNT(DISTINCT PLATFORM)=2 THEN BOTH ELSE PLATFORM END AS PLATFORM, SUM(AMOUNT) AS DAILY_TTA FROM SPENDING GROUP BY USER_ID, SPEND_DATE ) X ON X.SPEND_DATE=P.SPEND_DATE AND X.PLATFORM=P.PLATFORM GROUP BY SPEND_DATE, P.PLATFORM"
315,Y,Y,"SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(T.AMOUNT),0) AS TOTAL_AMOUNT, IFNULL(COUNT(T.USER_ID),0) AS TOTAL_USERS FROM ( SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ) P LEFT JOIN ( SELECT SPEND_DATE, USER_ID, IF(MOBILE_AMOUNT>0 , IF(DESKTOP_AMOUNT>0, 'both', 'mobile'), 'desktop') PLATFORM, (MOBILE_AMOUNT + DESKTOP_AMOUNT) AMOUNT FROM ( SELECT USER_ID, SPEND_DATE, SUM(CASE WHEN PLATFORM = 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE WHEN PLATFORM = 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE,USER_ID ) O )T ON P.PLATFORM = T.PLATFORM AND P.SPEND_DATE = T.SPEND_DATE GROUP BY P.SPEND_DATE, P.PLATFORM"
316,Y,Y,"WITH T AS (SELECT SPEND_DATE, USER_ID, SUM(CASE PLATFORM WHEN 'mobile' THEN AMOUNT ELSE 0 END) AS MOBILE_AMOUNT, SUM(CASE PLATFORM WHEN 'desktop' THEN AMOUNT ELSE 0 END) AS DESKTOP_AMOUNT FROM SPENDING GROUP BY SPEND_DATE, USER_ID), T1 AS (SELECT USER_ID, SPEND_DATE, IF(MOBILE_AMOUNT > 0, IF(DESKTOP_AMOUNT > 0, 'both', 'mobile'), 'desktop') AS PLATFORM, IFNULL(MOBILE_AMOUNT+DESKTOP_AMOUNT,0) AS TOTAL_AMOUNT FROM T ), T2 AS (SELECT DISTINCT(SPEND_DATE), 'desktop' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'mobile' PLATFORM FROM SPENDING UNION SELECT DISTINCT(SPEND_DATE), 'both' PLATFORM FROM SPENDING) SELECT T2.SPEND_DATE, T2.PLATFORM, IFNULL(SUM(TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM T2 LEFT JOIN T1 ON T1.SPEND_DATE=T2.SPEND_DATE AND T1.PLATFORM=T2.PLATFORM GROUP BY SPEND_DATE, PLATFORM"
317,Y,N,"WITH SPENT AS ( SELECT SPEND_DATE, USER_ID, SUM(CASE WHEN PLATFORM IN ('mobile') THEN AMOUNT ELSE 0 END) AS MOBILE_SPENT, SUM(CASE WHEN PLATFORM IN ('desktop') THEN AMOUNT ELSE 0 END) AS DESKTOP_SPENT FROM SPENDING GROUP BY 1,2 ), PLATFORMS AS ( SELECT DISTINCT SPEND_DATE, 'mobile' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'desktop' AS PLATFORM FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE, 'both' AS PLATFORM FROM SPENDING ), SUMMARY_SPENT AS ( SELECT SPEND_DATE, USER_ID, CASE WHEN MOBILE_SPENT > 0 AND DESKTOP_SPENT = 0 THEN MOBILE WHEN MOBILE_SPENT = 0 AND DESKTOP_SPENT > 0 THEN DESKTOP WHEN MOBILE_SPENT > 0 AND DESKTOP_SPENT > 0 THEN BOTH END AS PLATFORM, (MOBILE_SPENT + DESKTOP_SPENT) AS TOTAL_AMOUNT FROM SPENT ) SELECT P.SPEND_DATE, P.PLATFORM, IFNULL(SUM(S.TOTAL_AMOUNT),0) AS TOTAL_AMOUNT, COUNT(S.USER_ID) AS TOTAL_USERS FROM PLATFORMS AS P LEFT JOIN SUMMARY_SPENT AS S ON P.SPEND_DATE = S.SPEND_DATE AND P.PLATFORM = S.PLATFORM GROUP BY 1,2 ORDER BY 1,2"
318,Y,N,"WITH P AS ( SELECT SPEND_DATE,USER_ID,MAX(PLATFORM) AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2 HAVING COUNT(DISTINCT PLATFORM) = 1 UNION ALL SELECT SPEND_DATE,USER_ID,'both' AS PLATFORM, SUM(AMOUNT) AS AMOUNT FROM SPENDING GROUP BY 1,2 HAVING COUNT(DISTINCT PLATFORM) = 2 UNION ALL SELECT DISTINCT SPEND_DATE,NULL AS USER_ID,'both' AS PLATFORM, 0 AS AMOUNT FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,NULL USER_ID,'mobile' AS PLATFORM, 0 AS AMOUNT FROM SPENDING UNION ALL SELECT DISTINCT SPEND_DATE,NULL USER_ID,'desktop' AS PLATFORM, 0 AS AMOUNT FROM SPENDING ) SELECT SPEND_DATE,PLATFORM,SUM(AMOUNT) AS TOTAL_AMOUNT,COUNT(DISTINCT USER_ID) AS TOTAL_USERS FROM P GROUP BY 1,2"
